===== C:\Users\james\travel-planner\backend\email_service.py =====
import smtplib
import os
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
SMTP_EMAIL = os.getenv("SMTP_EMAIL", "hello@sherpatravel.uk")
SMTP_PASSWORD = os.getenv("SMTP_APP_PASSWORD", "")
FROM_NAME = "Sherpa Travel"


def send_email(to_email: str, subject: str, html_body: str):
    """Send an HTML email via Google Workspace SMTP."""
    if not SMTP_PASSWORD:
        print("WARNING: SMTP_APP_PASSWORD not set, skipping email")
        return False

    msg = MIMEMultipart("alternative")
    msg["From"] = f"{FROM_NAME} <{SMTP_EMAIL}>"
    msg["To"] = to_email
    msg["Subject"] = subject
    msg.attach(MIMEText(html_body, "html"))

    try:
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
            server.starttls()
            server.login(SMTP_EMAIL, SMTP_PASSWORD)
            server.sendmail(SMTP_EMAIL, to_email, msg.as_string())
        print(f"Email sent to {to_email}")
        return True
    except Exception as e:
        print(f"Email error: {e}")
        return False


def send_welcome_email(to_email: str, first_name: str = ""):
    """Send branded welcome email to new users."""
    name = first_name or "there"
    subject = f"Welcome to Sherpa, {name}! ðŸŒ"

    html = f"""
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin:0; padding:0; background-color:#111614; font-family:Arial, Helvetica, sans-serif;">
  <div style="max-width:560px; margin:0 auto; padding:32px 20px;">

    <!-- Header -->
    <div style="text-align:center; padding:24px 0 20px;">
      <h1 style="margin:0; font-size:28px; color:#f0ede8; letter-spacing:1px;">
        Sherpa Travel
      </h1>
      <p style="margin:4px 0 0; font-size:13px; color:#7a7870;">
        AI-powered travel planning
      </p>
    </div>

    <!-- Main card -->
    <div style="background-color:#1a2020; border-radius:12px; padding:32px 28px; border:1px solid rgba(127,182,133,0.2);">

      <h2 style="margin:0 0 16px; font-size:22px; color:#a8c9ad;">
        Hey {name}, welcome aboard! &#x1F44B;
      </h2>

      <p style="margin:0 0 20px; font-size:15px; line-height:1.6; color:#c8c4bc;">
        Thanks for signing up to Sherpa. You now have unlimited access to
        personalised travel itineraries built around your actual flights,
        hotel, and preferences.
      </p>

      <p style="margin:0 0 24px; font-size:15px; line-height:1.6; color:#c8c4bc;">
        Here's how to get the most out of it:
      </p>

      <!-- Steps -->
      <div style="margin-bottom:24px;">
        <div style="display:flex; margin-bottom:16px;">
          <div style="min-width:36px; height:36px; background:rgba(127,182,133,0.15); border-radius:50%; text-align:center; line-height:36px; font-size:15px; margin-right:14px;">
            &#x2728;
          </div>
          <div>
            <p style="margin:0 0 2px; font-size:14px; font-weight:bold; color:#f0ede8;">Get inspired</p>
            <p style="margin:0; font-size:13px; color:#7a7870;">Tell Sherpa your dates, budget, and travel style. It'll suggest three destinations perfect for you.</p>
          </div>
        </div>

        <div style="display:flex; margin-bottom:16px;">
          <div style="min-width:36px; height:36px; background:rgba(127,182,133,0.15); border-radius:50%; text-align:center; line-height:36px; font-size:15px; margin-right:14px;">
            &#x2708;&#xFE0F;
          </div>
          <div>
            <p style="margin:0 0 2px; font-size:14px; font-weight:bold; color:#f0ede8;">Book your travel</p>
            <p style="margin:0; font-size:13px; color:#7a7870;">Find flights, check if you need a car, and pick your hotel. Sherpa links you to the best deals.</p>
          </div>
        </div>

        <div style="display:flex; margin-bottom:16px;">
          <div style="min-width:36px; height:36px; background:rgba(127,182,133,0.15); border-radius:50%; text-align:center; line-height:36px; font-size:15px; margin-right:14px;">
            &#x1F5D3;&#xFE0F;
          </div>
          <div>
            <p style="margin:0 0 2px; font-size:14px; font-weight:bold; color:#f0ede8;">Build your itinerary</p>
            <p style="margin:0; font-size:13px; color:#7a7870;">Get a full day-by-day plan with restaurants, activities, and local tips tailored to you.</p>
          </div>
        </div>

        <div style="display:flex;">
          <div style="min-width:36px; height:36px; background:rgba(127,182,133,0.15); border-radius:50%; text-align:center; line-height:36px; font-size:15px; margin-right:14px;">
            &#x1F4CD;
          </div>
          <div>
            <p style="margin:0 0 2px; font-size:14px; font-weight:bold; color:#f0ede8;">Export your map</p>
            <p style="margin:0; font-size:13px; color:#7a7870;">Download all your spots to Google Maps so everything is on your phone when you arrive.</p>
          </div>
        </div>
      </div>

      <!-- CTA button -->
      <div style="text-align:center; padding:8px 0 4px;">
        <a href="https://sherpatravel.uk"
           style="display:inline-block; background-color:#7fb685; color:#111614; text-decoration:none;
                  font-size:15px; font-weight:bold; padding:14px 36px; border-radius:8px;">
          Start planning your trip &#x2192;
        </a>
      </div>
    </div>

    <!-- Footer -->
    <div style="text-align:center; padding:24px 0 8px;">
      <p style="margin:0 0 6px; font-size:12px; color:#7a7870;">
        Got questions or feedback? Just reply to this email.
      </p>
      <p style="margin:0; font-size:11px; color:#4a4a42;">
        Sherpa Travel &middot; sherpatravel.uk
      </p>
    </div>

  </div>
</body>
</html>
"""

    return send_email(to_email, subject, html)


===== C:\Users\james\travel-planner\backend\main.py =====
"""
Sherpa Travel Planner â€” FastAPI Backend
Replaces the Streamlit app.py logic with proper REST + streaming API endpoints.
"""

from email_service import send_welcome_email
import os
from dotenv import load_dotenv
load_dotenv()
import requests, json, re
from datetime import date, timedelta
from typing import Optional
from contextlib import asynccontextmanager

import anthropic
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse
from pydantic import BaseModel

# â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ANTHROPIC_API_KEY       = os.getenv("ANTHROPIC_API_KEY", "")
SKYSCANNER_AFFILIATE_ID = os.getenv("SKYSCANNER_AFFILIATE_ID", "")
BOOKING_AFFILIATE_ID    = os.getenv("BOOKING_AFFILIATE_ID", "")
GYG_PARTNER_ID          = os.getenv("GYG_PARTNER_ID", "")
RENTALCARS_AFFILIATE_ID = os.getenv("RENTALCARS_AFFILIATE_ID", "")

claude = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)
UNSPLASH_KEY = "2L-hCJytn58q2JavZAt1tSO3FL6amLDpSGpWD8k_KFg"

# â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = FastAPI(title="Sherpa API", version="1.0.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173", "http://localhost:3000", "https://sherpaai.uk"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def skyscanner_url(origin_sky: str, dest_sky: str, depart: str, ret: str, adults: int) -> str:
    """Build a Skyscanner deep-link URL."""
    params = f"?adults={adults}"
    if SKYSCANNER_AFFILIATE_ID:
        params += f"&associateid={SKYSCANNER_AFFILIATE_ID}"
    return (
        f"https://www.skyscanner.net/transport/flights/"
        f"{origin_sky.lower()}/{dest_sky.lower()}/{depart}/{ret}/{params}"
    )

def booking_url(dest: str, checkin: str, checkout: str, adults: int, rooms: int) -> str:
    import urllib.parse
    params = urllib.parse.urlencode({
        "ss": dest, "checkin": checkin, "checkout": checkout,
        "group_adults": adults, "no_rooms": rooms,
        "aid": BOOKING_AFFILIATE_ID or "304142", "lang": "en-gb",
    })
    return f"https://www.booking.com/searchresults.html?{params}"

def claude_json(prompt: str, model: str = "claude-haiku-4-5-20251001", max_tokens: int = 1000) -> dict:
    """Call Claude and parse JSON from the response."""
    resp = claude.messages.create(
        model=model,
        max_tokens=max_tokens,
        messages=[{"role": "user", "content": prompt}]
    )
    text = resp.content[0].text.strip()
    m = re.search(r"\{.*\}", text, re.DOTALL)
    if m:
        return json.loads(m.group())
    raise ValueError(f"No JSON in response: {text[:200]}")

def get_first_weekend(month_name: str):
    month_map = {
        "January":1,"February":2,"March":3,"April":4,"May":5,"June":6,
        "July":7,"August":8,"September":9,"October":10,"November":11,"December":12,
    }
    year  = date.today().year
    month = month_map.get(month_name, 5)
    if date(year, month, 1) < date.today():
        year += 1
    d = date(year, month, 1)
    # Find first Friday
    while d.weekday() != 4:
        d += timedelta(days=1)
    return d.isoformat(), (d + timedelta(days=3)).isoformat()


# â”€â”€ Request models â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class InspireRequest(BaseModel):
    starting_point: str
    budget: str = "Â£Â£ â€” Mid-range"
    group_type: str = "Couple"
    trip_type: list[str] = []
    transport_mode: str = "willing to rent"
    priorities: str = ""
    travel_month: Optional[str] = "May"
    specific_depart: Optional[str] = None
    specific_return: Optional[str] = None
    dest_preference: Optional[str] = ""
    num_adults: int = 2

class ItineraryRequest(BaseModel):
    dest: str
    dest_city: str
    origin_city: str
    starting_point: str
    budget: str
    group_type: str
    trip_type: list[str]
    transport_mode: str
    priorities: str
    specific_depart: Optional[str] = None
    specific_return: Optional[str] = None
    travel_month: str = "May"
    num_adults: int = 2
    selected_hotel: str = ""
    car_hire_confirmed: Optional[str] = None
    arrival_time: str = "11:00"
    departure_time: str = "14:00"
    arrival_airport: str = ""
    transfer_label: str = "30 min"
    user_profile: Optional[dict] = None

class CarHireRequest(BaseModel):
    dest: str
    dest_city: str
    trip_type: list[str]
    origin_sky: str = "LOND"
    dest_sky: str = ""
    depart_date: str = ""
    return_date: str = ""
    num_adults: int = 2

class AccomTipsRequest(BaseModel):
    dest: str
    dest_city: str
    budget: str
    group_type: str
    trip_type: list[str]
    priorities: str = ""
    car_hire: Optional[str] = None

class HotelNoteRequest(BaseModel):
    hotel: str
    dest_city: str
    dest: str
    group_type: str
    car_hire: Optional[str] = None
    priorities: str = ""

class ActivitiesRequest(BaseModel):
    dest_city: str
    itinerary: str
    gyg_partner_id: str = ""

class TweakRequest(BaseModel):
    dest: str
    dest_city: str
    itinerary: str
    feedback: str
    origin_city: str = ""

class MapPinsRequest(BaseModel):
    itinerary: str
    dest_city: str

class ChatRequest(BaseModel):
    message: str
    history: list[dict] = []
    context: str = ""

class LocalGuideRequest(BaseModel):
    lat: float
    lon: float
    dest_city: str = ""

class AirportsRequest(BaseModel):
    dest_city: str

class WelcomeEmailRequest(BaseModel):
    email: str
    first_name: str = ""


# â”€â”€ UK Airport list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
UK_AIRPORTS = [
    {"label": "Aberdeen (ABZ)",                             "value": "aberdeen",     "sky": "ABZ",  "iata": ["ABZ"]},
    {"label": "Belfast â€” all airports (BFS/BHD)",           "value": "belfast",      "sky": "BELF", "iata": ["BFS","BHD"]},
    {"label": "Birmingham (BHX)",                           "value": "birmingham",   "sky": "BHX",  "iata": ["BHX"]},
    {"label": "Bournemouth (BOH)",                          "value": "bournemouth",  "sky": "BOH",  "iata": ["BOH"]},
    {"label": "Bristol (BRS)",                              "value": "bristol",      "sky": "BRS",  "iata": ["BRS"]},
    {"label": "Cardiff (CWL)",                              "value": "cardiff",      "sky": "CWL",  "iata": ["CWL"]},
    {"label": "Doncaster Sheffield (DSA)",                  "value": "doncaster",    "sky": "DSA",  "iata": ["DSA"]},
    {"label": "East Midlands (EMA)",                        "value": "east midlands","sky": "EMA",  "iata": ["EMA"]},
    {"label": "Edinburgh (EDI)",                            "value": "edinburgh",    "sky": "EDI",  "iata": ["EDI"]},
    {"label": "Exeter (EXT)",                               "value": "exeter",       "sky": "EXT",  "iata": ["EXT"]},
    {"label": "Glasgow â€” all airports (GLA/PIK)",           "value": "glasgow",      "sky": "GLAS", "iata": ["GLA","PIK"]},
    {"label": "Glasgow Prestwick (PIK)",                    "value": "prestwick",    "sky": "PIK",  "iata": ["PIK"]},
    {"label": "Guernsey (GCI)",                             "value": "guernsey",     "sky": "GCI",  "iata": ["GCI"]},
    {"label": "Inverness (INV)",                            "value": "inverness",    "sky": "INV",  "iata": ["INV"]},
    {"label": "Isle of Man (IOM)",                          "value": "isle of man",  "sky": "IOM",  "iata": ["IOM"]},
    {"label": "Jersey (JER)",                               "value": "jersey",       "sky": "JER",  "iata": ["JER"]},
    {"label": "Leeds Bradford (LBA)",                       "value": "leeds",        "sky": "LBA",  "iata": ["LBA"]},
    {"label": "Liverpool (LPL)",                            "value": "liverpool",    "sky": "LPL",  "iata": ["LPL"]},
    {"label": "London â€” all airports (LHR/LGW/STN/LTN/LCY)","value": "london",     "sky": "LOND", "iata": ["LHR","LGW","STN","LTN","LCY"]},
    {"label": "London City (LCY)",                          "value": "london city",  "sky": "LCY",  "iata": ["LCY"]},
    {"label": "London Gatwick (LGW)",                       "value": "gatwick",      "sky": "LGW",  "iata": ["LGW"]},
    {"label": "London Heathrow (LHR)",                      "value": "heathrow",     "sky": "LHR",  "iata": ["LHR"]},
    {"label": "London Luton (LTN)",                         "value": "luton",        "sky": "LTN",  "iata": ["LTN"]},
    {"label": "London Southend (SEN)",                      "value": "southend",     "sky": "SEN",  "iata": ["SEN"]},
    {"label": "London Stansted (STN)",                      "value": "stansted",     "sky": "STN",  "iata": ["STN"]},
    {"label": "Manchester (MAN)",                           "value": "manchester",   "sky": "MAN",  "iata": ["MAN"]},
    {"label": "Newcastle (NCL)",                            "value": "newcastle",    "sky": "NCL",  "iata": ["NCL"]},
    {"label": "Newquay (NQY)",                              "value": "newquay",      "sky": "NQY",  "iata": ["NQY"]},
    {"label": "Norwich (NWI)",                              "value": "norwich",      "sky": "NWI",  "iata": ["NWI"]},
    {"label": "Southampton (SOU)",                          "value": "southampton",  "sky": "SOU",  "iata": ["SOU"]},
    {"label": "Teesside / Durham (MME)",                    "value": "teesside",     "sky": "MME",  "iata": ["MME"]},
]

@app.get("/api/uk-airports")
def get_uk_airports():
    return UK_AIRPORTS


# â”€â”€ Destination airports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/dest-airports")
def get_dest_airports(req: AirportsRequest):
    """Ask Claude for the airports serving a destination city."""
    prompt = (
        f"List the main airports serving {req.dest_city} for international flights from the UK. "
        "Return ONLY valid JSON:\n"
        '{"airports": [{"airport_name": "...", "iata": "XXX", "sky": "XXX", '
        '"transfer_label": "approx X min by metro/taxi", '
        '"transfer_mins": 30, '
        '"transfer_legs": [{"mode": "Metro", "mins": 25, "detail": "Line 1 to city centre"}]}]}'
        "\n\nIf there is only one main airport, return just that one. "
        "sky code = Skyscanner airport/city code."
    )
    try:
        data = claude_json(prompt)
        return data.get("airports", [])
    except Exception as e:
        raise HTTPException(500, str(e))


# â”€â”€ Inspire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/api/photo")
def get_photo(query: str):
    try:
        resp = requests.get(
            "https://api.unsplash.com/search/photos",
            params={"query": query, "per_page": 1, "orientation": "landscape"},
            headers={"Authorization": f"Client-ID {UNSPLASH_KEY}"},
            timeout=5
        )
        data = resp.json()
        results = data.get("results", [])
        if results:
            photo = results[0]
            return {
                "url": photo["urls"]["regular"],
                "thumb": photo["urls"]["small"],
                "credit": photo["user"]["name"],
                "credit_url": photo["user"]["links"]["html"],
            }
        return {"url": None}
    except Exception:
        return {"url": None}


@app.post("/api/inspire")
def inspire(req: InspireRequest):
    """Generate 1-3 destination suggestions."""
    trip_type_text = " / ".join(req.trip_type) if req.trip_type else "Any"
    date_text = (
        f"{req.specific_depart} to {req.specific_return}"
        if req.specific_depart else f"Flexible â€” {req.travel_month}"
    )
    transport_text = (
        "PUBLIC TRANSPORT ONLY â€” no car hire" if "public transport" in req.transport_mode.lower()
        else "Open to car hire"
    )

    # Determine number of suggestions based on dest_preference
    dp = (req.dest_preference or "").strip()
    known_regions = [
        "portugal","spain","france","italy","greece","turkey","croatia","morocco",
        "japan","thailand","iceland","ireland","scotland","wales","andalusia","algarve",
        "tuscany","sicily","corsica","provence","catalonia","scandina","caribbean",
        "canary islands","balearic islands","azores","madeira","uk","england","europe",
        "asia","africa",
    ]
    if dp:
        is_region = any(r in dp.lower() for r in known_regions)
        n_dest = 3 if is_region else 1
        dest_instr = (
            f"Suggest {n_dest} different destinations within or nearby {dp}."
            if is_region else
            f"Return EXACTLY 1 destination card for {dp}. Do NOT suggest alternatives."
        )
    else:
        n_dest = 3
        dest_instr = "Suggest 3 varied destinations suited to this traveller."

    prompt = f"""You are Sherpa, an expert UK travel planner. {dest_instr}

TRAVELLER PROFILE:
- Departing from: {req.starting_point}
- Dates: {date_text}
- Budget: {req.budget}
- Group: {req.group_type} ({req.num_adults} adults)
- Trip type: {trip_type_text}
- Transport: {transport_text}
- Priorities: {req.priorities or "none specified"}

For each destination return a card in EXACTLY this format (---DESTINATION--- before, ---END--- after):

---DESTINATION---
CITY: [City name]
COUNTRY: [Country]
EMOJI: [one relevant emoji]
TAGLINE: [one punchy sentence, max 12 words]
FLIGHT: [Xâ€“X hrs | example airline | departure airport e.g. LHR, MAN]
BEST_FOR: [2â€“3 words]
BUDGET_NOTE: [one sentence on cost level and value]
HIGHLIGHTS: [3 bullet points, each starting with â€¢]
WEATHER: [expected weather for {date_text}]
DISH: [one must-try local dish]
AIRPORT_CODE: [main IATA code e.g. LIS]
COST_GUIDE:
- Flights: Â£Xâ€“Â£X return pp
- Food & drink: Â£Xâ€“Â£X per day  
- Activities: Â£Xâ€“Â£X total
- Local transport: Â£Xâ€“Â£X
- **Estimated total (exc. accommodation): Â£Xâ€“Â£X per person**
---END---

Return exactly {n_dest} destination(s). No other text."""

    resp = claude.messages.create(
        model="claude-sonnet-4-6",
        max_tokens=2000,
        messages=[{"role": "user", "content": prompt}]
    )

    raw = resp.content[0].text
    destinations = []
    for block in raw.split("---DESTINATION---"):
        if "---END---" not in block:
            continue
        body = block.split("---END---")[0].strip()
        d: dict = {}
        for line in body.split("\n"):
            line = line.strip()
            if ":" in line:
                key, _, val = line.partition(":")
                key = key.strip().upper()
                val = val.strip()
                if key == "HIGHLIGHTS":
                    continue
                d[key] = val
        # Parse highlights
        highlights = [l.strip().lstrip("â€¢").strip() for l in body.split("\n") if l.strip().startswith("â€¢")]
        d["highlights"] = highlights
        # Parse cost guide
        cost_lines = []
        in_cost = False
        for line in body.split("\n"):
            if line.strip().startswith("COST_GUIDE"):
                in_cost = True
                continue
            if in_cost and line.strip().startswith("-"):
                cost_lines.append(line.strip())
        d["cost_guide"] = cost_lines
        if d.get("CITY"):
            destinations.append(d)

    return {"destinations": destinations}


# â”€â”€ Itinerary (streaming) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/itinerary")
def build_itinerary(req: ItineraryRequest):
    """Stream the full itinerary as it generates."""
    trip_type_text = " / ".join(req.trip_type) if req.trip_type else "City Break"
    date_text = (
        f"{req.specific_depart} to {req.specific_return}"
        if req.specific_depart else f"Flexible â€” {req.travel_month}"
    )
    car_hire_note = ""
    if req.car_hire_confirmed == "yes":
        car_hire_note = (
            "CRITICAL: This traveller IS hiring a car. They collect it AT THE ARRIVAL AIRPORT "
            "immediately on landing. Getting There MUST describe collecting the hire car at the "
            "airport car hire desk and driving directly to accommodation â€” no other transfer."
        )
    elif "public transport" in req.transport_mode.lower():
        car_hire_note = "This traveller is using PUBLIC TRANSPORT ONLY â€” no car hire at any point."

    # Build personalisation block from user profile
    profile_text = ""
    if req.user_profile:
        p = req.user_profile
        lines = []
        if p.get("age_range"):
            lines.append(f"- Age range: {p['age_range']}")
        if p.get("activity_level"):
            activity_map = {1:"very relaxed (minimal walking, lots of rest)", 2:"gentle (light sightseeing, easy pace)", 3:"balanced (mix of activity and downtime)", 4:"active (plenty of walking, some physical activities)", 5:"very active (hiking, cycling, packed days)"}
            lines.append(f"- Activity preference: {activity_map.get(p['activity_level'], p['activity_level'])}")
        if p.get("dietary"):
            labels = {"vegan":"vegan","vegetarian":"vegetarian","pescatarian":"pescatarian","gluten_free":"gluten free","halal":"halal","kosher":"kosher","nut_allergy":"nut allergy","dairy_free":"dairy free"}
            diets = [labels.get(d, d) for d in p["dietary"]]
            lines.append(f"- Dietary requirements: {', '.join(diets)}")
        if p.get("dietary_other"):
            lines.append(f"- Additional dietary notes: {p['dietary_other']}")
        if p.get("extra_info"):
            lines.append(f"- Personal notes: {p['extra_info']}")
        if lines:
            profile_text = "\n\nPERSONAL TRAVELLER PROFILE (tailor everything to this):\n" + "\n".join(lines)

    prompt = f"""You are Sherpa, an expert travel planner. Create a detailed day-by-day itinerary for {req.dest}.

TRAVELLER PROFILE:
- Flying from: {req.origin_city}
- Dates: {date_text}
- Budget: {req.budget}
- Group: {req.group_type} ({req.num_adults} adults)
- Trip type: {trip_type_text}
- Priorities: {req.priorities or "none specified"}
- Staying at: {req.selected_hotel or "not yet decided"}
- Arriving: {req.arrival_airport or req.dest_city} at {req.arrival_time}
- Departing: {req.departure_time} on last day
- Airport transfer: {req.transfer_label} from airport to city centre
{car_hire_note}

FORMAT â€” use these exact ## headings:

## âœˆï¸ Getting There
[Transfer from {req.arrival_airport or req.dest_city + ' airport'} to accommodation â€” specific method, duration, cost]

## Day 1 â€” [Title]
**ðŸŒ… Morning:** ...
**ðŸ½ï¸ Lunch:** [specific restaurant name, neighbourhood, dish, rough cost]
**â˜€ï¸ Afternoon:** ...
**ðŸ· Dinner:** [specific restaurant name, neighbourhood, cuisine, rough cost for two]
**ðŸŒ™ Evening:** ...

[Repeat for each day]

## ðŸ  Getting Home
[Transfer back to airport, allow {req.transfer_label} + 2hr check-in]

## ðŸ’° Cost Guide
- Flights: Â£Xâ€“Â£X return pp
- Accommodation: Â£Xâ€“Â£X per night
- Food & drink: Â£Xâ€“Â£X per day
- Activities: Â£Xâ€“Â£X total
- Local transport: Â£Xâ€“Â£X
- **Estimated total: Â£Xâ€“Â£X per person**

## ðŸ“Œ Local Tips
[3 short practical tips that most travel guides miss]

Be specific â€” name real restaurants, streets, neighbourhoods. Tailor everything to the {req.budget} budget.{profile_text}"""

    def generate():
        with claude.messages.stream(
            model="claude-sonnet-4-6",
            max_tokens=4000,
            messages=[{"role": "user", "content": prompt}]
        ) as stream:
            for text in stream.text_stream:
                yield f"data: {json.dumps({'text': text})}\n\n"
        yield "data: [DONE]\n\n"

    return StreamingResponse(generate(), media_type="text/event-stream")


# â”€â”€ Car hire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/car-hire")
def car_hire(req: CarHireRequest):
    trip_str = " / ".join(req.trip_type) if req.trip_type else "City Break"
    prompt = (
        f"You are a travel expert. The traveller is visiting {req.dest} on a {trip_str} trip.\n\n"
        "Rate how important hiring a car is (1=not needed, 5=essential). "
        "Recommend the top 3 best-reviewed car hire companies at the destination airport. "
        "Identify 2 companies worth avoiding.\n\n"
        "Return ONLY valid JSON:\n"
        '{"rating": 3, "reasons": ["..."], "companies": ['
        '{"name": "...", "rating": "8.5/10", "highlight": "..."}], '
        '"avoid": [{"name": "...", "rating": "5.1/10", "reason": "..."}]}'
    )
    # Build Rentalcars URL
    rc_url = ""
    if req.depart_date and req.return_date:
        rc_url = (
            f"https://www.rentalcars.com/SearchResults.do"
            f"?addrCode={req.dest_sky or req.dest_city[:3].upper()}"
            f"&puDay={req.depart_date[6:]}&puMonth={req.depart_date[3:5]}&puYear={req.depart_date[:4]}"
            f"&doDay={req.return_date[6:]}&doMonth={req.return_date[3:5]}&doYear={req.return_date[:4]}"
            + (f"&affiliateCode={RENTALCARS_AFFILIATE_ID}" if RENTALCARS_AFFILIATE_ID else "")
        )
    try:
        data = claude_json(prompt)
        data["rentalcars_url"] = rc_url
        return data
    except Exception as e:
        raise HTTPException(500, str(e))


# â”€â”€ Accommodation tips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/accom-tips")
def accom_tips(req: AccomTipsRequest):
    car_context = (
        "HIRING A CAR: Yes â€” prioritise areas with parking, note parking costs."
        if req.car_hire == "yes" else
        "NOT HIRING A CAR: Prioritise walkable areas and good transit links. Mention specific metro/bus lines."
        if req.car_hire == "no" else
        "Car hire unknown â€” balance walkability with transport links."
    )
    prompt = f"""You are a local expert giving a UK traveller advice on where to stay in {req.dest}.

PROFILE: Budget={req.budget}, Group={req.group_type}, Trip={" / ".join(req.trip_type) or "general"}
Interests: {req.priorities or "none"}, {car_context}

Return ONLY valid JSON:
{{"areas": [{{"name":"...", "vibe":"3-5 words", "best_for":"...", "price_range":"approx Â£X-Â£X/night", "tip":"..."}}],
"booking_tips": ["tip 1 referencing transport", "tip 2 for budget/group", "tip 3 watch out for"],
"avoid": "one sentence on what to avoid given transport + budget"}}

Use real neighbourhood names. Tailor to {req.budget} budget and {req.group_type}. Give 3 areas."""
    try:
        return claude_json(prompt, max_tokens=900)
    except Exception as e:
        raise HTTPException(500, str(e))


# â”€â”€ Hotel note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/hotel-note")
def hotel_note(req: HotelNoteRequest):
    prompt = (
        f"In 2 sentences max, describe '{req.hotel}' in {req.dest_city}: "
        "the neighbourhood feel, and how well-located it is for getting around. "
        "Be direct and specific. No filler."
    )
    try:
        resp = claude.messages.create(
            model="claude-haiku-4-5-20251001",
            max_tokens=200,
            messages=[{"role": "user", "content": prompt}]
        )
        return {"note": re.sub(r'^#+\s*', '', resp.content[0].text.strip())}
    except Exception as e:
        raise HTTPException(500, str(e))


# â”€â”€ GYG Activities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/activities")
def activities(req: ActivitiesRequest):
    prompt = (
        f"Analyse this {req.dest_city} itinerary and return two lists in JSON.\n\n"
        "Return ONLY this exact JSON structure, no other text:\n"
        '{"gyg": [{"name":"...","type":"...","why_book_ahead":"...","search_term":"..."}], '
        '"direct": [{"name":"...","type":"Restaurant|Museum|Bar|Cafe","note":"one line tip"}]}\n\n'
        "gyg: up to 3 experiences best booked via GetYourGuide (tours, skip-the-line, cooking classes, boat trips).\n"
        "direct: up to 4 specific restaurants, bars or cafes mentioned in the itinerary worth finding on Instagram.\n\n"
        f"Itinerary:\n{req.itinerary[:2500]}"
    )
    try:
        resp = claude.messages.create(
            model="claude-haiku-4-5-20251001",
            max_tokens=1000,
            messages=[{"role": "user", "content": prompt}]
        )
        text = resp.content[0].text.strip()
        text = re.sub(r'^```json\s*', '', text)
        text = re.sub(r'\s*```$', '', text)
        data = json.loads(text)
        partner = req.gyg_partner_id or GYG_PARTNER_ID

        gyg_list = data.get("gyg", [])
        for a in gyg_list:
            q = a.get("search_term", a.get("name", "")).replace(" ", "+")
            a["gyg_url"] = (
                f"https://www.getyourguide.com/s/?q={q}&partner_id={partner}"
                if partner else
                f"https://www.getyourguide.com/s/?q={q}"
            )

        direct_list = data.get("direct", [])
        for d in direct_list:
            from urllib.parse import quote
            query = f"{d.get('name', '')} {req.dest_city}".strip()
            d["instagram_url"] = f"https://www.instagram.com/search/top/?q={quote(query)}"

        return {"gyg": gyg_list, "direct": direct_list}
    except Exception as e:
        raise HTTPException(500, f"Activities error: {str(e)}")


# â”€â”€ Itinerary tweak (streaming) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/tweak")
def tweak_itinerary(req: TweakRequest):
    prompt = (
        f"Here is a travel itinerary for {req.dest}:\n\n{req.itinerary}\n\n"
        f"The traveller has asked: {req.feedback}\n\n"
        "Rewrite the full itinerary incorporating these changes. "
        "Keep everything that works well and only change what was asked. "
        "Return the full itinerary in exactly the same format â€” same ## headings, same structure."
    )

    def generate():
        with claude.messages.stream(
            model="claude-sonnet-4-6",
            max_tokens=4000,
            messages=[{"role": "user", "content": prompt}]
        ) as stream:
            for text in stream.text_stream:
                yield f"data: {json.dumps({'text': text})}\n\n"
        yield "data: [DONE]\n\n"

    return StreamingResponse(generate(), media_type="text/event-stream")


# â”€â”€ Map pins â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/map-pins")
def map_pins(req: MapPinsRequest):
    prompt = (
        f"Extract all named locations from this {req.dest_city} itinerary as map pins.\n\n"
        f"{req.itinerary[:4000]}\n\n"
        'Return ONLY valid JSON: {"locations": [{"name":"...", "type":"Restaurant|Attraction|Hotel|Museum|Bar|Market|Park|Viewpoint|Beach", "description":"one line"}]}'
    )
    try:
        return claude_json(prompt, max_tokens=800)
    except Exception as e:
        raise HTTPException(500, str(e))


# â”€â”€ Welcome email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/welcome-email")
def welcome_email(req: WelcomeEmailRequest):
    if not req.email:
        return {"sent": False}
    sent = send_welcome_email(req.email, req.first_name)
    return {"sent": sent}


# â”€â”€ Support chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/chat")
def chat(req: ChatRequest):
    system = (
        "You are Sherpa, a friendly expert travel assistant. "
        "Answer concisely and practically. " +
        (f"Context about this trip: {req.context}" if req.context else "")
    )
    messages = req.history + [{"role": "user", "content": req.message}]
    resp = claude.messages.create(
        model="claude-haiku-4-5-20251001",
        max_tokens=500,
        system=system,
        messages=messages
    )
    return {"reply": resp.content[0].text.strip()}


# â”€â”€ Local guide: nearby places â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/nearby")
def nearby(req: LocalGuideRequest):
    prompt = (
        f"The traveller is at coordinates {req.lat:.4f}, {req.lon:.4f}"
        + (f" in {req.dest_city}" if req.dest_city else "") + ".\n"
        "List 8 interesting places within 1km â€” mix of restaurants, cafes, attractions, markets, viewpoints.\n"
        'Return ONLY valid JSON: {"places": [{"name":"...", "type":"Restaurant|Cafe|Bar|Attraction|Market|Viewpoint|Park", '
        '"distance":"approx Xm", "why":"one sentence on why it\'s worth visiting"}]}'
    )
    try:
        return claude_json(prompt, max_tokens=700)
    except Exception as e:
        raise HTTPException(500, str(e))


# â”€â”€ Local guide: history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/api/history")
def history(req: LocalGuideRequest):
    prompt = (
        f"The traveller is at {req.lat:.4f}, {req.lon:.4f}"
        + (f" in {req.dest_city}" if req.dest_city else "") + ".\n"
        "Write 3-4 sentences of engaging local history about this specific location or the immediate neighbourhood. "
        "Focus on surprising or little-known facts. Be vivid and specific."
    )
    resp = claude.messages.create(
        model="claude-haiku-4-5-20251001",
        max_tokens=300,
        messages=[{"role": "user", "content": prompt}]
    )
    return {"history": resp.content[0].text.strip()}


# â”€â”€ Affiliate URL builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/api/config")
def get_config():
    """Return affiliate IDs and config needed by the frontend."""
    return {
        "skyscanner_affiliate": SKYSCANNER_AFFILIATE_ID,
        "booking_affiliate": BOOKING_AFFILIATE_ID,
        "gyg_partner": GYG_PARTNER_ID,
        "rentalcars_affiliate": RENTALCARS_AFFILIATE_ID,
    }


# â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/health")
def health():
    return {"status": "ok"}


===== C:\Users\james\travel-planner\frontend\postcss.config.js =====
export default {
  plugins: { tailwindcss: {}, autoprefixer: {} }
}


===== C:\Users\james\travel-planner\frontend\tailwind.config.js =====
/** @type {import('tailwindcss').Config} */
export default {
  content: ['./index.html', './src/**/*.{js,jsx}'],
  theme: {
    extend: {
      colors: {
        gold:    '#c9a84c',
        'gold-light': '#e8d5a3',
        navy:    '#0d1b2a',
        'navy-2': '#1a2d3e',
        'navy-3': '#243547',
        slate:   '#a8b8c8',
        'slate-2': '#8a9bb0',
        'slate-3': '#5f7080',
      },
      fontFamily: {
        serif: ['"Cormorant Garamond"', 'Georgia', 'serif'],
        sans:  ['Outfit', 'system-ui', 'sans-serif'],
      },
    },
  },
  plugins: [],
}


===== C:\Users\james\travel-planner\frontend\vite.config.js =====
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    proxy: {
      '/api': 'http://localhost:8000'
    }
  }
})

===== C:\Users\james\travel-planner\frontend\src\App.jsx =====
import { useState, useEffect } from 'react'
import { useLocalStorage } from './hooks/useLocalStorage'
import { supabase } from './utils/supabase'
import InspireTab from './components/InspireTab'
import BookTab from './components/BookTab'
import SupportTab from './components/SupportTab'
import AuthModal from './components/AuthModal'
import FeedbackModal from './components/FeedbackModal'
import MyTrips from './components/MyTrips'
import ProfileSetup from './components/ProfileSetup'
import AccountMenu from './components/AccountMenu'
import { Routes, Route } from 'react-router-dom'
import BlogIndex from './blog/BlogIndex'
import BlogPost from './blog/BlogPost'
import ItineraryModal from './components/ItineraryModal'
import { api } from './utils/api'
import { getProfile } from './utils/supabase'

export default function App() {
  const [tab, setTab] = useState('inspire')
  const [user, setUser] = useState(null)
  const [showAuth, setShowAuth] = useState(false)
  const [showFeedback, setShowFeedback] = useState(false)
  const [showItineraryModal,  setShowItineraryModal]  = useState(false)
  const [modalActivities,     setModalActivities]     = useState(null)
  const [modalActivitiesLoad, setModalActivitiesLoad] = useState(false)
  const [showProfile, setShowProfile] = useState(false)
  const [showEditProfile, setShowEditProfile] = useState(false)
  const [userProfile, setUserProfile] = useState(null)

  const [prefs, setPrefs] = useLocalStorage('sherpa_prefs', {
    startingPoint:  '',
    budget:         'Â£Â£ â€” Mid-range',
    groupType:      'Couple',
    tripType:       [],
    transportMode:  'willing to rent',
    priorities:     '',
    travelMonth:    'May',
    specificDepart: null,
    specificReturn: null,
    numAdults:      2,
    numChildren:    0,
    childrenAges:   [],
  })

  const [inspireResults, setInspireResults] = useState([])
  const [chosenDest, setChosenDest]         = useState(null)
  const [itinerary, setItinerary]           = useState('')
  const [flightDetails, setFlightDetails]   = useState({
    confirmed: false, outboundDate: null, returnDate: null,
    arrivalTime: '11:00', departureTime: '14:00', selectedAirport: null,
  })
  const [carHire, setCarHire]             = useState({ confirmed: null, data: null })
  const [selectedHotel, setSelectedHotel] = useState('')

  const loadProfile = async (u) => {
    const profile = await getProfile(u.id)
    if (!profile) {
      setShowProfile(true)
    } else {
      setUserProfile(profile)
    }
  }

  useEffect(() => {
    supabase.auth.getUser().then(({ data: { user } }) => {
      setUser(user)
      if (user) loadProfile(user)
    })
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      const u = session?.user || null
      setUser(u)
      if (u) loadProfile(u)
    })
    return () => subscription.unsubscribe()
  }, [])

  const handleSignOut = async () => {
    await supabase.auth.signOut()
    setUser(null)
    setTab('inspire')
  }

  const resetTripState = (newPrefs) => {
    const p = newPrefs || prefs
    setItinerary('')

    let outbound = p.specificDepart || null
    let ret      = p.specificReturn  || null
    if (!outbound && p.travelMonth) {
      const months = ['January','February','March','April','May','June',
                      'July','August','September','October','November','December']
      const mIdx = months.indexOf(p.travelMonth)
      if (mIdx >= 0) {
        const year = new Date().getFullYear()
        const useYear = mIdx < new Date().getMonth() ? year + 1 : year
        outbound = `${useYear}-${String(mIdx+1).padStart(2,'0')}-10`
        ret      = `${useYear}-${String(mIdx+1).padStart(2,'0')}-14`
      }
    }

    setFlightDetails({
      confirmed:       false,
      outboundDate:    outbound,
      returnDate:      ret,
      arrivalTime:     '11:00',
      departureTime:   '14:00',
      selectedAirport: null,
    })
    setCarHire({ confirmed: null, data: null })
    setSelectedHotel('')
  }

  const handleChooseDest = (dest) => {
    resetTripState()
    setChosenDest(dest)
    setTab('book')
  }

  const handleLoadTrip = (trip) => {
    setChosenDest({ CITY: trip.destination, COUNTRY: trip.country, EMOJI: trip.emoji || 'ðŸŒ' })
    if (trip.itinerary)      setItinerary(trip.itinerary)
    if (trip.flight_details) setFlightDetails(trip.flight_details)
    if (trip.car_hire)       setCarHire(trip.car_hire)
    if (trip.hotel)          setSelectedHotel(trip.hotel)
    setShowItineraryModal(true)
    setModalActivities(null)
  }

  const switchTab = (id) => {
    setTab(id)
    window.scrollTo({ top: 0, behavior: 'smooth' })
  }

  const tabs = [
    { id: 'inspire', label: 'âœ¨ Inspire' },
    { id: 'book',    label: 'ðŸ—“ï¸ Book'   },
    { id: 'trips',   label: 'ðŸ§­ Trips'  },
  ]

  return (
    <Routes>
      <Route path="/blog" element={<BlogIndex />} />
      <Route path="/blog/:slug" element={<BlogPost />} />
      <Route path="/*" element={(
    <div className="min-h-screen">
      <header className="sticky top-0 z-50" style={{background:'rgba(17,22,20,0.92)', backdropFilter:'blur(12px)', borderBottom:'1px solid rgba(127,182,133,0.1)'}}>
        <div className="max-w-4xl mx-auto px-4 py-2.5 flex items-center justify-between">
          <h1 className="font-serif text-xl tracking-wide shrink-0" style={{color:'#a8c9ad'}}>
            Sherpa Travel
          </h1>
          <div className="flex items-center gap-1">
            <nav className="flex gap-1">
              {tabs.map(t => (
                <button
                  key={t.id}
                  onClick={() => switchTab(t.id)}
                  className="px-3 py-1.5 rounded-lg text-sm font-medium transition-all"
                  style={{
                    background: tab === t.id ? 'rgba(127,182,133,0.15)' : 'transparent',
                    color: tab === t.id ? '#a8c9ad' : '#7a7870',
                    border: tab === t.id ? '1px solid rgba(127,182,133,0.3)' : '1px solid transparent',
                  }}
                >
                  {t.label}
                </button>
              ))}
              <a href="/blog"
                className="px-3 py-1.5 rounded-lg text-sm font-medium transition-all"
                style={{color:'#7a7870', border:'1px solid transparent'}}
                onMouseEnter={e => e.target.style.color='#a8c9ad'}
                onMouseLeave={e => e.target.style.color='#7a7870'}>
                âœï¸ Blog
              </a>
              <button
                onClick={() => setShowFeedback(true)}
                className="px-3 py-1.5 rounded-lg text-sm font-medium transition-all"
                style={{color:'#7a7870', border:'1px solid transparent'}}
                onMouseEnter={e => e.target.style.color='#a8c9ad'}
                onMouseLeave={e => e.target.style.color='#7a7870'}>
                ðŸ’¬ Feedback
              </button>
            </nav>
            {user ? (
              <AccountMenu
                user={user}
                userProfile={userProfile}
                onEditProfile={() => setShowEditProfile(true)}
                onSignOut={handleSignOut}
              />
            ) : (
              <button className="btn-secondary text-xs px-3 py-1.5" onClick={() => setShowAuth(true)}>Sign in</button>
            )}
          </div>
        </div>
      </header>

      {showAuth && (
        <AuthModal onClose={() => setShowAuth(false)} onSuccess={() => setShowAuth(false)} />
      )}

      {showFeedback && (
        <FeedbackModal onClose={() => setShowFeedback(false)} user={user} />
      )}

      {showProfile && user && (
        <ProfileSetup
          user={user}
          onComplete={(profile) => { setUserProfile(profile); setShowProfile(false) }}
        />
      )}

      {showEditProfile && user && (
        <ProfileSetup
          user={user}
          existingProfile={userProfile}
          onComplete={(profile) => { setUserProfile(profile); setShowEditProfile(false) }}
        />
      )}

      <main className="max-w-4xl mx-auto px-4 py-8">
        {tab === 'inspire' && (
          <InspireTab
            prefs={prefs} setPrefs={setPrefs}
            inspireResults={inspireResults} setInspireResults={setInspireResults}
            chosenDest={chosenDest} setChosenDest={handleChooseDest}
            onBook={() => switchTab('book')}
            user={user}
            onRequireAuth={() => setShowAuth(true)}
            onRequestFeedback={() => setShowFeedback(true)}
          />
        )}
        {tab === 'book' && (
          <BookTab
            prefs={prefs} setPrefs={setPrefs}
            chosenDest={chosenDest} setChosenDest={setChosenDest}
            itinerary={itinerary} setItinerary={setItinerary}
            flightDetails={flightDetails} setFlightDetails={setFlightDetails}
            carHire={carHire} setCarHire={setCarHire}
            selectedHotel={selectedHotel} setSelectedHotel={setSelectedHotel}
            user={user} userProfile={userProfile} onSaveTrip={() => switchTab('trips')}
            externalShowModal={showItineraryModal} setExternalShowModal={setShowItineraryModal}
            onRequireAuth={() => setShowAuth(true)}
          />
        )}
        {tab === 'trips' && (
          <div className="space-y-8">
            <SupportTab
              prefs={prefs} chosenDest={chosenDest} itinerary={itinerary}
              flightDetails={flightDetails} carHire={carHire} selectedHotel={selectedHotel}
            />
            {user ? (
              <div className="space-y-4">
                <h2 className="font-serif text-xl text-gold-light">ðŸ“ Saved Trips</h2>
                <MyTrips onLoadTrip={handleLoadTrip} />
              </div>
            ) : (
              <div className="card text-center py-6">
                <p className="text-slate-3 text-sm mb-3">Sign in to save and revisit your itineraries</p>
                <button className="btn-primary px-6" onClick={() => setShowAuth(true)}>Sign in</button>
              </div>
            )}
          </div>
        )}
      </main>

      {showItineraryModal && itinerary && (
        <ItineraryModal
          itinerary={itinerary}
          dest={chosenDest}
          destData={null}
          prefs={prefs}
          flightDetails={flightDetails}
          selectedHotel={selectedHotel}
          onClose={() => setShowItineraryModal(false)}
          activities={modalActivities}
          activitiesLoading={modalActivitiesLoad}
          fetchActivities={async () => {
            if (!chosenDest?.CITY || !itinerary) return
            setModalActivitiesLoad(true)
            try {
              const d = await api.activities({ dest_city: chosenDest.CITY, itinerary })
              setModalActivities({ gyg: d.gyg || [], direct: d.direct || [] })
            } catch {}
            finally { setModalActivitiesLoad(false) }
          }}
          feedback=""
          setFeedback={() => {}}
          onTweak={() => {}}
          tweaking={false}
          onSave={() => {}}
          saving={false}
          saved={false}
          user={user}
        />
      )}
    </div>
    )} />
    </Routes>
  )
}


===== C:\Users\james\travel-planner\frontend\src\index.css =====
@tailwind base;
@tailwind components;
@tailwind utilities;

@import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@300;400;500;600&display=swap');

@layer base {
  body {
    background: #111614;
    color: #c8c4bc;
    font-family: 'Inter', system-ui, sans-serif;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  h1, h2, h3 {
    font-family: 'DM Serif Display', Georgia, serif;
  }
}

@layer components {
  /* Cards */
  .card {
    @apply rounded-2xl p-5;
    background: #1a2020;
    border: 1px solid rgba(127,182,133,0.08);
  }
  .card-gold {
    @apply rounded-2xl p-5;
    background: #1a2020;
    border: 1px solid rgba(127,182,133,0.25);
  }

  /* Buttons */
  .btn-primary {
    @apply font-medium px-6 py-2.5 rounded-xl transition-all cursor-pointer
           disabled:opacity-40 disabled:cursor-not-allowed inline-block text-center;
    background: #7fb685;
    color: #111614;
  }
  .btn-primary:hover:not(:disabled) {
    background: #a8c9ad;
  }
  .btn-secondary {
    @apply font-medium px-5 py-2 rounded-xl transition-all cursor-pointer inline-block text-center;
    background: transparent;
    border: 1px solid rgba(127,182,133,0.2);
    color: #c8c4bc;
  }
  .btn-secondary:hover {
    border-color: rgba(127,182,133,0.5);
    color: #a8c9ad;
  }
  .btn-danger {
    @apply px-4 py-1.5 rounded-lg transition-all cursor-pointer text-sm font-medium;
    background: transparent;
    border: 1px solid rgba(220,100,100,0.3);
    color: #e08080;
  }
  .btn-danger:hover {
    background: rgba(220,100,100,0.08);
  }

  /* Inputs */
  .input {
    @apply w-full rounded-xl px-4 py-2.5 text-sm transition-colors focus:outline-none;
    background: #222b28;
    border: 1px solid rgba(127,182,133,0.12);
    color: #f0ede8;
  }
  .input::placeholder { color: #7a7870; }
  .input:focus { border-color: rgba(127,182,133,0.4); }
  .select {
    @apply input appearance-none cursor-pointer;
  }
  .label {
    @apply block text-xs font-semibold uppercase tracking-widest mb-1.5;
    color: #7a7870;
    letter-spacing: 0.1em;
  }

  /* Divider */
  .divider {
    @apply my-6;
    border-top: 1px solid rgba(127,182,133,0.1);
  }

  /* Badge */
  .badge {
    @apply inline-block text-xs font-semibold px-2.5 py-0.5 rounded-full;
    background: rgba(127,182,133,0.1);
    color: #7fb685;
    border: 1px solid rgba(127,182,133,0.2);
  }

  /* Note */
  .note {
    @apply pl-3 text-sm leading-relaxed;
    border-left: 2px solid rgba(127,182,133,0.5);
    color: #c8c4bc;
  }

  /* Section label */
  .section-label {
    @apply text-xs font-semibold uppercase tracking-widest mb-2;
    color: #7a7870;
    letter-spacing: 0.12em;
  }
}

/* Scrollbar */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: #111614; }
::-webkit-scrollbar-thumb { background: #2a3530; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(127,182,133,0.3); }

/* Date picker overrides */
.react-datepicker {
  background: #1a2020 !important;
  border: none !important;
  border-radius: 12px !important;
  font-family: 'Inter', sans-serif !important;
  color: #c8c4bc !important;
  width: 100% !important;
}
.react-datepicker__month-container { float: none !important; flex: 1 !important; }
.react-datepicker__header {
  background: #1a2020 !important;
  border-bottom: 1px solid rgba(127,182,133,0.08) !important;
  border-radius: 0 !important;
  padding-top: 12px !important;
}
.react-datepicker__current-month,
.react-datepicker__day-name { color: #7fb685 !important; font-size: 0.8rem !important; }
.react-datepicker__day {
  color: #c8c4bc !important;
  border-radius: 6px !important;
  width: 2rem !important;
  line-height: 2rem !important;
  margin: 2px !important;
}
.react-datepicker__day:hover { background: rgba(127,182,133,0.12) !important; color: #f0ede8 !important; }
.react-datepicker__day--selected,
.react-datepicker__day--range-start,
.react-datepicker__day--range-end { background: #7fb685 !important; color: #111614 !important; font-weight: 600 !important; }
.react-datepicker__day--in-range { background: rgba(127,182,133,0.12) !important; color: #f0ede8 !important; border-radius: 0 !important; }
.react-datepicker__day--range-start { border-radius: 6px 0 0 6px !important; }
.react-datepicker__day--range-end { border-radius: 0 6px 6px 0 !important; }
.react-datepicker__day--in-selecting-range { background: rgba(127,182,133,0.08) !important; }
.react-datepicker__day--keyboard-selected { background: rgba(127,182,133,0.15) !important; }
.react-datepicker__navigation-icon::before { border-color: #7fb685 !important; }
.react-datepicker__day--outside-month { color: #2a3530 !important; }
.react-datepicker__day--disabled { color: #2a3530 !important; cursor: not-allowed !important; }
.react-datepicker__month { min-height: 196px !important; margin: 0.4rem !important; }
.react-datepicker__week { display: flex !important; }
.range-picker-wrap .react-datepicker { display: flex !important; flex-direction: row !important; width: 100% !important; }
.range-picker-wrap .react-datepicker__month-container { width: 50% !important; }
.range-picker-wrap .react-datepicker__month-container:first-child { border-right: 1px solid rgba(127,182,133,0.06) !important; }


===== C:\Users\james\travel-planner\frontend\src\main.jsx =====
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </StrictMode>,
)


===== C:\Users\james\travel-planner\frontend\src\blog\BlogIndex.jsx =====
import '/src/index.css'
import { useState } from 'react'
import { Link } from 'react-router-dom'
import { posts, getAllTags } from './Registry'

export default function BlogIndex() {
  const [activeTag, setActiveTag] = useState(null)
  const allTags = getAllTags()
  const filtered = activeTag ? posts.filter(p => p.tags.includes(activeTag)) : posts
  const fmtDate  = (iso) => new Date(iso).toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' })

  return (
    <div className="min-h-screen" style={{background:'#111614'}}>
      <div className="sticky top-0 z-50 border-b" style={{background:'rgba(17,22,20,0.95)', backdropFilter:'blur(12px)', borderColor:'rgba(127,182,133,0.15)'}}>
        <div className="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
          <Link to="/" className="font-serif text-xl" style={{color:'#7fb685'}}>Sherpa</Link>
          <Link to="/" className="text-sm" style={{color:'#7a7870'}}>â† Back to app</Link>
        </div>
      </div>
      <div className="max-w-3xl mx-auto px-4 pt-14 pb-10">
        <p className="text-xs uppercase tracking-widest mb-3" style={{color:'#7fb685'}}>Travel Blog</p>
        <h1 className="font-serif text-4xl mb-4" style={{color:'#f0ede8', lineHeight:1.2}}>Real trips.<br />Honest guides.</h1>
        <p className="text-lg" style={{color:'#a0a098'}}>Written by people who've actually been there â€” with photos to prove it.</p>
      </div>
      {allTags.length > 0 && (
        <div className="max-w-3xl mx-auto px-4 pb-8 flex gap-2 flex-wrap">
          <button onClick={() => setActiveTag(null)} className="text-xs px-3 py-1.5 rounded-full" style={{background: !activeTag ? '#7fb685' : 'rgba(127,182,133,0.08)', color: !activeTag ? '#111614' : '#7a7870', border: !activeTag ? 'none' : '1px solid rgba(127,182,133,0.2)'}}>All</button>
          {allTags.map(tag => (
            <button key={tag} onClick={() => setActiveTag(tag === activeTag ? null : tag)} className="text-xs px-3 py-1.5 rounded-full" style={{background: activeTag===tag ? '#7fb685' : 'rgba(127,182,133,0.08)', color: activeTag===tag ? '#111614' : '#7a7870', border: activeTag===tag ? 'none' : '1px solid rgba(127,182,133,0.2)'}}>
              {tag}
            </button>
          ))}
        </div>
      )}
      <div className="max-w-3xl mx-auto px-4 pb-24 space-y-6">
        {filtered.map(post => (
          <Link key={post.slug} to={`/blog/${post.slug}`} className="block group">
            <div className="rounded-2xl overflow-hidden transition-all duration-200" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.1)'}} onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(127,182,133,0.3)'} onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(127,182,133,0.1)'}>
              <div className="overflow-hidden" style={{height:220}}>
                <img src={post.coverImage} alt={post.title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" style={{filter:'brightness(0.8)'}} onError={e => { e.target.parentElement.style.background='#222b28'; e.target.style.display='none' }} />
              </div>
              <div className="p-6">
                <div className="flex gap-2 mb-3 flex-wrap">
                  {post.tags.map(tag => (<span key={tag} className="text-xs px-2.5 py-1 rounded-full" style={{background:'rgba(127,182,133,0.1)', color:'#7fb685', border:'1px solid rgba(127,182,133,0.2)'}}>{tag}</span>))}
                </div>
                <h2 className="font-serif text-xl mb-2" style={{color:'#f0ede8', lineHeight:1.3}}>{post.title}</h2>
                <p className="text-sm mb-5 leading-relaxed" style={{color:'#a0a098'}}>{post.description}</p>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2.5">
                    <div className="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold" style={{background:'rgba(127,182,133,0.15)', color:'#7fb685'}}>{post.author[0]}</div>
                    <span className="text-xs" style={{color:'#7a7870'}}>{post.author} Â· {fmtDate(post.date)}</span>
                  </div>
                  <span className="text-xs" style={{color:'#7a7870'}}>{post.readTime} min read</span>
                </div>
              </div>
            </div>
          </Link>
        ))}
      </div>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\blog\BlogPost.jsx =====
import '/src/index.css'
import { useState, useEffect } from 'react'
import { useParams, Link, useNavigate } from 'react-router-dom'
import ReactMarkdown from 'react-markdown'
import remarkGfm from 'remark-gfm'
import { getPost } from './Registry'

export default function BlogPost() {
  const { slug }            = useParams()
  const navigate            = useNavigate()
  const post                = getPost(slug)
  const [md, setMd]         = useState('')
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (!post) return
    fetch(`/blog/${slug}/index.md`)
      .then(r => r.text())
      .then(text => {
        const stripped = text.replace(/^---[\s\S]*?---\n/, '')
        setMd(stripped)
        setLoading(false)
      })
      .catch(() => setLoading(false))
  }, [slug])

  if (!post) return (
    <div className="min-h-screen flex items-center justify-center" style={{background:'#111614'}}>
      <div className="text-center">
        <p className="text-4xl mb-4">ðŸ—ºï¸</p>
        <p className="font-serif text-xl mb-3" style={{color:'#f0ede8'}}>Post not found</p>
        <Link to="/blog" style={{color:'#7fb685'}}>â† Back to blog</Link>
      </div>
    </div>
  )

  const fmtDate = (iso) => new Date(iso).toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' })

  return (
    <div className="min-h-screen" style={{background:'#111614'}}>
      <div className="sticky top-0 z-50 border-b" style={{background:'rgba(17,22,20,0.95)', backdropFilter:'blur(12px)', borderColor:'rgba(127,182,133,0.15)'}}>
        <div className="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
          <Link to="/" className="font-serif text-xl" style={{color:'#7fb685'}}>Sherpa</Link>
          <Link to="/blog" className="text-sm" style={{color:'#7a7870'}}>â† Blog</Link>
        </div>
      </div>

      <div className="w-full relative" style={{height:420}}>
        <img src={post.coverImage} alt={post.title} className="w-full h-full object-cover" style={{filter:'brightness(0.55)'}} onError={e => e.target.parentElement.style.background='#1a2020'} />
        <div className="absolute inset-0" style={{background:'linear-gradient(to top, #111614 0%, transparent 55%)'}} />
      </div>

      <div className="max-w-3xl mx-auto px-4">
        <div className="-mt-28 relative z-10 mb-10">
          <div className="flex gap-2 mb-4 flex-wrap">
            {post.tags.map(tag => (<span key={tag} className="text-xs px-2.5 py-1 rounded-full" style={{background:'rgba(127,182,133,0.15)', color:'#7fb685', border:'1px solid rgba(127,182,133,0.3)'}}>{tag}</span>))}
          </div>
          <h1 className="font-serif mb-4" style={{color:'#f0ede8', fontSize:'2rem', lineHeight:1.2}}>{post.title}</h1>
          <p className="text-base mb-6" style={{color:'#a0a098'}}>{post.description}</p>
          <div className="flex items-center gap-3 pb-8 border-b" style={{borderColor:'rgba(255,255,255,0.08)'}}>
            <div className="w-9 h-9 rounded-full flex items-center justify-center font-bold" style={{background:'rgba(127,182,133,0.2)', color:'#7fb685'}}>{post.author[0]}</div>
            <div>
              <p className="text-sm font-medium" style={{color:'#f0ede8'}}>{post.author}</p>
              <p className="text-xs" style={{color:'#7a7870'}}>{fmtDate(post.date)} Â· {post.readTime} min read</p>
            </div>
          </div>
        </div>

        <SherpaCTA post={post} navigate={navigate} />

        {loading ? (
          <div className="py-12 text-center" style={{color:'#7a7870'}}>Loadingâ€¦</div>
        ) : (
          <div className="pb-8">
            <ReactMarkdown remarkPlugins={[remarkGfm]} components={markdownComponents(post.slug)}>{md}</ReactMarkdown>
          </div>
        )}

        <SherpaCTA post={post} navigate={navigate} footer />

        <div className="py-12 text-center">
          <Link to="/blog" className="text-sm" style={{color:'#7a7870'}}>â† More from the blog</Link>
        </div>
      </div>
    </div>
  )
}

function SherpaCTA({ post, navigate, footer }) {
  return (
    <div className={`rounded-2xl p-6 text-center ${footer ? 'mb-16 mt-8' : 'mb-10'}`} style={{background:'rgba(127,182,133,0.07)', border:'1px solid rgba(127,182,133,0.25)'}}>
      <p className="font-serif text-xl mb-1" style={{color:'#f0ede8'}}>{post.emoji} Ready to plan your {post.destination} trip?</p>
      <p className="text-sm mb-4" style={{color:'#a0a098'}}>Sherpa builds you a personalised day-by-day itinerary in seconds â€” free to use.</p>
      <button onClick={() => navigate(`/?dest=${encodeURIComponent(post.destination)}&country=${encodeURIComponent(post.country)}&emoji=${encodeURIComponent(post.emoji)}`)} className="btn-primary px-8 py-3 text-base">
        Build my {post.destination} itinerary â†’
      </button>
    </div>
  )
}

const markdownComponents = (slug) => ({
  h2: ({children}) => <h2 className="font-serif text-2xl mt-10 mb-4" style={{color:'#f0ede8'}}>{children}</h2>,
  h3: ({children}) => <h3 className="font-serif text-xl mt-8 mb-3" style={{color:'#f0ede8'}}>{children}</h3>,
  p:  ({children}) => <p className="text-base leading-relaxed mb-5" style={{color:'#c8c4bc'}}>{children}</p>,
  strong: ({children}) => <strong style={{color:'#f0ede8', fontWeight:600}}>{children}</strong>,
  blockquote: ({children}) => (
    <div className="my-6 rounded-xl px-5 py-4" style={{background:'rgba(127,182,133,0.08)', border:'1px solid rgba(127,182,133,0.25)'}}>
      <div className="text-sm leading-relaxed" style={{color:'#a8c9ad'}}>{children}</div>
    </div>
  ),
  img: ({src, alt}) => {
    const imgSrc = src.startsWith('http') ? src : `/blog/${slug}/${src}`
    return (
      <figure className="my-8 -mx-4">
        <img src={imgSrc} alt={alt} className="w-full object-cover rounded-xl" style={{maxHeight:480, filter:'brightness(0.92)'}} />
        {alt && <figcaption className="text-xs text-center mt-2" style={{color:'#7a7870'}}>{alt}</figcaption>}
      </figure>
    )
  },
  table:  ({children}) => <div className="my-6 rounded-xl overflow-hidden" style={{border:'1px solid rgba(127,182,133,0.2)'}}><table className="w-full text-sm">{children}</table></div>,
  td:     ({children}) => <td className="px-4 py-2.5 border-b" style={{color:'#c8c4bc', borderColor:'rgba(255,255,255,0.05)'}}>{children}</td>,
  tr:     ({children}) => <tr style={{background:'#1a2020'}}>{children}</tr>,
  ul:     ({children}) => <ul className="mb-5 space-y-1.5 pl-1" style={{color:'#c8c4bc'}}>{children}</ul>,
  li:     ({children}) => <li className="text-base leading-relaxed flex gap-2"><span style={{color:'#7fb685'}}>â€”</span><span>{children}</span></li>,
  hr:     ()           => <div className="my-10 border-t" style={{borderColor:'rgba(127,182,133,0.15)'}} />,
})


===== C:\Users\james\travel-planner\frontend\src\blog\Registry.js =====
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BLOG REGISTRY
// To add a new post:
//   1. Create folder: public/blog/[slug]/
//   2. Write post:    public/blog/[slug]/index.md
//   3. Add one entry below
// That's it. Photos go in the same folder as the markdown.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export const posts = [
  {
  slug:        '3-days-in-athens',
  title:       '3 Days in Athens â€” Ancient Ruins, Rooftop Views & Incredible Food',
  description: 'A long-weekend itinerary for first-timers exploring Athens on a budget, from the Acropolis to the best souvlaki in Monastiraki.',
  date:        '2026-02-23',
  author:      'Kate',
  destination: 'Athens',
  country:     'Greece',
  emoji:       'ðŸ‡¬ðŸ‡·',
  coverImage:  '/blog/3-days-in-athens/parthenon-crowds.jpg',
  tags:        ['Greece', 'City Break', 'Culture', 'Food'],
  readTime:    7,
},


  // â”€â”€ ADD NEW POSTS HERE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // {
  //   slug:        'porto-weekend',
  //   title:       'A Weekend in Porto',
  //   description: '...',
  //   date:        '2026-03-01',
  //   author:      'James',
  //   destination: 'Porto',
  //   country:     'Portugal',
  //   emoji:       'ðŸ‡µðŸ‡¹',
  //   coverImage:  '/blog/porto-weekend/cover.jpg',
  //   tags:        ['Portugal', 'Weekend', 'Food'],
  //   readTime:    5,
  // },
]

export const getPost     = (slug) => posts.find(p => p.slug === slug)
export const getByTag    = (tag)  => posts.filter(p => p.tags.includes(tag))
export const getAllTags   = ()    => [...new Set(posts.flatMap(p => p.tags))].sort()


===== C:\Users\james\travel-planner\frontend\src\components\AccountMenu.jsx =====
import { useState, useRef, useEffect } from 'react'

export default function AccountMenu({ user, userProfile, onEditProfile, onSignOut }) {
  const [open, setOpen] = useState(false)
  const ref = useRef(null)

  useEffect(() => {
    const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false) }
    document.addEventListener('mousedown', handler)
    return () => document.removeEventListener('mousedown', handler)
  }, [])

  const firstName = userProfile?.first_name || user.email.split('@')[0]

  return (
    <div className="relative" ref={ref}>
      <button
        onClick={() => setOpen(o => !o)}
        className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-all"
        style={{
          background: open ? 'rgba(127,182,133,0.15)' : 'rgba(255,255,255,0.05)',
          border: '1px solid rgba(127,182,133,0.25)',
          color: '#f0ede8',
        }}>
        <div className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
             style={{ background: '#7fb685', color: '#111614' }}>
          {firstName[0].toUpperCase()}
        </div>
        <span className="hidden sm:block">{firstName}</span>
        <span className="text-xs" style={{ color: '#7a7870' }}>{open ? 'â–²' : 'â–¼'}</span>
      </button>

      {open && (
        <div className="absolute right-0 mt-2 w-56 rounded-xl overflow-hidden shadow-xl z-50"
             style={{ background: '#111614', border: '1px solid rgba(127,182,133,0.2)' }}>

          {/* User info */}
          <div className="px-4 py-3 border-b" style={{ borderColor: 'rgba(255,255,255,0.06)' }}>
            <p className="text-sm font-medium" style={{ color: '#f0ede8' }}>
              {userProfile?.first_name && userProfile?.last_name
                ? `${userProfile.first_name} ${userProfile.last_name}`
                : firstName}
            </p>
            <p className="text-xs mt-0.5" style={{ color: '#7a7870' }}>{user.email}</p>
          </div>

          {/* Profile summary */}
          {userProfile && (
            <div className="px-4 py-2.5 border-b" style={{ borderColor: 'rgba(255,255,255,0.06)' }}>
              {userProfile.age_range && (
                <p className="text-xs mb-1" style={{ color: '#7a7870' }}>Age: <span style={{ color: '#a0a098' }}>{userProfile.age_range}</span></p>
              )}
              {userProfile.activity_level && (
                <p className="text-xs mb-1" style={{ color: '#7a7870' }}>
                  Activity: <span style={{ color: '#a0a098' }}>
                    {['', 'Very relaxed', 'Gentle', 'Balanced', 'Active', 'Very active'][userProfile.activity_level]}
                  </span>
                </p>
              )}
              {userProfile.dietary?.length > 0 && (
                <p className="text-xs" style={{ color: '#7a7870' }}>
                  Diet: <span style={{ color: '#a0a098' }}>{userProfile.dietary.join(', ')}</span>
                </p>
              )}
            </div>
          )}

          {/* Actions */}
          <div className="p-2">
            <button
              onClick={() => { setOpen(false); onEditProfile() }}
              className="w-full text-left px-3 py-2 rounded-lg text-sm transition-all"
              style={{ color: '#c8c4bc' }}
              onMouseEnter={e => e.target.style.background = 'rgba(255,255,255,0.05)'}
              onMouseLeave={e => e.target.style.background = 'transparent'}>
              Edit profile
            </button>
            <button
              onClick={() => { setOpen(false); onSignOut() }}
              className="w-full text-left px-3 py-2 rounded-lg text-sm transition-all"
              style={{ color: '#a0a098' }}
              onMouseEnter={e => e.target.style.color = '#f0ede8'}
              onMouseLeave={e => e.target.style.color = '#a0a098'}>
              Sign out
            </button>
          </div>
        </div>
      )}
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\AuthModal.jsx =====
import { useState } from 'react'
import { signIn, signUp } from '../utils/supabase'
import { track } from '../utils/analytics'

export default function AuthModal({ onClose, onSuccess }) {
  const [mode,     setMode]     = useState('signin') // 'signin' | 'signup'
  const [email,    setEmail]    = useState('')
  const [password, setPassword] = useState('')
  const [loading,  setLoading]  = useState(false)
  const [error,    setError]    = useState('')
  const [success,  setSuccess]  = useState('')

  const handle = async () => {
    if (!email || !password) return
    setLoading(true)
    setError('')
    setSuccess('')
    try {
      if (mode === 'signup') {
        await signUp(email, password)
        track('sign_up', { method: 'email' })
        setSuccess('Account created! Check your email to confirm, then sign in.')
        setMode('signin')
      } else {
        await signIn(email, password)
        track('sign_in', { method: 'email' })
        onSuccess()
        onClose()
      }
    } catch (e) {
      setError(e.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
      <div className="card-gold w-full max-w-sm mx-4 relative">
        <button
          className="absolute top-3 right-3 text-slate-3 hover:text-sage transition-colors text-lg"
          onClick={onClose}
        >âœ•</button>

        <h2 className="font-serif text-xl text-sage-light mb-1">
          {mode === 'signin' ? 'Welcome back' : 'Create account'}
        </h2>
        <p className="text-sm text-slate-3 mb-5">
          {mode === 'signin'
            ? 'Sign in to view and save your trips.'
            : 'Save itineraries and access them from any device.'}
        </p>

        <div className="space-y-3">
          <div>
            <label className="label">Email</label>
            <input
              className="input"
              type="email"
              placeholder="you@example.com"
              value={email}
              onChange={e => setEmail(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handle()}
            />
          </div>
          <div>
            <label className="label">Password</label>
            <input
              className="input"
              type="password"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              value={password}
              onChange={e => setPassword(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handle()}
            />
          </div>
        </div>

        {error   && <p className="text-red-400 text-sm mt-3">{error}</p>}
        {success && <p className="text-green-400 text-sm mt-3">{success}</p>}

        <button
          className="btn-primary w-full mt-4"
          onClick={handle}
          disabled={loading || !email || !password}
        >
          {loading ? 'Please waitâ€¦' : mode === 'signin' ? 'Sign in' : 'Create account'}
        </button>

        <p className="text-center text-sm text-slate-3 mt-4">
          {mode === 'signin' ? "Don't have an account? " : 'Already have an account? '}
          <button
            className="text-sage hover:text-sage-light transition-colors"
            onClick={() => { setMode(m => m === 'signin' ? 'signup' : 'signin'); setError(''); setSuccess('') }}
          >
            {mode === 'signin' ? 'Sign up' : 'Sign in'}
          </button>
        </p>
      </div>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\BookTab.jsx =====
import { useState, useEffect, useRef } from 'react'
import { saveTrip } from '../utils/supabase'
import ReactMarkdown from 'react-markdown'
import ItineraryModal from './ItineraryModal'
import DatePicker from 'react-datepicker'
import { api } from '../utils/api'
import SherpaSpinner from './SherpaSpinner'
import { useUsageLimit } from '../hooks/useUsageLimit'
import { track } from '../utils/analytics'

// â”€â”€ Small reusable pieces â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function Section({ title, children }) {
  return (
    <div>
      <h2 className="font-serif text-xl text-sage-light mb-4">{title}</h2>
      {children}
    </div>
  )
}

function TimeSelect({ label, value, onChange }) {
  const hours = Array.from({ length: 24 }, (_, i) => i)
  const mins  = ['00', '15', '30', '45']
  const [h, m] = (value || '10:00').split(':')
  return (
    <div>
      <label className="label">{label}</label>
      <div className="flex gap-2">
        <select className="select w-20" value={h}
          onChange={e => onChange(`${e.target.value}:${m}`)}>
          {hours.map(hh => <option key={hh} value={String(hh).padStart(2,'0')}>{String(hh).padStart(2,'0')}</option>)}
        </select>
        <select className="select w-20" value={m}
          onChange={e => onChange(`${h}:${e.target.value}`)}>
          {mins.map(mm => <option key={mm} value={mm}>{mm}</option>)}
        </select>
      </div>
    </div>
  )
}

// â”€â”€ Flight section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function FlightSection({ prefs, dest, flightDetails, setFlightDetails }) {
  const [airports,  setAirports]  = useState([])
  const [loading,   setLoading]   = useState(false)
  const [depart,    setDepart]    = useState(flightDetails.outboundDate ? new Date(flightDetails.outboundDate) : null)
  const [ret,       setRet]       = useState(flightDetails.returnDate   ? new Date(flightDetails.returnDate)   : null)
  const [datesOpen, setDatesOpen] = useState(!flightDetails.outboundDate)

  useEffect(() => {
    if (flightDetails.outboundDate) { setDepart(new Date(flightDetails.outboundDate)); setDatesOpen(false) }
    if (flightDetails.returnDate)   setRet(new Date(flightDetails.returnDate))
  }, [flightDetails.outboundDate, flightDetails.returnDate])
  const [selAp, setSelAp] = useState(flightDetails.selectedAirport || null)

  const originSky = (() => {
    const map = { london:'LOND', heathrow:'LHR', gatwick:'LGW', stansted:'STN', luton:'LTN',
      'london city':'LCY', southend:'SEN', manchester:'MAN', birmingham:'BHX', edinburgh:'EDI',
      glasgow:'GLAS', prestwick:'PIK', bristol:'BRS', leeds:'LBA', newcastle:'NCL', liverpool:'LPL',
      cardiff:'CWL', belfast:'BELF', southampton:'SOU', norwich:'NWI', exeter:'EXT',
      'east midlands':'EMA', aberdeen:'ABZ', inverness:'INV', doncaster:'DSA', bournemouth:'BOH',
      teesside:'MME', newquay:'NQY', jersey:'JER', guernsey:'GCI', 'isle of man':'IOM' }
    return map[prefs.startingPoint] || 'LOND'
  })()

  useEffect(() => {
    if (!dest) return
    setLoading(true)
    api.getDestAirports({ dest_city: dest.CITY })
       .then(aps => { setAirports(aps); setSelAp(aps[0] || null) })
       .catch(() => {})
       .finally(() => setLoading(false))
  }, [dest?.CITY])

  const fmt = d => d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : ''
  const yymmdd = d => d ? `${String(d.getFullYear()).slice(2)}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}` : ''

  const skyUrl = (ap) => {
    if (!depart || !ret) return '#'
    const adults = Number(prefs.numAdults) || 2
    const ages = prefs.childrenAges || []
    let url = `https://www.skyscanner.net/transport/flights/${originSky.toLowerCase()}/${(ap.sky||ap.iata||'').toLowerCase()}/${yymmdd(depart)}/${yymmdd(ret)}/?adultsv2=${adults}&cabinclass=economy`
    if (ages.length > 0) {
      url += `&childrenv2=${ages.join('|')}`
    }
    return url
  }

  const saveFlights = () => {
    setFlightDetails(fd => ({
      ...fd,
      confirmed:      true,
      outboundDate:   depart?.toISOString().slice(0,10),
      returnDate:     ret?.toISOString().slice(0,10),
      selectedAirport: selAp,
    }))
  }

  if (!dest) return null

  return (
    <div className="space-y-4">
      {/* Date picker â€” collapsible */}
      <div className="card">
        <button className="w-full flex items-center justify-between" onClick={() => setDatesOpen(o => !o)}>
          <div className="flex items-center gap-3">
            <span>ðŸ“…</span>
            {depart && ret ? (
              <div className="text-left">
                <p className="text-sm font-medium" style={{color:'#f0ede8'}}>
                  {depart.toLocaleDateString('en-GB', {day:'numeric',month:'short'})} â†’ {ret.toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'})}
                </p>
                <p className="text-xs" style={{color:'#7a7870'}}>{Math.round((ret-depart)/86400000)} nights</p>
              </div>
            ) : (
              <p className="text-sm" style={{color:'#7a7870'}}>Select travel dates</p>
            )}
          </div>
          <span className="text-xs" style={{color:'#7a7870'}}>{datesOpen ? 'â–²' : 'â–¼'}</span>
        </button>

        {datesOpen && (
          <div className="mt-4 range-picker-wrap">
            <DatePicker
              selected={depart}
              onChange={(dates) => {
                const [start, end] = dates
                setDepart(start)
                setRet(end)
                if (start && end) setDatesOpen(false)
              }}
              startDate={depart}
              endDate={ret}
              selectsRange
              inline
              monthsShown={2}
              calendarStartDay={1}
              minDate={new Date()}
              fixedHeight
            />
          </div>
        )}
      </div>

      {/* Airport options */}
      {loading && <div className="card"><SherpaSpinner messages={['Finding airportsâ€¦']} /></div>}

      {!loading && airports.map((ap, i) => {
        const legs = ap.transfer_legs || []
        const carLeg = legs.filter(l => ['Car','Taxi'].includes(l.mode))
        const ptLeg  = legs.filter(l => !['Car','Taxi'].includes(l.mode))
        const modeIcon = {Train:'ðŸš†',Metro:'ðŸš‡',Bus:'ðŸšŒ',Taxi:'ðŸš•',Walk:'ðŸš¶',Ferry:'â›´ï¸',Tram:'ðŸšŠ',Shuttle:'ðŸš',Car:'ðŸš—'}

        return (
          <div key={i} className="card-gold">
            <div className="flex items-start justify-between gap-4">
              <div>
                <p className="font-medium text-sage-light">
                  âœˆï¸ {dest.CITY} â†’ {ap.airport_name} ({ap.iata})
                </p>
                <div className="mt-2 space-y-1 text-sm text-slate">
                  {depart && ret && (
                    <p>ðŸ“… {fmt(depart)} â†’ {fmt(ret)} Â· ðŸ‘¤ {prefs.numAdults} adult(s){(prefs.numChildren || 0) > 0 ? ` + ${prefs.numChildren} child(ren)` : ''}</p>
                  )}
                  {ap.flight_time && <p>âœˆï¸ Flight time: approx {ap.flight_time}</p>}
                  {carLeg.length > 0 && (
                    <p>ðŸš— By car/taxi: {carLeg.map(l => `${l.mins} min`).join(' + ')}</p>
                  )}
                  {ptLeg.length > 0 && (
                    <p>
                      ðŸš‡ By public transport: <span className="text-sage font-medium">{ap.transfer_mins} min</span>
                      {' â€” '}{ptLeg.map(l => `${modeIcon[l.mode]||'ðŸšŒ'} ${l.mode} ${l.mins}min`).join(' â†’ ')}
                    </p>
                  )}
                  {!legs.length && ap.transfer_label && (
                    <p>ðŸšŒ Transfer to centre: {ap.transfer_label}</p>
                  )}
                </div>
              </div>
              <a
                href={skyUrl(ap)}
                target="_blank" rel="noopener noreferrer"
                className="btn-primary text-sm whitespace-nowrap shrink-0"
                onClick={() => track('affiliate_click', { partner: 'skyscanner', destination: dest.CITY })}
              >
                Search Skyscanner â†’
              </a>
            </div>
          </div>
        )
      })}

      {/* Airport selector for itinerary */}
      {airports.length > 1 && (
        <div className="card">
          <label className="label">ðŸ›¬ Which airport are you flying into?</label>
          <select className="select" value={selAp?.iata || ''} onChange={e => setSelAp(airports.find(a => a.iata === e.target.value))}>
            {airports.map(ap => (
              <option key={ap.iata} value={ap.iata}>{ap.airport_name} ({ap.iata})</option>
            ))}
          </select>
        </div>
      )}

      {/* Confirm flight times */}
      <div className="card">
        <h3 className="font-medium text-slate mb-3">ðŸ›« Confirm your flight times</h3>
        <p className="text-sm text-slate-3 mb-4">Once booked, enter your times so Sherpa can plan your itinerary around your schedule.</p>
        <div className="grid grid-cols-2 gap-4">
          <TimeSelect label="ðŸ›¬ Arrival time"
            value={flightDetails.arrivalTime}
            onChange={v => setFlightDetails(fd => ({ ...fd, arrivalTime: v }))} />
          <TimeSelect label="ðŸ›« Departure time"
            value={flightDetails.departureTime}
            onChange={v => setFlightDetails(fd => ({ ...fd, departureTime: v }))} />
        </div>
        <button className="btn-primary mt-4 w-full" onClick={saveFlights}>
          âœ… Save flight times
        </button>
        {flightDetails.confirmed && (
          <p className="text-green-400 text-sm mt-2 text-center">âœ“ Flight times saved</p>
        )}
      </div>
    </div>
  )
}

// â”€â”€ Car hire section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function CarHireSection({ prefs, dest, flightDetails, carHire, setCarHire }) {
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    if (carHire.data || !dest || prefs.transportMode.includes('public transport')) return
    setLoading(true)
    api.carHire({
      dest: `${dest.CITY}, ${dest.COUNTRY}`,
      dest_city: dest.CITY,
      trip_type: prefs.tripType,
      depart_date: flightDetails.outboundDate || '',
      return_date: flightDetails.returnDate   || '',
    })
    .then(data => setCarHire(c => ({ ...c, data })))
    .catch(() => {})
    .finally(() => setLoading(false))
  }, [dest?.CITY])

  if (prefs.transportMode.includes('public transport')) return null
  if (!dest) return null

  const ratingLabels = {1:'Not needed',2:'Rarely useful',3:'Moderately useful',4:'Quite important',5:'Essential'}
  const ratingColours= {1:'#2ecc71',2:'#8bc34a',3:'#f1c40f',4:'#e67e22',5:'#e74c3c'}
  const d = carHire.data || {}
  const score = d.rating || 3

  const rcUrl = (() => {
    const dep = flightDetails?.outboundDate
    const ret = flightDetails?.returnDate
    const params = new URLSearchParams({ pickup: dest?.CITY || '' })
    if (dep) params.set('puDate', dep)
    if (ret) params.set('doDate', ret)
    return `https://www.rentalcars.com/en/?${params.toString()}`
  })()

  return (
    <div className="space-y-4">
      {loading && <div className="card"><SherpaSpinner messages={['Checking car hire optionsâ€¦','Comparing rental companiesâ€¦','Reading the reviewsâ€¦']} /></div>}

      {!loading && carHire.data && (
        <>
          {/* 1. Rating card */}
          <div className="card-gold">
            <div className="flex items-center gap-3 mb-3">
              <div className="text-2xl">{'ðŸš—'.repeat(score)}{'â—‹'.repeat(5-score)}</div>
              <div>
                <p className="font-medium" style={{ color: ratingColours[score] }}>{ratingLabels[score]}</p>
                <p className="text-xs text-slate-3">Car hire usefulness for {dest.CITY}</p>
              </div>
            </div>
            <ul className="space-y-1">
              {d.reasons?.map((r,i) => <li key={i} className="text-sm text-slate flex gap-2"><span className="text-sage">â€¢</span>{r}</li>)}
            </ul>
          </div>

          {/* 2. Yes/No toggle */}
          {carHire.confirmed === null && (
            <div className="card text-center">
              <p className="text-sm text-slate mb-3">Will you hire a car for this trip?</p>
              <div className="flex gap-3 justify-center">
                <button className="btn-secondary px-8" onClick={() => setCarHire(c => ({ ...c, confirmed: 'yes' }))}>Yes</button>
                <button className="btn-secondary px-8" onClick={() => setCarHire(c => ({ ...c, confirmed: 'no' }))}>No</button>
              </div>
            </div>
          )}
          {carHire.confirmed !== null && (
            <div className="card text-center">
              <p className="text-slate">{carHire.confirmed === 'yes' ? 'ðŸš— Car hire: Yes' : 'ðŸš‡ Car hire: No'}</p>
              <button className="text-xs text-slate-3 hover:text-sage mt-2 transition-colors"
                onClick={() => setCarHire(c => ({ ...c, confirmed: null }))}>
                â†© Change answer
              </button>
            </div>
          )}

          {/* 3. Rentalcars + recommendations â€” only show when yes confirmed */}
          {carHire.confirmed === 'yes' && (
            <>
              <a href={rcUrl} target="_blank" rel="noopener noreferrer"
                 className="btn-primary block text-center w-full"
                 onClick={() => track('affiliate_click', { partner: 'rentalcars', destination: dest.CITY })}>
                ðŸš— Compare prices on Rentalcars â†’
              </a>

              {d.companies?.length > 0 && (
                <div className="card">
                  <h4 className="text-sm font-semibold text-slate mb-3">âœ… Recommended companies</h4>
                  <div className="space-y-2">
                    {d.companies.map((c,i) => (
                      <div key={i} className="flex items-center justify-between py-2 border-b border-white/8 last:border-0">
                        <div>
                          <p className="text-sm font-medium text-slate">{c.name}</p>
                          <p className="text-xs text-slate-3">{c.highlight}</p>
                        </div>
                        <span className="badge">{c.rating}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {d.avoid?.length > 0 && (
                <div className="card" style={{border:'1px solid rgba(248,113,113,0.2)'}}>
                  <h4 className="text-sm font-semibold text-red-400 mb-2">âš ï¸ Worth avoiding</h4>
                  {d.avoid.map((c,i) => (
                    <div key={i} className="text-sm text-slate-3 flex gap-2 mt-1">
                      <span className="text-red-400">âœ—</span>
                      <span><strong className="text-slate">{c.name}</strong> ({c.rating}) â€” {c.reason}</span>
                    </div>
                  ))}
                </div>
              )}
            </>
          )}
        </>
      )}
    </div>
  )
}

// â”€â”€ Accommodation section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function AccomSection({ prefs, dest, carHire, selectedHotel, setSelectedHotel, flightDetails }) {
  const [tips,    setTips]    = useState(null)
  const [note,    setNote]    = useState('')
  const [loading, setLoading] = useState(false)
  const [noteLoading, setNoteLoading] = useState(false)
  const [hotelInput, setHotelInput]   = useState(selectedHotel)

  const bkUrl = (() => {
    if (!dest) return '#'
    const params = new URLSearchParams({
      ss:           dest.CITY,
      lang:         'en-gb',
      group_adults: Number(prefs.numAdults) || 2,
      no_rooms:     1,
    })
    const numKids = prefs.numChildren || 0
    if (numKids > 0) {
      params.set('group_children', numKids)
      ;(prefs.childrenAges || []).forEach(age => params.append('age', age))
    }
    if (flightDetails?.outboundDate) params.set('checkin',  flightDetails.outboundDate)
    if (flightDetails?.returnDate)   params.set('checkout', flightDetails.returnDate)
    return `https://www.booking.com/searchresults.html?${params.toString()}`
  })()

  useEffect(() => {
    if (!dest || tips) return
    setLoading(true)
    api.accomTips({
      dest: `${dest.CITY}, ${dest.COUNTRY}`,
      dest_city: dest.CITY,
      budget: prefs.budget,
      group_type: prefs.groupType,
      trip_type: prefs.tripType,
      priorities: prefs.priorities,
      car_hire: carHire.confirmed,
    })
    .then(setTips)
    .catch(() => {})
    .finally(() => setLoading(false))
  }, [dest?.CITY, carHire.confirmed])

  const lookupHotel = async (name) => {
    if (!name.trim() || !dest) return
    setNoteLoading(true)
    try {
      const d = await api.hotelNote({
        hotel: name,
        dest_city: dest.CITY,
        dest: `${dest.CITY}, ${dest.COUNTRY}`,
        group_type: prefs.groupType,
        car_hire: carHire.confirmed,
        priorities: prefs.priorities,
      })
      setNote(d.note)
    } catch {}
    finally { setNoteLoading(false) }
  }

  if (!dest) return null

  return (
    <div className="space-y-4">
      <a href={bkUrl} target="_blank" rel="noopener noreferrer" className="btn-primary block text-center w-full"
         onClick={() => track('affiliate_click', { partner: 'booking', destination: dest.CITY })}>
        ðŸ¨ Explore hotels on Booking.com â†’
      </a>

      {loading && <div className="card"><SherpaSpinner messages={['Scouting the best areasâ€¦','Checking transport linksâ€¦','Finding hidden gemsâ€¦']} /></div>}

      {!loading && tips && (
        <>
          {tips.areas?.length > 0 && (
            <div className="card">
              <h4 className="text-sm font-semibold text-slate mb-3">ðŸ“ Best areas to stay</h4>
              <div className="space-y-3">
                {tips.areas.map((a,i) => (
                  <div key={i} className="border-l-2 border-sage/40 pl-3">
                    <div className="flex items-baseline justify-between">
                      <p className="font-medium text-slate">{a.name}</p>
                      <span className="text-xs text-slate-3">{a.price_range}</span>
                    </div>
                    <p className="text-xs text-sage italic">{a.vibe}</p>
                    <p className="text-xs text-slate-3 mt-0.5">{a.best_for}</p>
                    {a.tip && <p className="text-xs text-slate mt-1">ðŸ’¡ {a.tip}</p>}
                  </div>
                ))}
              </div>
            </div>
          )}

          {tips.booking_tips?.length > 0 && (
            <div className="card">
              <h4 className="text-sm font-semibold text-slate mb-2">ðŸ’¡ Booking tips</h4>
              <ul className="space-y-1.5">
                {tips.booking_tips.map((t,i) => <li key={i} className="text-sm text-slate flex gap-2"><span className="text-sage">â€¢</span>{t}</li>)}
              </ul>
              {tips.avoid && <p className="text-sm text-red-400/80 mt-3 flex gap-2"><span>âš ï¸</span>{tips.avoid}</p>}
            </div>
          )}
        </>
      )}

      {/* Hotel input */}
      <div className="card">
        <label className="label">ðŸ¨ Where are you staying?</label>
        <div className="flex gap-2">
          <input className="input flex-1" placeholder="Enter hotel or areaâ€¦"
            value={hotelInput}
            onChange={e => setHotelInput(e.target.value)}
            onKeyDown={e => { if (e.key === 'Enter') { setSelectedHotel(hotelInput); lookupHotel(hotelInput) }}}
          />
          <button
            className="btn-secondary px-3 text-sm whitespace-nowrap"
            onClick={() => { setSelectedHotel(hotelInput); lookupHotel(hotelInput) }}
            disabled={!hotelInput.trim() || noteLoading}
          >
            {noteLoading ? 'â€¦' : 'Look up'}
          </button>
        </div>
        {selectedHotel && !noteLoading && !note && (
          <p className="text-xs text-slate-3 mt-1.5">âœ“ {selectedHotel}</p>
        )}
        {noteLoading && <p className="text-sm text-slate-3 mt-2 italic">Looking up your accommodationâ€¦</p>}
        {note && !noteLoading && (
          <div className="note mt-3">{note}</div>
        )}
      </div>
    </div>
  )
}

// â”€â”€ Itinerary section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function ItinerarySection({ prefs, dest, flightDetails, carHire, selectedHotel, itinerary, setItinerary, user, userProfile, onSaveTrip, externalShowModal, setExternalShowModal, onRequireAuth, onRequestFeedback }) {
  const [loading,    setLoading]    = useState(false)
  const [feedback,   setFeedback]   = useState('')
  const [tweaking,   setTweaking]   = useState(false)
  const [activities,        setActivities]        = useState(null)
  const [activitiesLoading, setActivitiesLoading] = useState(false)
  const [mapPins,    setMapPins]    = useState(null)
  const [showMap,    setShowMap]    = useState(false)
  const [saving,     setSaving]     = useState(false)
  const [saved,      setSaved]      = useState(false)
  const [showModal,  setShowModal]  = useState(false)

  const { remaining: buildRemaining, limitReached: buildLimitReached, increment: incrementBuild } = useUsageLimit('itinerary')

  const isModalOpen = showModal || !!externalShowModal
  const closeModal  = () => { setShowModal(false); if (setExternalShowModal) setExternalShowModal(false) }

  const buildItinerary = async () => {
    if (!dest) return

    if (!user && buildLimitReached) {
      onRequireAuth()
      return
    }

    setLoading(true)
    setItinerary('')
    try {
      const ap = flightDetails.selectedAirport
      await api.itinerary({
        dest: `${dest.CITY}, ${dest.COUNTRY}`,
        dest_city: dest.CITY,
        origin_city: prefs.startingPoint,
        starting_point: prefs.startingPoint,
        budget: prefs.budget,
        group_type: prefs.groupType,
        trip_type: prefs.tripType,
        transport_mode: prefs.transportMode,
        priorities: prefs.priorities,
        specific_depart: flightDetails.outboundDate,
        specific_return: flightDetails.returnDate,
        num_adults: Number(prefs.numAdults),
        selected_hotel: selectedHotel,
        car_hire_confirmed: carHire.confirmed,
        arrival_time: flightDetails.arrivalTime || '11:00',
        departure_time: flightDetails.departureTime || '14:00',
        arrival_airport: ap ? `${ap.airport_name} (${ap.iata})` : dest.CITY,
        transfer_label: ap?.transfer_label || '30 min',
        user_profile: userProfile || null,
      }, (text) => setItinerary(text))
    } catch (e) {
      setItinerary('Something went wrong. Please try again.')
    } finally {
      setLoading(false)
      setShowModal(true)
      track('itinerary_build', { destination: dest.CITY, country: dest.COUNTRY })
      if (!user) incrementBuild()
    }
  }

  const handleTweak = async () => {
    if (!feedback.trim() || !itinerary) return
    setTweaking(true)
    try {
      await api.tweak({
        dest: `${dest.CITY}, ${dest.COUNTRY}`,
        dest_city: dest.CITY,
        itinerary,
        feedback,
        origin_city: prefs.startingPoint,
      }, (text) => setItinerary(text))
      setFeedback('')
    } catch {}
    finally { setTweaking(false) }
  }

  const fetchActivities = async () => {
    if (!itinerary) { console.warn('fetchActivities: no itinerary'); return }
    setActivitiesLoading(true)
    try {
      const d = await api.activities({ dest_city: dest.CITY, itinerary })
      console.log('activities response:', d)
      setActivities({ gyg: d.gyg || [], direct: d.direct || [] })
    } catch (err) {
      console.error('fetchActivities error:', err)
      setActivities({ gyg: [], direct: [] })
    } finally {
      setActivitiesLoading(false)
    }
  }

  const fetchMapPins = async () => {
    if (!itinerary) return
    try {
      const d = await api.mapPins({ itinerary, dest_city: dest.CITY })
      setMapPins(d.locations || [])
      setShowMap(true)
    } catch {}
  }

  const handleSave = async () => {
    if (!user || !itinerary) return
    setSaving(true)
    try {
      await saveTrip({
        destination:   dest.CITY,
        country:       dest.COUNTRY,
        emoji:         dest.EMOJI,
        itinerary,
        flightDetails,
        carHire,
        hotel:         selectedHotel,
        prefs,
      })
      setSaved(true)
      setTimeout(() => setSaved(false), 3000)
      track('trip_saved', { destination: dest.CITY, country: dest.COUNTRY })
      if (onSaveTrip) onSaveTrip()
    } catch (e) {
      alert('Could not save trip: ' + e.message)
    } finally {
      setSaving(false)
    }
  }

  if (!dest) return null

  const isPublicTransport = prefs.transportMode.includes('public transport')
  const flightsDone  = !!(flightDetails?.confirmed && flightDetails?.outboundDate && flightDetails?.returnDate)
  const carHireDone  = isPublicTransport || !!(carHire?.confirmed !== null && carHire?.confirmed !== undefined)
  const hotelDone    = !!(selectedHotel?.trim())
  const allDone      = flightsDone && carHireDone && hotelDone

  return (
    <div className="space-y-4">

      {/* Checklist â€” only show if not all done */}
      {!allDone && (
        <div className="rounded-xl p-4 space-y-2" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.15)'}}>
          <p className="text-xs font-semibold uppercase tracking-widest mb-3" style={{color:'#7a7870'}}>Complete to build your plan</p>
          {[
            { done: flightsDone, label: 'Confirm your flight dates' },
            ...(!isPublicTransport ? [{ done: carHireDone, label: 'Choose car hire â€” yes or no' }] : []),
            { done: hotelDone,   label: 'Enter where you\'re staying' },
          ].map(({ done, label }) => (
            <div key={label} className="flex items-center gap-2.5">
              <div className="w-4 h-4 rounded-full flex items-center justify-center shrink-0"
                   style={{background: done ? 'rgba(127,182,133,0.2)' : 'rgba(255,255,255,0.05)',
                           border: `1px solid ${done ? '#7fb685' : 'rgba(255,255,255,0.1)'}`}}>
                {done && <span className="text-xs" style={{color:'#7fb685'}}>âœ“</span>}
              </div>
              <p className="text-sm" style={{color: done ? '#7a7870' : '#c8c4bc',
                                             textDecoration: done ? 'line-through' : 'none'}}>
                {label}
              </p>
            </div>
          ))}
        </div>
      )}

      {/* Build button */}
      <button
        className="btn-primary w-full py-3 text-base"
        onClick={buildItinerary}
        disabled={loading || !allDone}
        style={!allDone ? {opacity: 0.35, cursor: 'not-allowed'} : {}}
      >
        {loading ? 'â³ Building your planâ€¦' : `ðŸ—“ï¸ ${itinerary ? 'Rebuild' : 'Build'} My Full Plan`}
      </button>

      {/* Usage remaining hint for non-signed-in users */}
      {!user && !buildLimitReached && (
        <p className="text-xs text-center" style={{color:'#7a7870'}}>
          {buildRemaining} free {buildRemaining === 1 ? 'build' : 'builds'} remaining â€” <button className="underline hover:text-sage transition-colors" onClick={onRequireAuth}>sign in</button> for unlimited
        </p>
      )}
      {!user && buildLimitReached && (
        <div className="text-center p-3 rounded-lg" style={{background:'rgba(127,182,133,0.08)', border:'1px solid rgba(127,182,133,0.2)'}}>
          <p className="text-sm" style={{color:'#c8c4bc'}}>You've used your free builds</p>
          <button className="text-sm font-medium mt-1 underline transition-colors" style={{color:'#7fb685'}} onClick={onRequireAuth}>
            Sign in for unlimited access
          </button>
        </div>
      )}

      {/* Loading spinner */}
      {loading && (
        <div className="card">
          <SherpaSpinner messages={[
            'Plotting your routeâ€¦',
            'Scouting the best restaurantsâ€¦',
            'Checking the weatherâ€¦',
            'Finding hidden gemsâ€¦',
            'Timing your days perfectlyâ€¦',
            'Almost readyâ€¦',
          ]} />
        </div>
      )}

      {/* Open modal button if itinerary already exists */}
      {itinerary && !loading && (
        <button
          className="btn-secondary w-full text-sm"
          onClick={() => setShowModal(true)}
        >
          ðŸ“– View Itinerary
        </button>
      )}

      {/* Itinerary modal */}
      {isModalOpen && (
        <ItineraryModal
          itinerary={itinerary}
          dest={dest}
          destData={dest}
          prefs={prefs}
          flightDetails={flightDetails}
          selectedHotel={selectedHotel}
          feedback={feedback}
          setFeedback={setFeedback}
          onTweak={handleTweak}
          tweaking={tweaking}
          onSave={handleSave}
          saving={saving}
          saved={saved}
          user={user}
          activities={activities}
          fetchActivities={fetchActivities}
          activitiesLoading={activitiesLoading}
          onRequestFeedback={onRequestFeedback}
          skyscannerUrl={flightDetails.confirmed && flightDetails.selectedAirport
            ? (() => {
                const ap = flightDetails.selectedAirport
                const depart = flightDetails.outboundDate
                const ret    = flightDetails.returnDate
                const yymmdd = (iso) => iso ? iso.replace(/-/g,'').slice(2) : ''
                const originSky = prefs.startingPoint?.match(/\(([A-Z]{3})\)/)?.[1]?.toLowerCase() || 'lon'
                if (!depart || !ret) return '#'
                const adults = Number(prefs.numAdults) || 2
                const ages = prefs.childrenAges || []
                let url = `https://www.skyscanner.net/transport/flights/${originSky}/${(ap.sky||ap.iata||'').toLowerCase()}/${yymmdd(depart)}/${yymmdd(ret)}/?adultsv2=${adults}&cabinclass=economy`
                if (ages.length > 0) {
                  url += `&childrenv2=${ages.join('|')}`
                }
                return url
              })()
            : null}
          bookingUrl={(() => {
            if (!dest) return null
            const params = new URLSearchParams({ ss: dest.CITY, lang: 'en-gb', group_adults: Number(prefs.numAdults) || 2, no_rooms: 1 })
            const numKids = prefs.numChildren || 0
            if (numKids > 0) {
              params.set('group_children', numKids)
              ;(prefs.childrenAges || []).forEach(age => params.append('age', age))
            }
            if (flightDetails?.outboundDate) params.set('checkin', flightDetails.outboundDate)
            if (flightDetails?.returnDate)   params.set('checkout', flightDetails.returnDate)
            return `https://www.booking.com/searchresults.html?${params.toString()}`
          })()}
          carHireUrl={(() => {
            const dep = flightDetails?.outboundDate
            const ret = flightDetails?.returnDate
            const params = new URLSearchParams({ pickup: dest?.CITY || '' })
            if (dep) params.set('puDate', dep)
            if (ret) params.set('doDate', ret)
            return `https://www.rentalcars.com/en/?${params.toString()}`
          })()}
          onClose={closeModal}
        />
      )}

      {/* Keep old action buttons outside modal for map */}
      {itinerary && !loading && (
        <>
          {showMap && mapPins !== null && (
            <div className="card">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-semibold text-slate">ðŸ—ºï¸ Places in your itinerary</h4>
                <button className="text-xs text-slate-3 hover:text-sage" onClick={() => setShowMap(false)}>âœ•</button>
              </div>
              <div className="space-y-2 max-h-80 overflow-y-auto">
                {mapPins.map((p,i) => (
                  <div key={i} className="flex items-start gap-3">
                    <span className="text-lg shrink-0">{
                      {Restaurant:'ðŸ½ï¸',Cafe:'â˜•',Bar:'ðŸ¸',Museum:'ðŸ›ï¸',
                       Attraction:'â­',Market:'ðŸ›’',Park:'ðŸŒ¿',Viewpoint:'ðŸ‘ï¸',
                       Beach:'ðŸ–ï¸',Hotel:'ðŸ¨'}[p.type] || 'ðŸ“'
                    }</span>
                    <div>
                      <p className="text-sm font-medium text-slate">{p.name}</p>
                      {p.description && <p className="text-xs text-slate-3">{p.description}</p>}
                    </div>
                  </div>
                ))}
              </div>
              <a
                href={`https://www.google.com/maps/search/${encodeURIComponent(dest.CITY + ' ' + mapPins.slice(0,3).map(p=>p.name).join(' '))}`}
                target="_blank" rel="noopener noreferrer"
                className="btn-secondary block text-center text-sm mt-3"
              >
                Open in Google Maps â†’
              </a>
            </div>
          )}
        </>
      )}
    </div>
  )
}

// â”€â”€ Main BookTab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export default function BookTab({
  prefs, setPrefs,
  chosenDest, setChosenDest,
  itinerary, setItinerary,
  flightDetails, setFlightDetails,
  carHire, setCarHire,
  selectedHotel, setSelectedHotel,
  user, userProfile, onSaveTrip,
  externalShowModal, setExternalShowModal,
  onRequireAuth,
  onRequestFeedback,
}) {
  const [destInput, setDestInput] = useState(
    chosenDest ? `${chosenDest.CITY}, ${chosenDest.COUNTRY}` : ''
  )

  const handleManualDest = () => {
    const parts = destInput.split(',')
    setChosenDest({ CITY: parts[0]?.trim(), COUNTRY: parts[1]?.trim() || '', EMOJI: 'ðŸŒ' })
  }

  const dest = chosenDest

  return (
    <div className="space-y-8">
      {/* Destination */}
      <Section title="ðŸŒ Destination">
        {dest ? (
          <div className="card-gold flex items-center justify-between">
            <div>
              <p className="text-slate-3 text-xs uppercase tracking-wider">Your destination</p>
              <p className="font-serif text-xl text-sage mt-0.5">
                {dest.EMOJI} {dest.CITY}{dest.COUNTRY ? `, ${dest.COUNTRY}` : ''}
              </p>
            </div>
            <button className="btn-secondary text-sm" onClick={() => { setChosenDest(null); setDestInput('') }}>
              Change
            </button>
          </div>
        ) : (
          <div className="card space-y-3">
            <div className="flex gap-2">
              <input
                className="input flex-1"
                placeholder="e.g. Lisbon, Portugal"
                value={destInput}
                onChange={e => setDestInput(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && handleManualDest()}
              />
              <button className="btn-primary px-5" onClick={handleManualDest}>
                Set â†’
              </button>
            </div>
            <p className="text-xs text-slate-3">Or go to âœ¨ Inspire to get personalised suggestions.</p>
          </div>
        )}
      </Section>

      <div className="divider" />

      {/* Flights */}
      <Section title="âœˆï¸ Find Flights">
        <FlightSection
          prefs={prefs}
          dest={dest}
          flightDetails={flightDetails}
          setFlightDetails={setFlightDetails}
        />
      </Section>

      <div className="divider" />

      {/* Car hire â€” only show when NOT public transport */}
      {!prefs.transportMode.includes('public transport') && (
        <>
          <Section title="ðŸš— Car Hire">
            <CarHireSection
              prefs={prefs}
              dest={dest}
              flightDetails={flightDetails}
              carHire={carHire}
              setCarHire={setCarHire}
            />
          </Section>
          <div className="divider" />
        </>
      )}

      {/* Accommodation */}
      <Section title="ðŸ¨ Where to Stay">
        <AccomSection
          prefs={prefs}
          dest={dest}
          carHire={carHire}
          selectedHotel={selectedHotel}
          setSelectedHotel={setSelectedHotel}
          flightDetails={flightDetails}
        />
      </Section>

      <div className="divider" />

      {/* Itinerary */}
      <Section title="ðŸ—“ï¸ Your Itinerary">
        <ItinerarySection
          prefs={prefs}
          dest={dest}
          flightDetails={flightDetails}
          carHire={carHire}
          selectedHotel={selectedHotel}
          itinerary={itinerary}
          setItinerary={setItinerary}
          user={user}
          userProfile={userProfile}
          onSaveTrip={onSaveTrip}
          externalShowModal={externalShowModal}
          setExternalShowModal={setExternalShowModal}
          onRequireAuth={onRequireAuth}
          onRequestFeedback={onRequestFeedback}
        />
      </Section>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\FeedbackModal.jsx =====
import { useState } from 'react'
import { supabase } from '../utils/supabase'

const TYPES = [
  { value: 'bug',     label: 'ðŸ› Bug report',      desc: 'Something broken or not working right' },
  { value: 'feature', label: 'ðŸ’¡ Feature request',  desc: 'Something you\'d love to see added' },
  { value: 'general', label: 'ðŸ’¬ General feedback',  desc: 'Anything else on your mind' },
]

export default function FeedbackModal({ onClose, user }) {
  const [type, setType]       = useState('')
  const [message, setMessage] = useState('')
  const [email, setEmail]     = useState('')
  const [sending, setSending] = useState(false)
  const [sent, setSent]       = useState(false)
  const [error, setError]     = useState('')

  const handleSubmit = async () => {
    if (!type || !message.trim()) return
    setSending(true)
    setError('')
    try {
      const { error: err } = await supabase.from('feedback').insert({
        type,
        message: message.trim(),
        email: user?.email || email.trim() || null,
        user_id: user?.id || null,
      })
      if (err) throw err
      setSent(true)
    } catch (e) {
      setError('Could not send feedback. Please try again.')
    } finally {
      setSending(false)
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
      <div className="card-gold w-full max-w-md mx-4 relative">
        <button
          className="absolute top-3 right-3 text-slate-3 hover:text-sage transition-colors text-lg"
          onClick={onClose}
        >âœ•</button>

        {sent ? (
          <div className="text-center py-4">
            <p className="text-3xl mb-3">ðŸŽ‰</p>
            <h2 className="font-serif text-xl text-sage-light mb-2">Thanks for your feedback!</h2>
            <p className="text-sm text-slate-3 mb-4">
              We read every message and it genuinely helps us make Sherpa better.
            </p>
            <button className="btn-primary px-8" onClick={onClose}>Done</button>
          </div>
        ) : (
          <>
            <h2 className="font-serif text-xl text-sage-light mb-1">Help us improve Sherpa</h2>
            <p className="text-sm text-slate-3 mb-5">
              Sherpa is brand new and we're actively building. Found a bug? Want a feature? 
              Your feedback shapes what we work on next.
            </p>

            <div className="space-y-4">
              {/* Type selection */}
              <div>
                <label className="label">What kind of feedback?</label>
                <div className="space-y-2">
                  {TYPES.map(t => (
                    <button
                      key={t.value}
                      onClick={() => setType(t.value)}
                      className="w-full text-left px-3 py-2.5 rounded-lg transition-all"
                      style={{
                        background: type === t.value ? 'rgba(127,182,133,0.12)' : 'transparent',
                        border: `1px solid ${type === t.value ? 'rgba(127,182,133,0.4)' : 'rgba(255,255,255,0.08)'}`,
                      }}
                    >
                      <p className="text-sm font-medium" style={{color: type === t.value ? '#a8c9ad' : '#c8c4bc'}}>
                        {t.label}
                      </p>
                      <p className="text-xs" style={{color:'#7a7870'}}>{t.desc}</p>
                    </button>
                  ))}
                </div>
              </div>

              {/* Message */}
              <div>
                <label className="label">Tell us more</label>
                <textarea
                  className="input w-full"
                  rows={4}
                  placeholder={
                    type === 'bug' ? 'What happened? What did you expect to happen?'
                    : type === 'feature' ? 'What would you like Sherpa to do?'
                    : 'What\'s on your mind?'
                  }
                  value={message}
                  onChange={e => setMessage(e.target.value)}
                />
              </div>

              {/* Email â€” only show if not signed in */}
              {!user && (
                <div>
                  <label className="label">Email <span className="normal-case font-normal text-slate-3">(optional, if you'd like a reply)</span></label>
                  <input
                    className="input w-full"
                    type="email"
                    placeholder="you@example.com"
                    value={email}
                    onChange={e => setEmail(e.target.value)}
                  />
                </div>
              )}

              {error && (
                <p className="text-red-400 text-sm">{error}</p>
              )}

              <button
                className="btn-primary w-full"
                onClick={handleSubmit}
                disabled={sending || !type || !message.trim()}
              >
                {sending ? 'Sending...' : 'Send feedback'}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\InspireTab.jsx =====
import { useState, useEffect } from 'react'
import { api } from '../utils/api'
import SherpaSpinner from './SherpaSpinner'
import DatePicker from 'react-datepicker'
import 'react-datepicker/dist/react-datepicker.css'
import { useUsageLimit } from '../hooks/useUsageLimit'
import { track } from '../utils/analytics'

const MONTHS = ['January','February','March','April','May','June',
                'July','August','September','October','November','December']
const BUDGETS = ['Â£ â€” Budget', 'Â£Â£ â€” Mid-range', 'Â£Â£Â£ â€” Luxury']
const GROUPS  = ['Solo', 'Couple', 'Family', 'Group of friends', 'Group with kids']
const TRIPS   = ['City Break', 'Beach', 'Culture & History', 'Adventure', 'Food & Drink',
                 'Nature & Hiking', 'Relaxation', 'Ski', 'Festivals & Events']
const TRANSPORT = [
  { value: 'willing to rent',   label: 'ðŸš— Open to car hire' },
  { value: 'public transport',  label: 'ðŸš‡ Public transport only' },
]

function getFirstThursdayToSunday(monthName) {
  const months = ['January','February','March','April','May','June',
                  'July','August','September','October','November','December']
  const mIdx = months.indexOf(monthName)
  if (mIdx < 0) return { depart: null, ret: null }

  const now = new Date()
  const year = now.getFullYear()
  const useYear = mIdx < now.getMonth() ? year + 1 : year

  // Find first Thursday (day 4) of the month
  const d = new Date(useYear, mIdx, 1)
  while (d.getDay() !== 4) d.setDate(d.getDate() + 1)

  const sunday = new Date(d)
  sunday.setDate(sunday.getDate() + 3)

  const pad = n => String(n).padStart(2, '0')
  return {
    depart: `${useYear}-${pad(mIdx + 1)}-${pad(d.getDate())}`,
    ret: `${useYear}-${pad(mIdx + 1)}-${pad(sunday.getDate())}`,
  }
}

// Airport coordinates for nearest-airport detection
const AIRPORT_COORDS = [
  { value: 'london',        lat: 51.509,  lon: -0.118  },
  { value: 'manchester',    lat: 53.365,  lon: -2.273  },
  { value: 'birmingham',    lat: 52.454,  lon: -1.748  },
  { value: 'edinburgh',     lat: 55.950,  lon: -3.372  },
  { value: 'glasgow',       lat: 55.872,  lon: -4.433  },
  { value: 'bristol',       lat: 51.383,  lon: -2.719  },
  { value: 'leeds',         lat: 53.865,  lon: -1.660  },
  { value: 'newcastle',     lat: 55.038,  lon: -1.692  },
  { value: 'liverpool',     lat: 53.334,  lon: -2.850  },
  { value: 'belfast',       lat: 54.658,  lon: -6.216  },
  { value: 'cardiff',       lat: 51.397,  lon: -3.343  },
  { value: 'southampton',   lat: 50.950,  lon: -1.357  },
  { value: 'aberdeen',      lat: 57.202,  lon: -2.198  },
  { value: 'inverness',     lat: 57.543,  lon: -4.048  },
  { value: 'east midlands', lat: 52.831,  lon: -1.328  },
  { value: 'exeter',        lat: 50.734,  lon: -3.414  },
  { value: 'norwich',       lat: 52.676,  lon:  1.282  },
  { value: 'bournemouth',   lat: 50.780,  lon: -1.842  },
  { value: 'doncaster',     lat: 53.475,  lon: -1.011  },
  { value: 'newquay',       lat: 50.440,  lon: -4.995  },
  { value: 'teesside',      lat: 54.509,  lon: -1.430  },
  { value: 'jersey',        lat: 49.208,  lon: -2.196  },
  { value: 'guernsey',      lat: 49.435,  lon: -2.602  },
  { value: 'isle of man',   lat: 54.083,  lon: -4.624  },
]

function getNearestAirport(lat, lon) {
  let nearest = AIRPORT_COORDS[0]
  let minDist = Infinity
  for (const ap of AIRPORT_COORDS) {
    const d = Math.hypot(ap.lat - lat, ap.lon - lon)
    if (d < minDist) { minDist = d; nearest = ap }
  }
  return nearest.value
}

// UK airports list for the dropdown
const UK_AIRPORTS = [
  { label: 'London â€” all airports (LHR/LGW/STN/LTN/LCY)', value: 'london' },
  { label: 'London City (LCY)',                             value: 'london city' },
  { label: 'London Gatwick (LGW)',                          value: 'gatwick' },
  { label: 'London Heathrow (LHR)',                         value: 'heathrow' },
  { label: 'London Luton (LTN)',                            value: 'luton' },
  { label: 'London Southend (SEN)',                         value: 'southend' },
  { label: 'London Stansted (STN)',                         value: 'stansted' },
  { label: 'Aberdeen (ABZ)',                                value: 'aberdeen' },
  { label: 'Belfast â€” all airports (BFS/BHD)',              value: 'belfast' },
  { label: 'Birmingham (BHX)',                              value: 'birmingham' },
  { label: 'Bournemouth (BOH)',                             value: 'bournemouth' },
  { label: 'Bristol (BRS)',                                 value: 'bristol' },
  { label: 'Cardiff (CWL)',                                 value: 'cardiff' },
  { label: 'Doncaster Sheffield (DSA)',                     value: 'doncaster' },
  { label: 'East Midlands (EMA)',                           value: 'east midlands' },
  { label: 'Edinburgh (EDI)',                               value: 'edinburgh' },
  { label: 'Exeter (EXT)',                                  value: 'exeter' },
  { label: 'Glasgow â€” all airports (GLA/PIK)',              value: 'glasgow' },
  { label: 'Glasgow Prestwick (PIK)',                       value: 'prestwick' },
  { label: 'Guernsey (GCI)',                                value: 'guernsey' },
  { label: 'Inverness (INV)',                               value: 'inverness' },
  { label: 'Isle of Man (IOM)',                             value: 'isle of man' },
  { label: 'Jersey (JER)',                                  value: 'jersey' },
  { label: 'Leeds Bradford (LBA)',                          value: 'leeds' },
  { label: 'Liverpool (LPL)',                               value: 'liverpool' },
  { label: 'Manchester (MAN)',                              value: 'manchester' },
  { label: 'Newcastle (NCL)',                               value: 'newcastle' },
  { label: 'Newquay (NQY)',                                 value: 'newquay' },
  { label: 'Norwich (NWI)',                                 value: 'norwich' },
  { label: 'Southampton (SOU)',                             value: 'southampton' },
  { label: 'Teesside / Durham (MME)',                       value: 'teesside' },
]

function AirportSelect({ value, onChange }) {
  const [search, setSearch] = useState('')
  const [open, setOpen] = useState(false)
  const selected = UK_AIRPORTS.find(a => a.value === value)
  const filtered = UK_AIRPORTS.filter(a =>
    a.label.toLowerCase().includes(search.toLowerCase())
  )
  return (
    <div className="relative">
      <div
        className="input flex items-center justify-between cursor-pointer"
        onClick={() => setOpen(o => !o)}
      >
        <span className={selected ? 'text-slate' : 'text-slate-3'}>
          {selected ? selected.label : 'Select departure airportâ€¦'}
        </span>
        <span className="text-slate-3 text-xs">â–¼</span>
      </div>
      {open && (
        <div className="absolute z-50 mt-1 w-full bg-navy-2 border border-white/10 rounded-xl shadow-xl overflow-hidden">
          <div className="p-2 border-b border-white/8">
            <input
              className="input text-sm"
              placeholder="Type to searchâ€¦"
              value={search}
              onChange={e => setSearch(e.target.value)}
              autoFocus
            />
          </div>
          <div className="max-h-56 overflow-y-auto">
            {filtered.map(a => (
              <div
                key={a.value}
                className={`px-4 py-2.5 text-sm cursor-pointer hover:bg-sage/10 hover:text-sage transition-colors
                  ${a.value === value ? 'text-sage bg-sage/5' : 'text-slate'}`}
                onClick={() => { onChange(a.value); setSearch(''); setOpen(false) }}
              >
                {a.label}
              </div>
            ))}
            {filtered.length === 0 && (
              <div className="px-4 py-3 text-sm text-slate-3">No airports found</div>
            )}
          </div>
        </div>
      )}
    </div>
  )
}

function DestCard({ dest, onChoose }) {
  const [expanded, setExpanded] = useState(false)
  const [photo,    setPhoto]    = useState(null)

  useEffect(() => {
    api.photo(`${dest.CITY} ${dest.COUNTRY} travel`)
      .then(p => { if (p.url) setPhoto(p) })
      .catch(() => {})
  }, [dest.CITY])

  return (
    <div className="card-gold hover:border-sage/60 transition-colors overflow-hidden">
      {/* Hero photo */}
      {photo && (
        <div className="relative -mx-5 -mt-5 mb-4 h-44 overflow-hidden">
          <img
            src={photo.url}
            alt={dest.CITY}
            className="w-full h-full object-cover"
            style={{ filter: 'brightness(0.85)' }}
          />
          <div className="absolute inset-0" style={{background:'linear-gradient(to bottom, transparent 50%, #1a2020 100%)'}} />
          <div className="absolute bottom-3 left-4 flex items-center gap-2">
            <span className="text-2xl">{dest.EMOJI}</span>
            <div>
              <h3 className="font-serif text-xl" style={{color:'#f0ede8'}}>{dest.CITY}</h3>
              <p className="text-xs uppercase tracking-wider" style={{color:'rgba(240,237,232,0.6)'}}>{dest.COUNTRY}</p>
            </div>
          </div>
          {dest.BEST_FOR && (
            <div className="absolute top-3 right-3">
              <span className="badge">{dest.BEST_FOR}</span>
            </div>
          )}
        </div>
      )}

      {/* No photo fallback header */}
      {!photo && (
        <div className="flex items-start justify-between gap-4 mb-3">
          <div className="flex items-center gap-2">
            <span className="text-2xl">{dest.EMOJI}</span>
            <div>
              <h3 className="font-serif text-xl text-sage-light">{dest.CITY}</h3>
              <p className="text-xs text-slate-3 uppercase tracking-wider">{dest.COUNTRY}</p>
            </div>
          </div>
          {dest.BEST_FOR && <span className="badge shrink-0">{dest.BEST_FOR}</span>}
        </div>
      )}

      <p className="text-sm text-slate italic mb-4">"{dest.TAGLINE}"</p>

      <div className="grid grid-cols-2 gap-3 mt-4 text-sm">
        {dest.FLIGHT && (
          <div>
            <p className="section-label">âœˆï¸ Flight</p>
            <p className="text-slate">{dest.FLIGHT}</p>
          </div>
        )}
        {dest.WEATHER && (
          <div>
            <p className="section-label">ðŸŒ¤ Weather</p>
            <p className="text-slate">{dest.WEATHER}</p>
          </div>
        )}
      </div>

      {dest.highlights?.length > 0 && (
        <ul className="mt-3 space-y-1">
          {dest.highlights.map((h, i) => (
            <li key={i} className="text-sm text-slate flex gap-2">
              <span className="text-sage shrink-0">â€¢</span>{h}
            </li>
          ))}
        </ul>
      )}

      {dest.DISH && (
        <p className="mt-3 text-sm text-slate-3 italic">ðŸ´ Must try: <span className="text-slate">{dest.DISH}</span></p>
      )}

      {/* Cost guide toggle */}
      {dest.cost_guide?.length > 0 && (
        <div className="mt-3">
          <button
            className="text-xs text-sage hover:text-sage-light transition-colors"
            onClick={() => setExpanded(e => !e)}
          >
            {expanded ? 'â–² Hide' : 'â–¼ Show'} cost guide
          </button>
          {expanded && (
            <div className="mt-2 space-y-1 border-t border-white/8 pt-2">
              {dest.cost_guide.map((line, i) => (
                <p key={i} className="text-xs text-slate" dangerouslySetInnerHTML={{
                  __html: line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-sage-light">$1</strong>')
                }} />
              ))}
            </div>
          )}
        </div>
      )}

      <div className="mt-4 pt-3 border-t border-white/8">
        <button className="btn-primary w-full" onClick={() => onChoose(dest)}>
          Plan this trip â†’
        </button>
      </div>
    </div>
  )
}

export default function InspireTab({ prefs, setPrefs, inspireResults, setInspireResults, chosenDest, setChosenDest, onBook, user, onRequireAuth }) {
  const [loading, setLoading] = useState(false)
  const [error, setError]     = useState('')
  const [prefsOpen, setPrefsOpen] = useState(!inspireResults.length)
  const [dateMode, setDateMode]   = useState('specific')
  const [destPref, setDestPref]   = useState('')
  const [geoStatus, setGeoStatus] = useState('') // 'detecting' | 'found' | 'denied' | ''

  const { remaining: inspireRemaining, limitReached: inspireLimitReached, increment: incrementInspire } = useUsageLimit('inspire')

  // Auto-detect nearest airport on first load (only if no airport already saved)
  useEffect(() => {
    if (prefs.startingPoint) return // already set, don't override
    if (!navigator.geolocation) return
    setGeoStatus('detecting')
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const nearest = getNearestAirport(pos.coords.latitude, pos.coords.longitude)
        setPrefs(p => ({ ...p, startingPoint: nearest }))
        setGeoStatus('found')
        setTimeout(() => setGeoStatus(''), 3000)
      },
      () => setGeoStatus('denied')
    )
  }, [])

  const update = (key, val) => setPrefs(p => ({ ...p, [key]: val }))

  const handleMonthChange = (month) => {
    const { depart, ret } = getFirstThursdayToSunday(month)
    setPrefs(p => ({
      ...p,
      travelMonth: month,
      specificDepart: depart,
      specificReturn: ret,
    }))
  }

  const toggleTrip = (t) =>
    update('tripType', prefs.tripType.includes(t)
      ? prefs.tripType.filter(x => x !== t)
      : [...prefs.tripType, t])

  const handleInspire = async () => {
    if (!prefs.startingPoint) return

    // Check usage limit for non-signed-in users
    if (!user && inspireLimitReached) {
      onRequireAuth()
      return
    }

    setLoading(true)
    setError('')
    try {
      const body = {
        starting_point:  prefs.startingPoint,
        budget:          prefs.budget,
        group_type:      prefs.groupType,
        trip_type:       prefs.tripType,
        transport_mode:  prefs.transportMode,
        priorities:      prefs.priorities,
        num_adults:      Number(prefs.numAdults),
        dest_preference: destPref,
        specific_depart: prefs.specificDepart,
        specific_return: prefs.specificReturn,
        ...(dateMode === 'flexible' ? { travel_month: prefs.travelMonth } : {}),
      }
      const data = await api.inspire(body)
      setInspireResults(data.destinations || [])
      setPrefsOpen(false)

      track('inspire_search', {
        budget: prefs.budget,
        group_type: prefs.groupType,
        transport: prefs.transportMode,
      })

      // Count this usage for non-signed-in users
      if (!user) incrementInspire()
    } catch (e) {
      setError(e.message)
    } finally {
      setLoading(false)
    }
  }

  const handleChoose = (dest) => {
    track('destination_chosen', { city: dest.CITY, country: dest.COUNTRY })
    setChosenDest(dest)
    onBook()
  }

  return (
    <div className="space-y-6">
      {/* Preferences panel */}
      <div className="card">
        <button
          className="w-full flex items-center justify-between text-left"
          onClick={() => setPrefsOpen(o => !o)}
        >
          <h2 className="font-serif text-lg text-sage-light">ðŸŽ’ Your Travel Preferences</h2>
          <span className="text-slate-3 text-sm">{prefsOpen ? 'â–² Close' : 'â–¼ Edit'}</span>
        </button>

        {prefsOpen && (
          <div className="mt-5 space-y-5">
            {/* Departure airport */}
            <div>
              <label className="label">ðŸ“ Departing from</label>
              <AirportSelect value={prefs.startingPoint} onChange={v => { update('startingPoint', v); setGeoStatus('') }} />
              {geoStatus === 'detecting' && (
                <p className="text-xs text-slate-3 mt-1 italic">ðŸ“ Detecting your nearest airportâ€¦</p>
              )}
              {geoStatus === 'found' && (
                <p className="text-xs text-green-400 mt-1">âœ“ Nearest airport detected</p>
              )}
              {geoStatus === 'denied' && (
                <p className="text-xs text-slate-3 mt-1">Location access denied â€” please select manually</p>
              )}
            </div>

            {/* Budget + Group */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="label">ðŸ’° Budget</label>
                <select className="select" value={prefs.budget} onChange={e => update('budget', e.target.value)}>
                  {BUDGETS.map(b => <option key={b} value={b}>{b}</option>)}
                </select>
              </div>
              <div>
                <label className="label">ðŸ‘¥ Travelling as</label>
                <select className="select" value={prefs.groupType} onChange={e => update('groupType', e.target.value)}>
                  {GROUPS.map(g => <option key={g} value={g}>{g}</option>)}
                </select>
              </div>
            </div>

            {/* Adults */}
            <div>
              <label className="label">ðŸ§‘ Number of adults</label>
              <input type="number" min={1} max={20} className="input w-24"
                value={prefs.numAdults} onChange={e => update('numAdults', e.target.value)} />
            </div>

            {/* Children â€” show for Family or Group with kids */}
            {(prefs.groupType === 'Family' || prefs.groupType === 'Group with kids') && (
              <div className="space-y-3">
                <div>
                  <label className="label">ðŸ‘¶ Number of children</label>
                  <input type="number" min={0} max={10} className="input w-24"
                    value={prefs.numChildren || 0}
                    onChange={e => {
                      const num = Math.max(0, Math.min(10, parseInt(e.target.value) || 0))
                      const ages = [...(prefs.childrenAges || [])]
                      while (ages.length < num) ages.push(5)
                      while (ages.length > num) ages.pop()
                      setPrefs(p => ({ ...p, numChildren: num, childrenAges: ages }))
                    }} />
                </div>
                {(prefs.numChildren > 0) && (
                  <div>
                    <label className="label">ðŸŽ‚ Children's ages</label>
                    <div className="flex flex-wrap gap-2">
                      {(prefs.childrenAges || []).map((age, i) => (
                        <div key={i} className="flex items-center gap-1">
                          <span className="text-xs" style={{color:'#7a7870'}}>Child {i + 1}</span>
                          <select className="select w-20 text-sm" value={age}
                            onChange={e => {
                              const ages = [...prefs.childrenAges]
                              ages[i] = parseInt(e.target.value)
                              setPrefs(p => ({ ...p, childrenAges: ages }))
                            }}>
                            {Array.from({ length: 18 }, (_, a) => (
                              <option key={a} value={a}>{a === 0 ? 'Under 1' : a}</option>
                            ))}
                          </select>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Trip types */}
            <div>
              <label className="label">ðŸ—º Trip type (pick any)</label>
              <div className="flex flex-wrap gap-2">
                {TRIPS.map(t => (
                  <button
                    key={t}
                    onClick={() => toggleTrip(t)}
                    className={`text-xs px-3 py-1.5 rounded-full border transition-colors ${
                      prefs.tripType.includes(t)
                        ? 'bg-sage/20 border-sage/60 text-sage'
                        : 'border-white/10 text-slate hover:border-sage/30 hover:text-sage-light'
                    }`}
                  >
                    {t}
                  </button>
                ))}
              </div>
            </div>

            {/* Transport */}
            <div>
              <label className="label">ðŸš— Transport preference</label>
              <div className="flex gap-3">
                {TRANSPORT.map(t => (
                  <button
                    key={t.value}
                    onClick={() => update('transportMode', t.value)}
                    className={`flex-1 text-sm py-2 rounded-lg border transition-colors ${
                      prefs.transportMode === t.value
                        ? 'bg-sage/20 border-sage/60 text-sage'
                        : 'border-white/10 text-slate hover:border-sage/30'
                    }`}
                  >
                    {t.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Priorities */}
            <div>
              <label className="label">â­ Priorities & interests</label>
              <input
                className="input"
                placeholder="e.g. good food, art, family-friendly, swimmingâ€¦"
                value={prefs.priorities}
                onChange={e => update('priorities', e.target.value)}
              />
            </div>

            {/* Dates */}
            <div>
              <label className="label">ðŸ“… When</label>
              <div className="flex gap-2 mb-3">
                {['specific','flexible'].map(m => (
                  <button
                    key={m}
                    onClick={() => setDateMode(m)}
                    className={`text-sm px-4 py-1.5 rounded-lg border transition-colors capitalize ${
                      dateMode === m
                        ? 'bg-sage/20 border-sage/60 text-sage'
                        : 'border-white/10 text-slate hover:border-sage/30'
                    }`}
                  >
                    {m === 'flexible' ? 'ðŸ—“ Flexible (pick a month)' : 'ðŸ“† Specific dates'}
                  </button>
                ))}
              </div>

              {dateMode === 'specific' ? (
                <div className="flex gap-3 items-center">
                  <div>
                    <label className="label">Depart</label>
                    <DatePicker
                      selected={prefs.specificDepart ? new Date(prefs.specificDepart) : null}
                      onChange={d => update('specificDepart', d?.toISOString().slice(0,10))}
                      dateFormat="dd/MM/yyyy"
                      calendarStartDay={1}
                      minDate={new Date()}
                      className="input w-36"
                      placeholderText="DD/MM/YYYY"
                    />
                  </div>
                  <span className="text-slate-3 mt-5">â†’</span>
                  <div>
                    <label className="label">Return</label>
                    <DatePicker
                      selected={prefs.specificReturn ? new Date(prefs.specificReturn) : null}
                      onChange={d => update('specificReturn', d?.toISOString().slice(0,10))}
                      dateFormat="dd/MM/yyyy"
                      calendarStartDay={1}
                      minDate={prefs.specificDepart ? new Date(prefs.specificDepart) : new Date()}
                      className="input w-36"
                      placeholderText="DD/MM/YYYY"
                    />
                  </div>
                </div>
              ) : (
                <>
                  <select className="select" value={prefs.travelMonth}
                    onChange={e => handleMonthChange(e.target.value)}>
                    {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                  </select>
                </>
              )}
            </div>

            {/* Destination preference */}
            <div>
              <label className="label">ðŸ” Destination preference <span className="normal-case font-normal text-slate-3">(optional)</span></label>
              <input
                className="input"
                placeholder="e.g. Portugal, Greek islands, somewhere warmâ€¦"
                value={destPref}
                onChange={e => setDestPref(e.target.value)}
              />
            </div>

            {error && (
              <div className="text-red-400 text-sm bg-red-400/10 border border-red-400/20 rounded-lg p-3">
                {error}
              </div>
            )}

            <button
              className="btn-primary w-full text-base py-3"
              onClick={handleInspire}
              disabled={!prefs.startingPoint || loading}
            >
              âœ¨ Inspire Me!
            </button>

            {/* Usage remaining hint for non-signed-in users */}
            {!user && !inspireLimitReached && (
              <p className="text-xs text-center" style={{color:'#7a7870'}}>
                {inspireRemaining} free {inspireRemaining === 1 ? 'search' : 'searches'} remaining â€” <button className="underline hover:text-sage transition-colors" onClick={onRequireAuth}>sign in</button> for unlimited
              </p>
            )}
            {!user && inspireLimitReached && (
              <div className="text-center p-3 rounded-lg" style={{background:'rgba(127,182,133,0.08)', border:'1px solid rgba(127,182,133,0.2)'}}>
                <p className="text-sm" style={{color:'#c8c4bc'}}>You've used your free searches</p>
                <button className="text-sm font-medium mt-1 underline transition-colors" style={{color:'#7fb685'}} onClick={onRequireAuth}>
                  Sign in for unlimited access
                </button>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Loading */}
      {loading && (
        <div className="card">
          <SherpaSpinner messages={[
            'Sherpa is on the moveâ€¦',
            'Scouting the perfect routeâ€¦',
            'Consulting the mapâ€¦',
            'Checking conditions aheadâ€¦',
            'Weighing up your optionsâ€¦',
            'Almost at base campâ€¦',
          ]} />
        </div>
      )}

      {/* Results */}
      {!loading && inspireResults.length > 0 && (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="font-serif text-xl text-sage-light">
              {inspireResults.length === 1 ? 'Your destination' : `${inspireResults.length} destinations for you`}
            </h2>
            <button className="btn-secondary text-sm" onClick={() => setPrefsOpen(true)}>
              â†© Change preferences
            </button>
          </div>
          {inspireResults.map((dest, i) => (
            <DestCard key={i} dest={dest} onChoose={handleChoose} />
          ))}
        </div>
      )}

      {/* Chosen confirmation */}
      {chosenDest && !loading && (
        <div className="card-gold text-center py-4">
          <p className="text-slate-3 text-sm">Currently planning</p>
          <p className="font-serif text-lg text-sage mt-1">
            {chosenDest.EMOJI} {chosenDest.CITY}, {chosenDest.COUNTRY}
          </p>
          <button className="btn-primary mt-3" onClick={onBook}>
            Continue planning â†’
          </button>
        </div>
      )}
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\ItineraryModal.jsx =====
import { useState, useRef, useEffect } from 'react'
import SherpaSpinner from './SherpaSpinner'
import { api } from '../utils/api'
import { track } from '../utils/analytics'

// â”€â”€ Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IS_TIME  = /^(morning|afternoon|evening|night|late afternoon|early evening)/i
const IS_MEAL  = /^(breakfast|lunch|dinner|brunch|supper)/i
const IS_DAY   = /^##\s+(Day\s*\d+[^#\n]*)/i
const IS_GT    = /^##.*Getting There/i
const IS_GH    = /^##.*Getting Home/i
const IS_COST  = /^##.*Cost/i
const IS_TIPS  = /^##.*Local Tips/i

function stripLeadingEmoji(s) {
  return s.replace(/^[\p{Emoji}\uFE0F\u20E3\s]+/u, '').trim()
}

function leadingEmoji(s) {
  const m = s.match(/^([\p{Emoji}\uFE0F]+)/u)
  return m ? m[1].replace(/\uFE0F/g, '').trim() : null
}

function parseDays(markdown) {
  if (!markdown) return { days: [], sections: {} }

  const sections = { getting_there: [], cost: [], tips: [], getting_home: [] }
  const days = []

  let currentDay   = null
  let currentBlock = null
  let pendingMeal  = null
  let otherSection = null

  const pushBlock = (b) => { if (b && currentDay) currentDay.blocks.push(b) }

  const flush = () => {
    if (pendingMeal) { pushBlock(pendingMeal); pendingMeal = null }
    if (currentBlock) { pushBlock(currentBlock); currentBlock = null }
  }

  for (const raw of markdown.split('\n')) {
    const line = raw.trim()
    if (!line || line === '---' || line === '***') continue

    if (IS_GT.test(line))   { flush(); otherSection = 'getting_there'; currentDay = null; continue }
    if (IS_GH.test(line))   { flush(); otherSection = 'getting_home';  currentDay = null; continue }
    if (IS_COST.test(line)) { flush(); otherSection = 'cost';          currentDay = null; continue }
    if (IS_TIPS.test(line)) { flush(); otherSection = 'tips';          currentDay = null; continue }

    const dayM = line.match(IS_DAY)
    if (dayM) {
      flush()
      currentDay   = { title: dayM[1].trim(), blocks: [] }
      otherSection = null
      days.push(currentDay)
      continue
    }

    if (otherSection) {
      const clean = line.replace(/\*\*/g, '').replace(/^[-â€¢]\s*/, '').trim()
      if (clean) sections[otherSection].push(clean)
      continue
    }

    if (!currentDay) continue

    const boldM = line.match(/^\*\*(.+?)\*\*:?\s*(.*)$/)
    if (boldM) {
      const rawTitle   = boldM[1].trim()
      const afterColon = boldM[2].trim().replace(/\*\*/g, '')
      const cleanTitle = stripLeadingEmoji(rawTitle).replace(/:$/, '').trim()
      const icon       = leadingEmoji(rawTitle)

      if (IS_TIME.test(cleanTitle)) {
        flush()
        currentBlock = { isTime: true, title: cleanTitle, icon, details: afterColon ? [afterColon] : [] }
      } else if (IS_MEAL.test(cleanTitle)) {
        flush()
        pendingMeal = { isMeal: true, mealType: cleanTitle, icon, restaurantName: null, subtitle: null, details: afterColon ? [afterColon] : [] }
      } else if (pendingMeal && !pendingMeal.restaurantName) {
        pendingMeal.restaurantName = cleanTitle
        if (afterColon) pendingMeal.details.push(afterColon)
      } else {
        flush()
        currentBlock = { isActivity: true, title: cleanTitle, icon, details: afterColon ? [afterColon] : [] }
      }
      continue
    }

    const clean = line.replace(/^[-â€¢*]\s*/, '').replace(/\*\*/g, '').trim()
    if (!clean) continue

    if (clean.startsWith('|') && pendingMeal) {
      pendingMeal.subtitle = clean.replace(/\|/g, 'Â·').replace(/Â·\s*Â·/g, 'Â·').trim().replace(/^Â·|Â·$/g, '').trim()
      continue
    }

    if (pendingMeal)  { pendingMeal.details.push(clean); continue }
    if (currentBlock) { currentBlock.details.push(clean); continue }
  }

  flush()
  return { days, sections }
}

function parseCost(lines) {
  return lines.map(l => {
    const m = l.match(/^(.+?):\s*(.+)$/)
    if (m) return { label: m[1].trim(), value: m[2].trim() }
    return { label: null, value: l }
  })
}

// â”€â”€ Block renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Block({ block }) {
  let label, title, icon, subtitle

  if (block.isTime) {
    label = block.title; title = null; icon = block.icon; subtitle = null
  } else if (block.isMeal) {
    label = block.mealType; title = block.restaurantName; icon = block.icon; subtitle = block.subtitle
  } else {
    label = null; title = block.title; icon = block.icon; subtitle = block.subtitle || null
  }

  return (
    <div className="rounded-xl p-4 mb-3" style={{
      background: '#1a2020', border: '1px solid rgba(127,182,133,0.15)',
    }}>
      {label && (
        <div className="flex items-center gap-1.5 mb-2">
          {icon && <span className="text-sm leading-none">{icon}</span>}
          <span className="text-xs font-bold uppercase tracking-widest" style={{color:'#7fb685'}}>{label}</span>
        </div>
      )}
      {title && (
        <div className="flex items-start gap-2 mb-1">
          {!label && icon && <span className="shrink-0 text-base leading-tight">{icon}</span>}
          <p className="font-semibold text-sm leading-snug" style={{color:'#f0ede8'}}>{title}</p>
        </div>
      )}
      {subtitle && <p className="text-xs mb-1.5" style={{color:'#7a7870'}}>{subtitle}</p>}
      {block.details.map((d, i) => (
        <p key={i} className="text-sm leading-relaxed mt-1" style={{color:'#a0a098'}}>{d}</p>
      ))}
    </div>
  )
}

// â”€â”€ Cost card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COST_ICONS = {
  flight: 'âœˆï¸', accommodation: 'ðŸ¨', hotel: 'ðŸ¨', food: 'ðŸ½ï¸',
  drink: 'ðŸ·', activities: 'ðŸŽŸï¸', activity: 'ðŸŽŸï¸', transport: 'ðŸšŒ',
  car: 'ðŸš—', total: 'ðŸ’°', estimated: 'ðŸ’°',
}

function getCostIcon(label) {
  const l = label.toLowerCase()
  for (const [key, icon] of Object.entries(COST_ICONS)) {
    if (l.includes(key)) return icon
  }
  return 'â€¢'
}

function CostGuide({ lines }) {
  const rows = parseCost(lines)
  const total = rows.find(r => r.label?.toLowerCase().includes('total') || r.label?.toLowerCase().includes('estimated'))
  const rest  = rows.filter(r => r !== total && r.label)
  return (
    <div className="rounded-xl overflow-hidden" style={{border:'1px solid rgba(127,182,133,0.25)'}}>
      {total && (
        <div className="px-4 py-4 flex items-center justify-between"
             style={{background:'linear-gradient(135deg, rgba(127,182,133,0.2) 0%, rgba(127,182,133,0.08) 100%)'}}>
          <div>
            <p className="text-xs uppercase tracking-widest mb-0.5" style={{color:'#7fb685'}}>Estimated total</p>
            <p className="text-2xl font-serif font-bold" style={{color:'#f0ede8'}}>{total.value}</p>
            <p className="text-xs mt-0.5" style={{color:'#7a7870'}}>per person, excluding accommodation</p>
          </div>
          <span className="text-3xl">ðŸ’°</span>
        </div>
      )}
      <div style={{background:'#1a2020'}}>
        <p className="px-4 pt-3 pb-1 text-xs uppercase tracking-widest" style={{color:'#7a7870'}}>Breakdown</p>
        {rest.map((r, i) => (
          <div key={i} className="flex items-center gap-3 px-4 py-2.5 border-b"
               style={{borderColor:'rgba(255,255,255,0.05)'}}>
            <span className="text-lg w-7 text-center shrink-0">{getCostIcon(r.label)}</span>
            <span className="text-sm flex-1" style={{color:'#a0a098'}}>{r.label}</span>
            <span className="text-sm font-medium" style={{color:'#c8c4bc'}}>{r.value}</span>
          </div>
        ))}
      </div>
    </div>
  )
}

// â”€â”€ Day photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAY_PHOTO_CACHE = {}

function DayPhoto({ day, destCity }) {
  const [photo, setPhoto] = useState(null)

  useEffect(() => {
    if (!day || !destCity) return
    const firstActivity = day.blocks?.find(b => !b.isTime && b.title)?.title || ''
    const query = firstActivity ? `${destCity} ${firstActivity}` : `${destCity} travel`
    const cacheKey = query

    if (DAY_PHOTO_CACHE[cacheKey]) { setPhoto(DAY_PHOTO_CACHE[cacheKey]); return }

    api.photo(query)
      .then(p => { if (p?.url) { DAY_PHOTO_CACHE[cacheKey] = p; setPhoto(p) } })
      .catch(() => {})
  }, [day?.title, destCity])

  if (!photo) return null

  return (
    <div className="relative rounded-xl overflow-hidden mb-4" style={{height: 160}}>
      <img src={photo.url} alt="" className="w-full h-full object-cover" style={{filter:'brightness(0.75)'}} />
      <div className="absolute inset-0" style={{background:'linear-gradient(to top, #111614 0%, transparent 60%)'}} />
      {photo.credit && (
        <a href={photo.credit_url} target="_blank" rel="noopener noreferrer"
           className="absolute bottom-2 right-2 text-xs" style={{color:'rgba(255,255,255,0.4)'}}>
          ðŸ“· {photo.credit}
        </a>
      )}
    </div>
  )
}

// â”€â”€ Venue card with photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function VenueCard({ venue, typeIcon, destCity }) {
  const [photo, setPhoto] = useState(null)

  useEffect(() => {
    api.photo(`${venue.name} ${destCity} restaurant food`)
      .then(p => { if (p?.url) setPhoto(p) })
      .catch(() => {})
  }, [venue.name])

  return (
    <div className="px-4 py-3">
      <div className="flex items-start gap-3">
        <div className="shrink-0 rounded-lg overflow-hidden" style={{width:56, height:56, background:'#222b28'}}>
          {photo
            ? <img src={photo.thumb || photo.url} alt={venue.name} className="w-full h-full object-cover" style={{filter:'brightness(0.9)'}} />
            : <div className="w-full h-full flex items-center justify-center text-xl">{typeIcon}</div>
          }
        </div>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-1.5 mb-0.5">
            <p className="font-medium text-sm truncate" style={{color:'#f0ede8'}}>{venue.name}</p>
          </div>
          <p className="text-xs leading-relaxed" style={{color:'#a0a098'}}>{venue.note}</p>
        </div>
        <a href={venue.instagram_url} target="_blank" rel="noopener noreferrer"
           className="shrink-0 text-xs px-2.5 py-1.5 rounded-lg whitespace-nowrap flex items-center gap-1"
           style={{background:'rgba(131,58,180,0.12)', color:'#c084fc', border:'1px solid rgba(131,58,180,0.25)'}}>
          ðŸ“¸
        </a>
      </div>
    </div>
  )
}

// â”€â”€ Language phrase lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PHRASE_CACHE = {}

function LanguagePhrase({ dest, phrase }) {
  const [translation, setTranslation] = useState(null)

  useEffect(() => {
    if (!dest) return
    const key = `${dest}:${phrase}`
    if (PHRASE_CACHE[key]) { setTranslation(PHRASE_CACHE[key]); return }

    api.chat({
      message: `What is "${phrase}" in the local language of ${dest}? Reply with ONLY the translated phrase and pronunciation in brackets, nothing else. Example format: Grazie (GRAT-see-eh)`,
      context: '',
    }).then(r => {
      const t = r.reply?.trim() || 'â€”'
      PHRASE_CACHE[key] = t
      setTranslation(t)
    }).catch(() => setTranslation('â€”'))
  }, [dest, phrase])

  return (
    <span className="text-xs font-medium" style={{color:'#a8c9ad'}}>
      {translation || 'â€¦'}
    </span>
  )
}

// â”€â”€ Map category config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATEGORY_CONFIG = {
  Restaurant: { color: '#f97316', bg: 'rgba(249,115,22,0.15)', border: 'rgba(249,115,22,0.3)', icon: 'ðŸ½ï¸', label: 'Restaurants' },
  Cafe:       { color: '#d97706', bg: 'rgba(217,119,6,0.15)',  border: 'rgba(217,119,6,0.3)',  icon: 'â˜•',  label: 'Cafes' },
  Bar:        { color: '#a855f7', bg: 'rgba(168,85,247,0.15)', border: 'rgba(168,85,247,0.3)', icon: 'ðŸ¸',  label: 'Bars' },
  Museum:     { color: '#3b82f6', bg: 'rgba(59,130,246,0.15)', border: 'rgba(59,130,246,0.3)', icon: 'ðŸ›ï¸', label: 'Museums' },
  Attraction: { color: '#eab308', bg: 'rgba(234,179,8,0.15)',  border: 'rgba(234,179,8,0.3)',  icon: 'â­',  label: 'Attractions' },
  Market:     { color: '#22c55e', bg: 'rgba(34,197,94,0.15)',  border: 'rgba(34,197,94,0.3)',  icon: 'ðŸ›’',  label: 'Markets' },
  Park:       { color: '#10b981', bg: 'rgba(16,185,129,0.15)', border: 'rgba(16,185,129,0.3)', icon: 'ðŸŒ¿',  label: 'Parks' },
  Viewpoint:  { color: '#06b6d4', bg: 'rgba(6,182,212,0.15)',  border: 'rgba(6,182,212,0.3)',  icon: 'ðŸ‘ï¸', label: 'Viewpoints' },
  Beach:      { color: '#14b8a6', bg: 'rgba(20,184,166,0.15)', border: 'rgba(20,184,166,0.3)', icon: 'ðŸ–ï¸', label: 'Beaches' },
  Hotel:      { color: '#ef4444', bg: 'rgba(239,68,68,0.15)',  border: 'rgba(239,68,68,0.3)',  icon: 'ðŸ¨',  label: 'Hotels' },
}

const DEFAULT_CAT = { color: '#a0a098', bg: 'rgba(160,160,152,0.15)', border: 'rgba(160,160,152,0.3)', icon: 'ðŸ“', label: 'Other' }

function getCat(type) {
  return CATEGORY_CONFIG[type] || DEFAULT_CAT
}

function groupByCategory(pins) {
  const groups = {}
  for (const pin of pins) {
    const cat = pin.type || 'Other'
    if (!groups[cat]) groups[cat] = []
    groups[cat].push(pin)
  }
  return groups
}

function pinMapsUrl(name, city) {
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name + ' ' + city)}`
}

// â”€â”€ Geocode using Nominatim (free, no API key) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GEOCODE_CACHE = {}

async function geocodePin(name, city) {
  const key = `${name}|${city}`
  if (GEOCODE_CACHE[key]) return GEOCODE_CACHE[key]

  try {
    const q = encodeURIComponent(`${name}, ${city}`)
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`, {
      headers: { 'Accept-Language': 'en' }
    })
    const data = await res.json()
    if (data.length > 0) {
      const result = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }
      GEOCODE_CACHE[key] = result
      return result
    }
  } catch {}

  try {
    const q = encodeURIComponent(name)
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`, {
      headers: { 'Accept-Language': 'en' }
    })
    const data = await res.json()
    if (data.length > 0) {
      const result = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }
      GEOCODE_CACHE[key] = result
      return result
    }
  } catch {}

  return null
}

async function geocodeAllPins(pins, city) {
  const results = []
  for (const pin of pins) {
    const coords = await geocodePin(pin.name, city)
    if (coords) {
      results.push({ ...pin, lat: coords.lat, lng: coords.lng })
    } else {
      results.push({ ...pin, lat: null, lng: null })
    }
    await new Promise(r => setTimeout(r, 300))
  }
  return results
}

// â”€â”€ KML file generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateKML(pins, city, emoji) {
  const esc = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')

  function hexToKml(hex) {
    const r = hex.slice(1, 3)
    const g = hex.slice(3, 5)
    const b = hex.slice(5, 7)
    return `ff${b}${g}${r}`
  }

  const validPins = pins.filter(p => p.lat && p.lng)

  let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
  <name>${esc(emoji + ' ' + city + ' Itinerary')}</name>
  <description>Generated by Sherpa - sherpatravel.uk</description>
`

  const usedCats = [...new Set(validPins.map(p => p.type || 'Other'))]
  for (const cat of usedCats) {
    const cfg = getCat(cat)
    kml += `  <Style id="style-${esc(cat)}">
    <IconStyle>
      <color>${hexToKml(cfg.color)}</color>
      <scale>1.2</scale>
      <Icon>
        <href>https://maps.google.com/mapfiles/kml/paddle/${cfg.color.replace('#', '').toUpperCase().slice(0,2)}.png</href>
      </Icon>
    </IconStyle>
    <LabelStyle>
      <color>${hexToKml(cfg.color)}</color>
    </LabelStyle>
  </Style>
`
  }

  for (const cat of usedCats) {
    const cfg = getCat(cat)
    const catPins = validPins.filter(p => (p.type || 'Other') === cat)
    kml += `  <Folder>
    <name>${esc(cfg.icon + ' ' + cfg.label)}</name>
`
    for (const pin of catPins) {
      kml += `    <Placemark>
      <name>${esc(pin.name)}</name>
      <description>${esc(pin.description || '')}</description>
      <styleUrl>#style-${esc(cat)}</styleUrl>
      <Point>
        <coordinates>${pin.lng},${pin.lat},0</coordinates>
      </Point>
    </Placemark>
`
    }
    kml += `  </Folder>
`
  }

  kml += `</Document>
</kml>`

  return kml
}

function downloadKML(pins, city, emoji, destCity) {
  track('map_export', { format: 'kml', destination: destCity })
  const kml = generateKML(pins, city, emoji)
  const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${city.toLowerCase().replace(/\s+/g, '-')}-itinerary.kml`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

// â”€â”€ Map Pin Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MapPinCard({ pin, city }) {
  const cat = getCat(pin.type)
  const hasCoords = pin.lat && pin.lng
  return (
    <a href={pinMapsUrl(pin.name, city)} target="_blank" rel="noopener noreferrer"
       className="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all"
       style={{ background: cat.bg, border: `1px solid ${cat.border}` }}
       onMouseEnter={e => { e.currentTarget.style.transform = 'translateX(4px)'; e.currentTarget.style.borderColor = cat.color }}
       onMouseLeave={e => { e.currentTarget.style.transform = 'translateX(0)'; e.currentTarget.style.borderColor = cat.border }}>
      <span className="text-lg shrink-0">{cat.icon}</span>
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium truncate" style={{color:'#f0ede8'}}>{pin.name}</p>
        {pin.description && (
          <p className="text-xs truncate" style={{color: cat.color}}>{pin.description}</p>
        )}
      </div>
      {!hasCoords && <span className="text-xs shrink-0" style={{color:'#7a7870'}}>ðŸ“</span>}
      <span className="text-xs shrink-0" style={{color:'#7a7870'}}>Open â†—</span>
    </a>
  )
}

// â”€â”€ Leaflet Map Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LeafletMap({ pins, city }) {
  const mapRef = useRef(null)
  const mapInstanceRef = useRef(null)

  useEffect(() => {
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link')
      link.id = 'leaflet-css'
      link.rel = 'stylesheet'
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'
      document.head.appendChild(link)
    }

    const loadLeaflet = () => {
      return new Promise((resolve) => {
        if (window.L) { resolve(window.L); return }
        const script = document.createElement('script')
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
        script.onload = () => resolve(window.L)
        document.head.appendChild(script)
      })
    }

    const validPins = pins.filter(p => p.lat && p.lng)
    if (validPins.length === 0 || !mapRef.current) return

    loadLeaflet().then(L => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove()
        mapInstanceRef.current = null
      }

      const map = L.map(mapRef.current, { zoomControl: true, attributionControl: true })
      mapInstanceRef.current = map

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 19,
      }).addTo(map)

      const markers = []
      for (const pin of validPins) {
        const cat = getCat(pin.type)

        const iconHtml = `<div style="
          width: 32px; height: 32px;
          background: ${cat.color};
          border: 2px solid #fff;
          border-radius: 50%;
          display: flex; align-items: center; justify-content: center;
          font-size: 14px; line-height: 1;
          box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        ">${cat.icon}</div>`

        const icon = L.divIcon({
          html: iconHtml,
          className: '',
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -18],
        })

        const marker = L.marker([pin.lat, pin.lng], { icon }).addTo(map)
        marker.bindPopup(`
          <div style="font-family:Inter,sans-serif;min-width:140px;">
            <strong style="font-size:13px;">${cat.icon} ${pin.name}</strong>
            ${pin.description ? `<br/><span style="font-size:11px;color:#666;">${pin.description}</span>` : ''}
            <br/><a href="${pinMapsUrl(pin.name, city)}" target="_blank" style="font-size:11px;color:#4285f4;">Open in Google Maps â†—</a>
          </div>
        `)
        markers.push(marker)
      }

      if (markers.length > 0) {
        const group = L.featureGroup(markers)
        map.fitBounds(group.getBounds().pad(0.15))
      }
    })

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove()
        mapInstanceRef.current = null
      }
    }
  }, [pins])

  const validCount = pins.filter(p => p.lat && p.lng).length
  if (validCount === 0) return null

  return (
    <div ref={mapRef} className="rounded-xl overflow-hidden" style={{height: 320, border:'1px solid rgba(127,182,133,0.2)'}} />
  )
}

// â”€â”€ Map Tab Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MapTab({ dest, itinerary }) {
  const [pins, setPins] = useState(null)
  const [loading, setLoading] = useState(false)
  const [geocoding, setGeocoding] = useState(false)
  const [activeFilter, setActiveFilter] = useState('all')

  const city = dest?.CITY || ''

  const handleDownloadCSV = () => {
    track('map_export', { format: 'csv', destination: dest?.CITY })
    const validPins = pins.filter(p => p.lat && p.lng)
    const rows = [['Name', 'Category', 'Description', 'Latitude', 'Longitude']]
    for (const pin of validPins) {
      const cat = getCat(pin.type)
      rows.push([
        pin.name,
        cat.label,
        (pin.description || '').replace(/,/g, ';'),
        pin.lat,
        pin.lng,
      ])
    }
    const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n')
    const blob = new Blob([csv], { type: 'text/csv' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${city.toLowerCase().replace(/\s+/g, '-')}-itinerary.csv`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  useEffect(() => {
    if (!itinerary || !dest?.CITY || pins) return
    setLoading(true)
    api.mapPins({ itinerary, dest_city: dest.CITY })
      .then(async (d) => {
        const rawPins = d.locations || []
        setLoading(false)
        setGeocoding(true)
        const geocoded = await geocodeAllPins(rawPins, dest.CITY)
        setPins(geocoded)
        setGeocoding(false)
      })
      .catch(() => { setPins([]); setLoading(false) })
  }, [itinerary, dest?.CITY])

  if (loading) {
    return (
      <div className="py-8">
        <SherpaSpinner messages={['Mapping your itinerary...', 'Finding all the spots...', 'Pinning locations...']} />
      </div>
    )
  }

  if (!pins || pins.length === 0) {
    return (
      <div className="text-center py-8">
        <p className="text-sm" style={{color:'#a0a098'}}>No map pins found for this itinerary.</p>
      </div>
    )
  }

  const grouped = groupByCategory(pins)
  const categories = Object.keys(grouped).sort()
  const filteredPins = activeFilter === 'all' ? pins : pins.filter(p => (p.type || 'Other') === activeFilter)
  const geocodedCount = pins.filter(p => p.lat && p.lng).length

  return (
    <div className="space-y-4">

      {geocoding && (
        <div className="rounded-xl p-4 text-center" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.15)'}}>
          <SherpaSpinner messages={['Placing pins on the map...', 'Finding coordinates...', 'Nearly there...']} />
        </div>
      )}

      {!geocoding && geocodedCount > 0 && (
        <LeafletMap pins={filteredPins} city={city} />
      )}

      {!geocoding && geocodedCount > 0 && (
        <div className="rounded-xl p-4 space-y-4" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.2)'}}>
          <p className="text-xs font-bold uppercase tracking-widest" style={{color:'#7fb685'}}>
            Export to Google Maps
          </p>

          <div className="flex gap-2">
            <button
              onClick={() => downloadKML(pins, city, dest?.EMOJI || 'ðŸ“', dest?.CITY)}
              className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg text-sm font-medium transition-all"
              style={{background:'#34a853', color:'#fff'}}
              onMouseEnter={e => e.currentTarget.style.background='#2d9249'}
              onMouseLeave={e => e.currentTarget.style.background='#34a853'}>
              <span>ðŸ“¥</span>
              KML file
            </button>

            <button
              onClick={handleDownloadCSV}
              className="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg text-sm font-medium transition-all"
              style={{background:'#4285f4', color:'#fff'}}
              onMouseEnter={e => e.currentTarget.style.background='#3367d6'}
              onMouseLeave={e => e.currentTarget.style.background='#4285f4'}>
              <span>ðŸ“Š</span>
              CSV file
            </button>
          </div>

          <div className="space-y-3">
            <div className="rounded-lg p-3" style={{background:'rgba(52,168,83,0.08)', border:'1px solid rgba(52,168,83,0.15)'}}>
              <p className="text-xs font-semibold mb-1.5" style={{color:'#34a853'}}>ðŸ“± Mobile (KML)</p>
              <div className="space-y-1">
                <p className="text-xs" style={{color:'#a0a098'}}>1. Download the KML file</p>
                <p className="text-xs" style={{color:'#a0a098'}}>2. Open it and select Google Maps</p>
                <p className="text-xs" style={{color:'#a0a098'}}>3. All pins appear on your map instantly</p>
              </div>
            </div>

            <div className="rounded-lg p-3" style={{background:'rgba(66,133,244,0.08)', border:'1px solid rgba(66,133,244,0.15)'}}>
              <p className="text-xs font-semibold mb-1.5" style={{color:'#4285f4'}}>ðŸ’» Desktop (CSV)</p>
              <div className="space-y-1">
                <p className="text-xs" style={{color:'#a0a098'}}>1. Download the CSV file</p>
                <p className="text-xs" style={{color:'#a0a098'}}>2. Go to <a href="https://www.google.com/maps/d/" target="_blank" rel="noopener noreferrer" style={{color:'#4285f4', textDecoration:'underline'}}>Google My Maps</a> and create a new map</p>
                <p className="text-xs" style={{color:'#a0a098'}}>3. Click Import and upload the CSV</p>
                <p className="text-xs" style={{color:'#a0a098'}}>4. Select Latitude and Longitude as position columns</p>
                <p className="text-xs" style={{color:'#a0a098'}}>5. Select Name as the title column</p>
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="rounded-xl p-3" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.15)'}}>
        <p className="text-xs uppercase tracking-widest mb-2" style={{color:'#7a7870'}}>Filter by category</p>
        <div className="flex flex-wrap gap-1.5">
          <button
            onClick={() => setActiveFilter('all')}
            className="text-xs px-2.5 py-1 rounded-full transition-all"
            style={{
              background: activeFilter === 'all' ? 'rgba(127,182,133,0.2)' : 'transparent',
              color: activeFilter === 'all' ? '#7fb685' : '#7a7870',
              border: `1px solid ${activeFilter === 'all' ? 'rgba(127,182,133,0.4)' : 'rgba(255,255,255,0.08)'}`,
            }}>
            All ({pins.length})
          </button>
          {categories.map(cat => {
            const cfg = getCat(cat)
            const count = grouped[cat].length
            return (
              <button key={cat}
                onClick={() => setActiveFilter(activeFilter === cat ? 'all' : cat)}
                className="text-xs px-2.5 py-1 rounded-full transition-all"
                style={{
                  background: activeFilter === cat ? cfg.bg : 'transparent',
                  color: activeFilter === cat ? cfg.color : '#7a7870',
                  border: `1px solid ${activeFilter === cat ? cfg.border : 'rgba(255,255,255,0.08)'}`,
                }}>
                {cfg.icon} {cfg.label} ({count})
              </button>
            )
          })}
        </div>
      </div>

      <p className="text-xs" style={{color:'#7a7870'}}>
        Showing {filteredPins.length} of {pins.length} locations
        {geocodedCount < pins.length && ` Â· ${geocodedCount} mapped`}
      </p>

      <div className="space-y-2">
        {activeFilter === 'all' ? (
          categories.map(cat => {
            const cfg = getCat(cat)
            return (
              <div key={cat}>
                <div className="flex items-center gap-2 mb-2 mt-4 first:mt-0">
                  <span>{cfg.icon}</span>
                  <p className="text-xs font-bold uppercase tracking-widest" style={{color: cfg.color}}>
                    {cfg.label}
                  </p>
                  <div className="flex-1 h-px" style={{background: cfg.border}} />
                </div>
                <div className="space-y-1.5">
                  {grouped[cat].map((pin, i) => (
                    <MapPinCard key={i} pin={pin} city={city} />
                  ))}
                </div>
              </div>
            )
          })
        ) : (
          <div className="space-y-1.5">
            {filteredPins.map((pin, i) => (
              <MapPinCard key={i} pin={pin} city={city} />
            ))}
          </div>
        )}
      </div>
    </div>
  )
}

// â”€â”€ Main Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function ItineraryModal({
  itinerary, dest, destData, prefs, flightDetails, selectedHotel,
  feedback, setFeedback, onTweak, tweaking,
  onSave, saving, saved, user,
  activities, fetchActivities, activitiesLoading,
  skyscannerUrl, bookingUrl, carHireUrl,
  onClose,
  onRequestFeedback,
}) {
  const [activeTab, setActiveTab] = useState('overview')
  const [photos, setPhotos] = useState([])
  const [activeDay, setActiveDay] = useState(0)
  const scrollRef = useRef(null)

  useEffect(() => {
    if (!dest?.CITY) return
    const queries = [
      dest.CITY,
      ...(destData?.highlights?.slice(0, 3) || []).map(h => `${dest.CITY} ${h}`)
    ].slice(0, 4)

    Promise.all(queries.map(q => api.photo(q).catch(() => ({ url: null }))))
      .then(results => setPhotos(results.filter(p => p.url)))
  }, [dest?.CITY])

  const { days, sections } = parseDays(itinerary)
  const scrollTop = () => scrollRef.current?.scrollTo({ top: 0, behavior: 'smooth' })

  const tabs = [
    { id: 'overview', label: 'ðŸ—ºï¸ Overview'   },
    { id: 'days',     label: 'ðŸ“… Day by Day'  },
    { id: 'map',      label: 'ðŸ“ Map'         },
    { id: 'booking',  label: 'ðŸ›’ Book'        },
    { id: 'local',    label: 'ðŸ’¡ Local Tips'  },
  ]

  const fmtDate = (iso) => {
    if (!iso) return null
    try { return new Date(iso).toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' }) }
    catch { return iso }
  }

  const daysWithTransfer = days.map((day, i) => {
    let blocks = [...day.blocks]
    if (i === 0 && sections.getting_there.length > 0) {
      blocks = [{ isActivity: true, title: 'Getting There', icon: 'âœˆï¸', details: sections.getting_there }, ...blocks]
    }
    if (i === days.length - 1 && sections.getting_home.length > 0) {
      blocks = [...blocks, { isActivity: true, title: 'Getting Home', icon: 'ðŸ ', details: sections.getting_home }]
    }
    return { ...day, blocks }
  })

  return (
    <div className="fixed inset-0 z-50 flex flex-col" style={{background:'#0a1520'}}>

      {/* Header */}
      <div className="flex items-center justify-between px-5 py-3 border-b shrink-0"
           style={{background:'#111614', borderColor:'rgba(127,182,133,0.2)'}}>
        <div className="flex items-center gap-3">
          <span className="text-xl">{dest?.EMOJI}</span>
          <div>
            <h2 className="font-serif text-lg leading-tight" style={{color:'#f0ede8'}}>{dest?.CITY}</h2>
            <p className="text-xs" style={{color:'#7a7870'}}>{days.length} day itinerary</p>
          </div>
        </div>
        <button onClick={onClose} className="text-2xl leading-none"
                style={{color:'#7a7870'}}
                onMouseEnter={e=>e.target.style.color='#7fb685'}
                onMouseLeave={e=>e.target.style.color='#7a7870'}>âœ•</button>
      </div>

      {/* Tabs */}
      <div className="flex gap-1 px-4 py-2 border-b shrink-0 overflow-x-auto"
           style={{background:'#111614', borderColor:'rgba(255,255,255,0.06)'}}>
        {tabs.map(t => (
          <button key={t.id} onClick={() => { setActiveTab(t.id); scrollTop() }}
            className="shrink-0 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-colors"
            style={{
              background: activeTab===t.id ? '#7fb685' : 'transparent',
              color:      activeTab===t.id ? '#111614' : '#a0a098',
              border:     activeTab===t.id ? 'none'    : '1px solid rgba(255,255,255,0.1)',
            }}>
            {t.label}
          </button>
        ))}
      </div>

      {/* Content */}
      <div ref={scrollRef} className="flex-1 overflow-y-auto px-4 py-4">
        <div className="max-w-2xl mx-auto pb-4">

          {/* â”€â”€ OVERVIEW â”€â”€ */}
          {activeTab === 'overview' && (
            <div className="space-y-3">
              {photos.length > 0 && (
                <div className="flex gap-2 -mx-1">
                  {photos.map((p, i) => (
                    <div key={i} className="flex-1 min-w-0 rounded-xl overflow-hidden"
                         style={{height: 120, flexBasis: `${100/photos.length}%`}}>
                      <img src={p.thumb || p.url} alt="" className="w-full h-full object-cover" style={{filter:'brightness(0.9)'}} />
                    </div>
                  ))}
                </div>
              )}

              {destData && (
                <div className="rounded-xl p-4 space-y-3" style={{background:'rgba(127,182,133,0.06)', border:'1px solid rgba(127,182,133,0.25)'}}>
                  {destData.TAGLINE && <p className="font-serif text-base italic" style={{color:'#f0ede8'}}>"{destData.TAGLINE}"</p>}
                  {destData.BUDGET_NOTE && <p className="text-sm leading-relaxed" style={{color:'#c8c4bc'}}>ðŸ’° {destData.BUDGET_NOTE}</p>}
                  {destData.WEATHER && <p className="text-sm leading-relaxed" style={{color:'#c8c4bc'}}>ðŸŒ¤ï¸ {destData.WEATHER}</p>}
                  {destData.highlights?.length > 0 && (
                    <div className="flex flex-wrap gap-1.5 pt-1">
                      {destData.highlights.map((h, i) => (
                        <span key={i} className="text-xs px-2.5 py-1 rounded-full"
                              style={{background:'rgba(127,182,133,0.1)', color:'#c8c4bc', border:'1px solid rgba(127,182,133,0.2)'}}>
                          {h}
                        </span>
                      ))}
                    </div>
                  )}
                  {destData.DISH && <p className="text-xs" style={{color:'#7a7870'}}>ðŸ´ Must try: <span style={{color:'#a0a098'}}>{destData.DISH}</span></p>}
                </div>
              )}

              <div className="rounded-xl p-4" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.25)'}}>
                <p className="text-xs font-bold uppercase tracking-widest mb-3" style={{color:'#7fb685'}}>Trip at a Glance</p>
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span style={{color:'#7a7870'}}>Destination</span>
                    <span style={{color:'#c8c4bc'}}>{dest?.EMOJI} {dest?.CITY}, {dest?.COUNTRY}</span>
                  </div>
                  {flightDetails?.outboundDate && (
                    <div className="flex justify-between text-sm">
                      <span style={{color:'#7a7870'}}>Outbound</span>
                      <span style={{color:'#c8c4bc'}}>{fmtDate(flightDetails.outboundDate)} Â· arrive {flightDetails.arrivalTime}</span>
                    </div>
                  )}
                  {flightDetails?.returnDate && (
                    <div className="flex justify-between text-sm">
                      <span style={{color:'#7a7870'}}>Return</span>
                      <span style={{color:'#c8c4bc'}}>{fmtDate(flightDetails.returnDate)} Â· depart {flightDetails.departureTime}</span>
                    </div>
                  )}
                  {selectedHotel && (
                    <div className="flex justify-between text-sm">
                      <span style={{color:'#7a7870'}}>Staying</span>
                      <span style={{color:'#c8c4bc'}}>{selectedHotel}</span>
                    </div>
                  )}
                  {prefs?.budget && (
                    <div className="flex justify-between text-sm">
                      <span style={{color:'#7a7870'}}>Budget</span>
                      <span style={{color:'#c8c4bc'}}>{prefs.budget}</span>
                    </div>
                  )}
                  {prefs?.groupType && (
                    <div className="flex justify-between text-sm">
                      <span style={{color:'#7a7870'}}>Group</span>
                      <span style={{color:'#c8c4bc'}}>{prefs.groupType} Â· {prefs.numAdults} adults</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* â”€â”€ DAY BY DAY â”€â”€ */}
          {activeTab === 'days' && (
            <div>
              {daysWithTransfer.length > 1 && (
                <div className="flex gap-1 mb-4 overflow-x-auto pb-1">
                  {daysWithTransfer.map((day, i) => (
                    <button key={i} onClick={() => { setActiveDay(i); scrollTop() }}
                      className="shrink-0 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap"
                      style={{
                        background: activeDay===i ? '#7fb685' : 'transparent',
                        color:      activeDay===i ? '#111614' : '#a0a098',
                        border:     activeDay===i ? 'none'    : '1px solid rgba(255,255,255,0.1)',
                      }}>
                      Day {i+1}
                    </button>
                  ))}
                </div>
              )}

              <h3 className="font-serif text-lg mb-3" style={{color:'#f0ede8'}}>
                {daysWithTransfer[activeDay]?.title}
              </h3>

              <DayPhoto day={daysWithTransfer[activeDay]} destCity={dest?.CITY} />

              {(daysWithTransfer[activeDay]?.blocks || []).map((block, i) => (
                <Block key={i} block={block} />
              ))}

              {daysWithTransfer.length > 1 && (
                <div className="flex gap-2 mt-4">
                  <button disabled={activeDay===0}
                    onClick={() => { setActiveDay(d=>Math.max(0,d-1)); scrollTop() }}
                    className="flex-1 py-2 rounded-lg text-sm"
                    style={{background:'#1a2020', color: activeDay===0?'#3a4a5a':'#c8c4bc',
                            border:'1px solid rgba(255,255,255,0.08)'}}>
                    â† Previous day
                  </button>
                  <button disabled={activeDay===daysWithTransfer.length-1}
                    onClick={() => {
                      const nextDay = Math.min(daysWithTransfer.length-1, activeDay+1)
                      setActiveDay(nextDay)
                      scrollTop()
                      // Prompt feedback when reaching the last day for the first time
                      if (nextDay === daysWithTransfer.length-1 && onRequestFeedback) {
                        const hasPrompted = localStorage.getItem('sherpa_feedback_prompted')
                        if (!hasPrompted) {
                          localStorage.setItem('sherpa_feedback_prompted', '1')
                          setTimeout(() => onRequestFeedback(), 2000)
                        }
                      }
                    }}
                    className="flex-1 py-2 rounded-lg text-sm"
                    style={{background:'#1a2020', color: activeDay===daysWithTransfer.length-1?'#3a4a5a':'#c8c4bc',
                            border:'1px solid rgba(255,255,255,0.08)'}}>
                    Next day â†’
                  </button>
                </div>
              )}
            </div>
          )}

          {/* â”€â”€ MAP â”€â”€ */}
          {activeTab === 'map' && (
            <MapTab dest={dest} itinerary={itinerary} />
          )}

          {/* â”€â”€ BOOK â”€â”€ */}
          {activeTab === 'booking' && (
            <div className="space-y-4">
              {skyscannerUrl && (
                <div className="rounded-xl p-4" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.2)'}}>
                  <p className="text-xs font-bold uppercase tracking-widest mb-1" style={{color:'#7fb685'}}>âœˆï¸ Flights</p>
                  <p className="text-xs mb-3" style={{color:'#7a7870'}}>
                    {flightDetails?.outboundDate && flightDetails?.returnDate
                      ? `${fmtDate(flightDetails.outboundDate)} â€” ${fmtDate(flightDetails.returnDate)}`
                      : 'Search for flights to ' + dest?.CITY}
                  </p>
                  <a href={skyscannerUrl} target="_blank" rel="noopener noreferrer"
                     className="block w-full text-center py-2.5 rounded-lg text-sm font-medium"
                     style={{background:'#0077CC', color:'#fff'}}
                     onClick={() => track('affiliate_click', { partner: 'skyscanner', destination: dest?.CITY })}>
                    Search on Skyscanner â†’
                  </a>
                </div>
              )}

              {bookingUrl && (
                <div className="rounded-xl p-4" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.2)'}}>
                  <p className="text-xs font-bold uppercase tracking-widest mb-1" style={{color:'#7fb685'}}>ðŸ¨ Hotels</p>
                  <p className="text-xs mb-3" style={{color:'#7a7870'}}>
                    {selectedHotel ? `Staying at ${selectedHotel}` : `Hotels in ${dest?.CITY}`}
                  </p>
                  <a href={bookingUrl} target="_blank" rel="noopener noreferrer"
                     className="block w-full text-center py-2.5 rounded-lg text-sm font-medium"
                     style={{background:'#003580', color:'#fff'}}
                     onClick={() => track('affiliate_click', { partner: 'booking', destination: dest?.CITY })}>
                    Explore on Booking.com â†’
                  </a>
                </div>
              )}

              {carHireUrl && (
                <div className="rounded-xl p-4" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.2)'}}>
                  <p className="text-xs font-bold uppercase tracking-widest mb-1" style={{color:'#7fb685'}}>ðŸš— Car Hire</p>
                  <p className="text-xs mb-3" style={{color:'#7a7870'}}>Compare prices from all major providers</p>
                  <a href={carHireUrl} target="_blank" rel="noopener noreferrer"
                     className="block w-full text-center py-2.5 rounded-lg text-sm font-medium"
                     style={{background:'#e8750a', color:'#fff'}}
                     onClick={() => track('affiliate_click', { partner: 'rentalcars', destination: dest?.CITY })}>
                    Compare on Rentalcars â†’
                  </a>
                </div>
              )}

              {activities === null ? (
                <div className="rounded-xl p-5 text-center" style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.2)'}}>
                  {activitiesLoading ? (
                    <SherpaSpinner messages={['Finding tours to book...','Checking restaurant reservations...','Spotting must-see museums...','Almost there...']} />
                  ) : (
                    <>
                      <p className="text-sm mb-3" style={{color:'#a0a098'}}>Find out what to book in advance for this trip.</p>
                      <button className="btn-primary px-6 text-sm" onClick={() => fetchActivities && fetchActivities()}>Find things to book</button>
                    </>
                  )}
                </div>
              ) : (
                <div className="space-y-4">
                  {activities.gyg?.length > 0 && (
                    <div className="rounded-xl overflow-hidden" style={{border:'1px solid rgba(127,182,133,0.2)'}}>
                      <div className="px-4 py-2.5 flex items-center gap-2" style={{background:'rgba(127,182,133,0.1)'}}>
                        <span>ðŸŽŸï¸</span>
                        <p className="text-xs font-bold uppercase tracking-widest" style={{color:'#7fb685'}}>Tours & Experiences</p>
                        <span className="text-xs ml-auto" style={{color:'#7a7870'}}>via GetYourGuide</span>
                      </div>
                      <div className="divide-y" style={{background:'#1a2020', borderColor:'rgba(255,255,255,0.06)'}}>
                        {activities.gyg.map((a, i) => (
                          <div key={i} className="flex items-start justify-between gap-3 px-4 py-3">
                            <div className="flex-1">
                              <p className="font-medium text-sm" style={{color:'#f0ede8'}}>{a.name}</p>
                              <p className="text-xs mt-0.5" style={{color:'#a0a098'}}>{a.why_book_ahead}</p>
                            </div>
                            <a href={a.gyg_url} target="_blank" rel="noopener noreferrer"
                               className="shrink-0 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap"
                               style={{background:'rgba(127,182,133,0.15)', color:'#7fb685', border:'1px solid rgba(127,182,133,0.3)'}}
                               onClick={() => track('affiliate_click', { partner: 'getyourguide', destination: dest?.CITY })}>
                              Book â†’
                            </a>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {activities.direct?.length > 0 && (
                    <div className="rounded-xl overflow-hidden" style={{border:'1px solid rgba(127,182,133,0.15)'}}>
                      <div className="px-4 py-2.5 flex items-center gap-2" style={{background:'rgba(255,255,255,0.04)'}}>
                        <span>ðŸ“</span>
                        <p className="text-xs font-bold uppercase tracking-widest" style={{color:'#a0a098'}}>Find on Instagram</p>
                        <span className="text-xs ml-auto" style={{color:'#7a7870'}}>restaurants & bars</span>
                      </div>
                      <div className="divide-y" style={{background:'#1a2020', borderColor:'rgba(255,255,255,0.06)'}}>
                        {activities.direct.map((a, i) => {
                          const typeIcon = {Restaurant:'ðŸ½ï¸', Museum:'ðŸ›ï¸', Attraction:'â­', Bar:'ðŸ¸', Cafe:'â˜•'}[a.type] || 'ðŸ“'
                          return <VenueCard key={i} venue={a} typeIcon={typeIcon} destCity={dest?.CITY} />
                        })}
                      </div>
                    </div>
                  )}

                  {activities.gyg?.length === 0 && activities.direct?.length === 0 && (
                    <p className="text-sm text-center py-4" style={{color:'#a0a098'}}>No specific advance bookings needed for this trip.</p>
                  )}
                </div>
              )}
            </div>
          )}

          {/* â”€â”€ LOCAL TIPS â”€â”€ */}
          {activeTab === 'local' && (
            <div className="space-y-3">
              <p className="text-xs uppercase tracking-widest mb-3" style={{color:'#7a7870'}}>Local knowledge for {dest?.CITY}</p>

              {sections.tips.slice(0, 3).map((tip, i) => (
                <div key={i} className="rounded-xl p-4 flex items-start gap-3"
                     style={{background:'#1a2020', border:'1px solid rgba(127,182,133,0.15)'}}>
                  <span className="shrink-0" style={{color:'#7fb685'}}>--</span>
                  <p className="text-sm leading-relaxed" style={{color:'#c8c4bc'}}>
                    {tip.replace(/^\d+[\.\)]\s*/, '')}
                  </p>
                </div>
              ))}

              <div className="rounded-xl p-4" style={{background:'#1a2020', border:'1px solid rgba(255,255,255,0.08)'}}>
                <div className="flex items-center gap-2 mb-3">
                  <span>ðŸ—£ï¸</span>
                  <p className="font-medium text-sm" style={{color:'#f0ede8'}}>Useful phrases</p>
                </div>
                <div className="space-y-2">
                  {[
                    { phrase: 'Hello',            key: 'hello' },
                    { phrase: 'Please',           key: 'please' },
                    { phrase: 'Thank you',        key: 'thankyou' },
                    { phrase: 'Do you speak English?', key: 'english' },
                    { phrase: 'The bill, please', key: 'bill' },
                  ].map(({ phrase }) => (
                    <div key={phrase} className="flex justify-between items-center py-1.5 border-b last:border-0"
                         style={{borderColor:'rgba(255,255,255,0.05)'}}>
                      <span className="text-xs" style={{color:'#7a7870'}}>{phrase}</span>
                      <LanguagePhrase dest={dest?.CITY} phrase={phrase} />
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Footer */}
      <div className="shrink-0 border-t px-4 py-3 space-y-2"
           style={{background:'#111614', borderColor:'rgba(255,255,255,0.08)'}}>
        <div className="flex gap-2">
          <input className="input flex-1 text-sm"
            placeholder="Request changes... e.g. more food focus, swap day 2"
            value={feedback} onChange={e => setFeedback(e.target.value)}
            onKeyDown={e => e.key==='Enter' && onTweak()} />
          <button className="btn-primary px-4" onClick={onTweak} disabled={tweaking||!feedback.trim()}>
            {tweaking ? '...' : 'â†º'}
          </button>
        </div>
        {user ? (
          <button className="btn-primary w-full text-sm" onClick={onSave} disabled={saving}>
            {saving ? '...' : saved ? 'âœ“ Saved!' : 'ðŸ’¾ Save this trip'}
          </button>
        ) : (
          <button disabled className="w-full py-2 rounded-lg text-sm"
                  style={{background:'#1a2020', color:'#7a7870', border:'1px solid rgba(255,255,255,0.08)'}}>
            ðŸ’¾ Sign in to save this trip
          </button>
        )}
      </div>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\MyTrips.jsx =====
import { useState, useEffect } from 'react'
import { getTrips, deleteTrip } from '../utils/supabase'
import ReactMarkdown from 'react-markdown'

export default function MyTrips({ onLoadTrip }) {
  const [trips,   setTrips]   = useState([])
  const [loading, setLoading] = useState(true)
  const [expanded, setExpanded] = useState(null)

  useEffect(() => {
    getTrips()
      .then(setTrips)
      .catch(() => {})
      .finally(() => setLoading(false))
  }, [])

  const handleDelete = async (id) => {
    if (!confirm('Delete this trip?')) return
    await deleteTrip(id)
    setTrips(t => t.filter(trip => trip.id !== id))
  }

  const fmt = (iso) => {
    if (!iso) return ''
    return new Date(iso).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
  }

  if (loading) return <p className="text-slate-3 text-sm italic">Loading your tripsâ€¦</p>

  if (trips.length === 0) return (
    <div className="card text-center py-8">
      <p className="text-2xl mb-2">ðŸ—ºï¸</p>
      <p className="text-slate font-medium">No saved trips yet</p>
      <p className="text-slate-3 text-sm mt-1">Build an itinerary and save it to see it here</p>
    </div>
  )

  return (
    <div className="space-y-3">
      {trips.map(trip => (
        <div key={trip.id} className="card-gold">
          <div className="flex items-start justify-between gap-3">
            <div className="flex-1">
              <div className="flex items-center gap-2">
                <span className="text-xl">{trip.emoji || 'ðŸŒ'}</span>
                <div>
                  <h3 className="font-serif text-sage-light">
                    {trip.destination}{trip.country ? `, ${trip.country}` : ''}
                  </h3>
                  <p className="text-xs text-slate-3">Saved {fmt(trip.updated_at)}</p>
                </div>
              </div>
              {trip.hotel && (
                <p className="text-xs text-slate mt-1">ðŸ¨ {trip.hotel}</p>
              )}
            </div>
            <div className="flex gap-2 shrink-0">
              <button
                className="btn-primary text-xs px-3 py-1.5"
                onClick={() => onLoadTrip(trip)}
              >
                Load â†’
              </button>
              <button
                className="btn-danger text-xs px-3 py-1.5"
                onClick={() => handleDelete(trip.id)}
              >
                âœ•
              </button>
            </div>
          </div>

          {/* Expandable itinerary preview */}
          {trip.itinerary && (
            <div className="mt-3">
              <button
                className="text-xs text-sage hover:text-sage-light transition-colors"
                onClick={() => setExpanded(expanded === trip.id ? null : trip.id)}
              >
                {expanded === trip.id ? 'â–² Hide itinerary' : 'â–¼ Preview itinerary'}
              </button>
              {expanded === trip.id && (
                <div className="mt-3 max-h-64 overflow-y-auto border-t border-white/8 pt-3
                  prose prose-invert prose-sm max-w-none
                  prose-headings:font-serif prose-headings:text-sage-light
                  prose-p:text-slate prose-li:text-slate">
                  <ReactMarkdown>{trip.itinerary}</ReactMarkdown>
                </div>
              )}
            </div>
          )}
        </div>
      ))}
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\ProfileSetup.jsx =====
import { useState } from 'react'
import { supabase } from '../utils/supabase'

const AGE_RANGES = ['18â€“24', '25â€“34', '35â€“44', '45â€“54', '55â€“64', '65+']

const DIETARY_OPTIONS = [
  { id: 'vegan',        label: 'ðŸŒ± Vegan' },
  { id: 'vegetarian',   label: 'ðŸ¥— Vegetarian' },
  { id: 'pescatarian',  label: 'ðŸŸ Pescatarian' },
  { id: 'gluten_free',  label: 'ðŸŒ¾ Gluten free' },
  { id: 'halal',        label: 'â˜ªï¸ Halal' },
  { id: 'kosher',       label: 'âœ¡ï¸ Kosher' },
  { id: 'nut_allergy',  label: 'ðŸ¥œ Nut allergy' },
  { id: 'dairy_free',   label: 'ðŸ¥› Dairy free' },
]

const ACTIVITY_LABELS = {
  1: { label: 'Very relaxed',  desc: 'Slow pace, lots of rest, minimal walking' },
  2: { label: 'Gentle',        desc: 'Light sightseeing, cafÃ© stops, easy days' },
  3: { label: 'Balanced',      desc: 'Mix of activity and downtime' },
  4: { label: 'Active',        desc: 'Plenty of walking, some physical activities' },
  5: { label: 'Very active',   desc: 'Hiking, cycling, packed days' },
}

export default function ProfileSetup({ user, onComplete }) {
  const [step,          setStep]         = useState(1)
  const [ageRange,      setAgeRange]     = useState('')
  const [activityLevel, setActivityLevel]= useState(3)
  const [dietary,       setDietary]      = useState([])
  const [dietaryOther,  setDietaryOther] = useState('')
  const [extraInfo,     setExtraInfo]    = useState('')
  const [saving,        setSaving]       = useState(false)

  const toggleDiet = (id) =>
    setDietary(d => d.includes(id) ? d.filter(x => x !== id) : [...d, id])

  const handleSave = async () => {
    setSaving(true)
    try {
      const { error } = await supabase.from('profiles').upsert({
        id:             user.id,
        age_range:      ageRange,
        activity_level: activityLevel,
        dietary:        dietary,
        dietary_other:  dietaryOther,
        extra_info:     extraInfo,
      })
      if (error) throw error
      onComplete({
        age_range:      ageRange,
        activity_level: activityLevel,
        dietary,
        dietary_other:  dietaryOther,
        extra_info:     extraInfo,
      })
    } catch (e) {
      console.error(e)
    } finally {
      setSaving(false)
    }
  }

  const TOTAL_STEPS = 4

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm px-4">
      <div className="w-full max-w-md" style={{background:'#111614', border:'1px solid rgba(127,182,133,0.3)', borderRadius:'1rem'}}>

        {/* Header */}
        <div className="px-6 pt-6 pb-4 border-b" style={{borderColor:'rgba(255,255,255,0.06)'}}>
          <h2 className="font-serif text-xl" style={{color:'#f0ede8'}}>Let's personalise Sherpa</h2>
          <p className="text-sm mt-1" style={{color:'#7a7870'}}>Just a few quick questions so we can tailor every recommendation to you.</p>
          {/* Progress */}
          <div className="flex gap-1.5 mt-4">
            {Array.from({length: TOTAL_STEPS}).map((_, i) => (
              <div key={i} className="flex-1 h-1 rounded-full transition-all"
                   style={{background: i < step ? '#7fb685' : 'rgba(255,255,255,0.1)'}}/>
            ))}
          </div>
        </div>

        <div className="px-6 py-5">

          {/* Step 1 â€” Age range */}
          {step === 1 && (
            <div>
              <p className="font-medium mb-4" style={{color:'#c8c4bc'}}>What's your age range?</p>
              <div className="grid grid-cols-3 gap-2">
                {AGE_RANGES.map(r => (
                  <button key={r} onClick={() => setAgeRange(r)}
                    className="py-2.5 rounded-lg text-sm font-medium transition-all"
                    style={{
                      background: ageRange === r ? '#7fb685' : 'rgba(255,255,255,0.05)',
                      color:      ageRange === r ? '#111614' : '#a0a098',
                      border:     ageRange === r ? 'none' : '1px solid rgba(255,255,255,0.08)',
                    }}>
                    {r}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Step 2 â€” Activity level */}
          {step === 2 && (
            <div>
              <p className="font-medium mb-1" style={{color:'#c8c4bc'}}>How active do you like your holidays?</p>
              <p className="text-xs mb-5" style={{color:'#7a7870'}}>This helps us pitch the right amount of activity each day</p>
              <div className="space-y-2">
                {[1,2,3,4,5].map(n => (
                  <button key={n} onClick={() => setActivityLevel(n)}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all"
                    style={{
                      background: activityLevel === n ? 'rgba(127,182,133,0.15)' : 'rgba(255,255,255,0.03)',
                      border:     activityLevel === n ? '1px solid rgba(127,182,133,0.4)' : '1px solid rgba(255,255,255,0.06)',
                    }}>
                    <div className="flex gap-0.5">
                      {[1,2,3,4,5].map(i => (
                        <div key={i} className="w-2 h-5 rounded-sm"
                             style={{background: i <= n ? '#7fb685' : 'rgba(255,255,255,0.1)'}}/>
                      ))}
                    </div>
                    <div>
                      <p className="text-sm font-medium" style={{color: activityLevel===n ? '#f0ede8' : '#a0a098'}}>{ACTIVITY_LABELS[n].label}</p>
                      <p className="text-xs" style={{color:'#7a7870'}}>{ACTIVITY_LABELS[n].desc}</p>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Step 3 â€” Dietary */}
          {step === 3 && (
            <div>
              <p className="font-medium mb-1" style={{color:'#c8c4bc'}}>Any dietary requirements?</p>
              <p className="text-xs mb-4" style={{color:'#7a7870'}}>Select all that apply â€” skip if none</p>
              <div className="grid grid-cols-2 gap-2 mb-4">
                {DIETARY_OPTIONS.map(o => (
                  <button key={o.id} onClick={() => toggleDiet(o.id)}
                    className="py-2.5 px-3 rounded-lg text-sm text-left transition-all"
                    style={{
                      background: dietary.includes(o.id) ? 'rgba(127,182,133,0.15)' : 'rgba(255,255,255,0.03)',
                      color:      dietary.includes(o.id) ? '#f0ede8' : '#a0a098',
                      border:     dietary.includes(o.id) ? '1px solid rgba(127,182,133,0.4)' : '1px solid rgba(255,255,255,0.06)',
                    }}>
                    {o.label}
                  </button>
                ))}
              </div>
              <input
                className="input w-full text-sm"
                placeholder="Anything else? e.g. shellfish allergy, no porkâ€¦"
                value={dietaryOther}
                onChange={e => setDietaryOther(e.target.value)}
              />
            </div>
          )}

          {/* Step 4 â€” Extra info */}
          {step === 4 && (
            <div>
              <p className="font-medium mb-1" style={{color:'#c8c4bc'}}>Anything else we should know?</p>
              <p className="text-xs mb-4" style={{color:'#7a7870'}}>
                This goes straight into every recommendation. The more detail the better â€” mobility needs, 
                travel style, things you hate, places you've already been, bucket list itemsâ€¦
              </p>
              <textarea
                className="input w-full text-sm"
                rows={5}
                placeholder="e.g. I use a walking stick so prefer flat routes. I've done Barcelona twice. I love street food markets and hate touristy restaurants. I'm a huge architecture nerdâ€¦"
                value={extraInfo}
                onChange={e => setExtraInfo(e.target.value)}
                style={{resize:'none'}}
              />
              <p className="text-xs mt-2" style={{color:'#7a7870'}}>You can update this anytime from your profile.</p>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 pb-6 flex gap-3">
          {step > 1 && (
            <button onClick={() => setStep(s => s - 1)}
              className="px-4 py-2.5 rounded-lg text-sm"
              style={{background:'rgba(255,255,255,0.05)', color:'#a0a098', border:'1px solid rgba(255,255,255,0.08)'}}>
              â† Back
            </button>
          )}
          <button
            className="flex-1 py-2.5 rounded-lg text-sm font-medium transition-all"
            style={{background:'#7fb685', color:'#111614'}}
            onClick={() => step < TOTAL_STEPS ? setStep(s => s + 1) : handleSave()}
            disabled={saving || (step === 1 && !ageRange)}
          >
            {saving ? 'Savingâ€¦' : step < TOTAL_STEPS ? 'Continue â†’' : 'âœ“ Save my profile'}
          </button>
          {step === 1 && (
            <button onClick={() => setStep(2)}
              className="px-4 py-2.5 rounded-lg text-sm"
              style={{color:'#7a7870'}}>
              Skip
            </button>
          )}
        </div>
      </div>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\SherpaSpinner.jsx =====
import { useState, useEffect } from 'react'

export default function SherpaSpinner({ messages = ['Workingâ€¦'] }) {
  const [msgIdx, setMsgIdx] = useState(0)

  useEffect(() => {
    const t = setInterval(() => setMsgIdx(i => (i + 1) % messages.length), 2500)
    return () => clearInterval(t)
  }, [messages.length])

  return (
    <div className="flex flex-col items-center py-8 gap-5">
      {/* Three pulsing dots */}
      <div className="flex items-center gap-2">
        {[0, 1, 2].map(i => (
          <div
            key={i}
            style={{
              width: 8,
              height: 8,
              borderRadius: '50%',
              background: '#7fb685',
              opacity: 0.8,
              animation: `sherpa-pulse 1.4s ease-in-out ${i * 0.2}s infinite`,
            }}
          />
        ))}
      </div>

      {/* Rotating message */}
      <p className="text-sm tracking-wide text-center" style={{ color: '#7a7870', fontStyle: 'italic' }}>
        {messages[msgIdx]}
      </p>

      <style>{`
        @keyframes sherpa-pulse {
          0%, 80%, 100% { transform: scale(0.7); opacity: 0.3; }
          40% { transform: scale(1); opacity: 1; }
        }
      `}</style>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\SupportTab.jsx =====
import { useState, useRef, useEffect } from 'react'
import ReactMarkdown from 'react-markdown'
import { api } from '../utils/api'
import SherpaSpinner from './SherpaSpinner'

function TripSummary({ prefs, chosenDest, flightDetails, carHire, selectedHotel }) {
  if (!chosenDest) return null
  const fd = flightDetails

  const fmt = (iso) => {
    if (!iso) return null
    const d = new Date(iso)
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`
  }

  const rows = [
    ['ðŸ“ Destination', `${chosenDest.EMOJI || ''} ${chosenDest.CITY}${chosenDest.COUNTRY ? ', '+chosenDest.COUNTRY : ''}`],
    ['ðŸ›« Flying from',  prefs.startingPoint],
    fd.outboundDate && ['ðŸ“… Dates', `${fmt(fd.outboundDate)} â†’ ${fmt(fd.returnDate)}`],
    fd.arrivalTime && ['â° Arrival / departure', `${fd.arrivalTime} in / ${fd.departureTime} out`],
    ['ðŸ’° Budget', prefs.budget],
    ['ðŸ‘¥ Group', `${prefs.groupType} (${prefs.numAdults} adults)`],
    carHire.confirmed && ['ðŸš— Car hire', carHire.confirmed === 'yes' ? 'Yes' : 'No'],
    selectedHotel && ['ðŸ¨ Staying at', selectedHotel],
  ].filter(Boolean)

  return (
    <div className="card-gold">
      <h3 className="font-serif text-gold-light mb-3">ðŸ“‹ Your Trip Summary</h3>
      <div className="space-y-2">
        {rows.map(([label, value]) => (
          <div key={label} className="flex gap-3 text-sm">
            <span className="text-slate-3 w-40 shrink-0">{label}</span>
            <span className="text-slate">{value}</span>
          </div>
        ))}
      </div>
    </div>
  )
}

function ChatPanel({ prefs, chosenDest, itinerary }) {
  const [messages, setMessages] = useState([
    { role: 'assistant', content: "Hi! I'm Sherpa, your travel assistant. Ask me anything about your trip â€” local tips, what to pack, currency, safety, or anything else." }
  ])
  const [input,   setInput]   = useState('')
  const [loading, setLoading] = useState(false)
  const bottomRef = useRef(null)

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  const context = [
    chosenDest && `Destination: ${chosenDest.CITY}, ${chosenDest.COUNTRY}`,
    `Budget: ${prefs.budget}`,
    `Group: ${prefs.groupType}`,
    itinerary && `Itinerary summary: ${itinerary.slice(0, 600)}`,
  ].filter(Boolean).join('. ')

  const send = async () => {
    const msg = input.trim()
    if (!msg || loading) return
    setInput('')
    const updated = [...messages, { role: 'user', content: msg }]
    setMessages(updated)
    setLoading(true)
    try {
      const history = updated.slice(1).map(m => ({ role: m.role, content: m.content }))
      const data = await api.chat({ message: msg, history: history.slice(0,-1), context })
      setMessages(m => [...m, { role: 'assistant', content: data.reply }])
    } catch (e) {
      setMessages(m => [...m, { role: 'assistant', content: 'Sorry, something went wrong. Try again.' }])
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="card flex flex-col" style={{ minHeight: 360 }}>
      <h3 className="font-serif text-gold-light mb-3">ðŸ’¬ Ask Sherpa</h3>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto space-y-3 mb-4 pr-1" style={{ maxHeight: 340 }}>
        {messages.map((m, i) => (
          <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-xs md:max-w-sm rounded-2xl px-4 py-2.5 text-sm leading-relaxed ${
              m.role === 'user'
                ? 'bg-gold/20 text-gold-light rounded-br-sm'
                : 'bg-navy-3 text-slate rounded-bl-sm'
            }`}>
              <ReactMarkdown>{m.content}</ReactMarkdown>
            </div>
          </div>
        ))}
        {loading && (
          <div className="flex justify-start">
            <div className="bg-navy-3 rounded-2xl rounded-bl-sm px-4 py-2.5">
              <span className="text-slate-3 text-sm italic">Sherpa is thinkingâ€¦</span>
            </div>
          </div>
        )}
        <div ref={bottomRef} />
      </div>

      {/* Input */}
      <div className="flex gap-2">
        <input
          className="input flex-1"
          placeholder="Ask anything about your tripâ€¦"
          value={input}
          onChange={e => setInput(e.target.value)}
          onKeyDown={e => e.key === 'Enter' && send()}
          disabled={loading}
        />
        <button className="btn-primary px-5" onClick={send} disabled={loading || !input.trim()}>
          Send
        </button>
      </div>
    </div>
  )
}

function LocalGuidePanel({ chosenDest }) {
  const [loading,  setLoading]  = useState(false)
  const [nearby,   setNearby]   = useState(null)
  const [history,  setHistory]  = useState('')
  const [error,    setError]    = useState('')
  const [locating, setLocating] = useState(false)

  const getLocation = () => {
    setLocating(true)
    setError('')
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        setLocating(false)
        setLoading(true)
        const { latitude: lat, longitude: lon } = pos.coords
        try {
          const [nearbyData, histData] = await Promise.all([
            api.nearby({ lat, lon, dest_city: chosenDest?.CITY || '' }),
            api.history({ lat, lon, dest_city: chosenDest?.CITY || '' }),
          ])
          setNearby(nearbyData.places || [])
          setHistory(histData.history || '')
        } catch {
          setError('Could not fetch local guide. Try again.')
        } finally {
          setLoading(false)
        }
      },
      () => { setLocating(false); setError('Location permission denied.') }
    )
  }

  const typeIcon = {
    Restaurant:'ðŸ½ï¸', Cafe:'â˜•', Bar:'ðŸ¸', Pub:'ðŸº',
    Attraction:'â­', Market:'ðŸ›’', Park:'ðŸŒ¿', Viewpoint:'ðŸ‘ï¸',
  }

  return (
    <div className="card">
      <h3 className="font-serif text-gold-light mb-1">ðŸ§­ Local Guide</h3>
      <p className="text-sm text-slate-3 mb-4">Use your GPS location to discover what's nearby and learn the local history.</p>

      {!nearby && !loading && (
        <button className="btn-primary w-full" onClick={getLocation} disabled={locating}>
          {locating ? 'Getting your locationâ€¦' : 'ðŸ“ Find what\'s nearby'}
        </button>
      )}

      {error && <p className="text-red-400 text-sm mt-2">{error}</p>}

      {loading && <SherpaSpinner messages={["Finding what's around youâ€¦","Checking nearby spotsâ€¦","Reading the historyâ€¦"]} />}

      {nearby !== null && !loading && (
        <div className="space-y-4">
          {history && (
            <div className="note">
              <p className="section-label mb-1">ðŸ“œ Local history</p>
              <p className="text-sm text-slate leading-relaxed">{history}</p>
            </div>
          )}

          <div>
            <p className="section-label">ðŸ“ Nearby ({nearby.length} places)</p>
            <div className="space-y-2 mt-2">
              {nearby.map((p,i) => (
                <div key={i} className="flex gap-3 items-start py-2 border-b border-white/8 last:border-0">
                  <span className="text-xl">{typeIcon[p.type] || 'ðŸ“'}</span>
                  <div>
                    <p className="text-sm font-medium text-slate">{p.name}</p>
                    <p className="text-xs text-slate-3">{p.distance} Â· {p.why}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <button className="btn-secondary text-sm w-full" onClick={getLocation}>
            ðŸ”„ Refresh location
          </button>
        </div>
      )}
    </div>
  )
}

export default function SupportTab({ prefs, chosenDest, itinerary, flightDetails, carHire, selectedHotel }) {
  return (
    <div className="space-y-6">
      <TripSummary
        prefs={prefs}
        chosenDest={chosenDest}
        flightDetails={flightDetails}
        carHire={carHire}
        selectedHotel={selectedHotel}
      />

      <ChatPanel
        prefs={prefs}
        chosenDest={chosenDest}
        itinerary={itinerary}
      />

      <LocalGuidePanel chosenDest={chosenDest} />
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\components\UsageLimitModal.jsx =====
import { useState } from 'react'

export default function UsageLimitModal({ type, onSignIn, onClose }) {
  const title = type === 'inspire'
    ? "You've used your free searches"
    : "You've used your free itinerary builds"

  const subtitle = type === 'inspire'
    ? 'Create a free account to unlock unlimited destination searches.'
    : 'Create a free account to unlock unlimited itinerary builds.'

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4"
         style={{ background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(4px)' }}
         onClick={onClose}>
      <div className="w-full max-w-md rounded-2xl overflow-hidden"
           style={{ background: '#1a2020', border: '1px solid rgba(127,182,133,0.2)' }}
           onClick={e => e.stopPropagation()}>

        {/* Header */}
        <div className="px-6 pt-6 pb-4 text-center"
             style={{ background: 'linear-gradient(to bottom, rgba(127,182,133,0.1), transparent)' }}>
          <div className="text-4xl mb-3">ðŸ”ï¸</div>
          <h2 className="font-serif text-xl" style={{ color: '#a8c9ad' }}>{title}</h2>
          <p className="text-sm mt-2" style={{ color: '#c8c4bc' }}>{subtitle}</p>
        </div>

        {/* Benefits */}
        <div className="px-6 py-4 space-y-3">
          <p className="text-xs uppercase tracking-widest font-semibold" style={{ color: '#7a7870' }}>
            Why create an account?
          </p>
          {[
            { icon: 'âœ¨', text: 'Unlimited destination searches' },
            { icon: 'ðŸ—“ï¸', text: 'Unlimited personalised itineraries' },
            { icon: 'ðŸ’¾', text: 'Save trips and revisit anytime' },
            { icon: 'ðŸŽ¯', text: 'Personalised recommendations based on your profile' },
            { icon: 'ðŸ—ºï¸', text: 'Download your itinerary to Google Maps' },
            { icon: 'ðŸ†“', text: "No payment needed" },
          ].map(({ icon, text }) => (
            <div key={text} className="flex items-center gap-3">
              <span className="text-lg shrink-0">{icon}</span>
              <p className="text-sm" style={{ color: '#c8c4bc' }}>{text}</p>
            </div>
          ))}
        </div>

        {/* Actions */}
        <div className="px-6 pb-6 pt-2 space-y-3">
          <button
            className="btn-primary w-full py-3 text-base"
            onClick={onSignIn}
          >
            Create free account â†’
          </button>
          <button
            className="w-full py-2 text-sm transition-colors"
            style={{ color: '#7a7870' }}
            onMouseEnter={e => e.target.style.color = '#a8c9ad'}
            onMouseLeave={e => e.target.style.color = '#7a7870'}
            onClick={onSignIn}
          >
            Already have an account? Sign in
          </button>
          <button
            className="w-full py-1 text-xs transition-colors"
            style={{ color: '#7a7870' }}
            onMouseEnter={e => e.target.style.color = '#a8c9ad'}
            onMouseLeave={e => e.target.style.color = '#7a7870'}
            onClick={onClose}
          >
            Maybe later
          </button>
        </div>
      </div>
    </div>
  )
}


===== C:\Users\james\travel-planner\frontend\src\hooks\useLocalStorage.js =====
import { useState, useEffect } from 'react'

export function useLocalStorage(key, initial) {
  const [value, setValue] = useState(() => {
    try {
      const item = localStorage.getItem(key)
      return item ? JSON.parse(item) : initial
    } catch {
      return initial
    }
  })

  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(value))
    } catch {}
  }, [key, value])

  return [value, setValue]
}


===== C:\Users\james\travel-planner\frontend\src\hooks\useUsageLimit.js =====
import { useState } from 'react'

const LIMITS = {
  inspire: 3,
  itinerary: 3,
}

function getCount(key) {
  try {
    return parseInt(localStorage.getItem(`sherpa_usage_${key}`) || '0', 10)
  } catch {
    return 0
  }
}

function incrementCount(key) {
  const next = getCount(key) + 1
  localStorage.setItem(`sherpa_usage_${key}`, String(next))
  return next
}

export function useUsageLimit(key) {
  const [count, setCount] = useState(() => getCount(key))
  const limit = LIMITS[key] || 0
  const remaining = Math.max(0, limit - count)
  const limitReached = count >= limit

  const increment = () => {
    const next = incrementCount(key)
    setCount(next)
  }

  return { count, limit, remaining, limitReached, increment }
}

===== C:\Users\james\travel-planner\frontend\src\utils\analytics.js =====
export function track(eventName, params = {}) {
  try {
    if (typeof window.gtag === 'function') {
      window.gtag('event', eventName, params)
    }
  } catch (e) {
    // Silently fail so analytics never breaks the app
  }
}


===== C:\Users\james\travel-planner\frontend\src\utils\api.js =====
const BASE = '/api'

async function post(path, body) {
  const res = await fetch(`${BASE}${path}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  })
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: res.statusText }))
    throw new Error(err.detail || 'Request failed')
  }
  return res.json()
}

async function get(path) {
  const res = await fetch(`${BASE}${path}`)
  if (!res.ok) throw new Error(res.statusText)
  return res.json()
}

// Streaming helper â€” calls onChunk(text) for each chunk, returns full text
async function stream(path, body, onChunk) {
  const res = await fetch(`${BASE}${path}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  })
  if (!res.ok) throw new Error(res.statusText)

  const reader = res.body.getReader()
  const decoder = new TextDecoder()
  let full = ''

  while (true) {
    const { done, value } = await reader.read()
    if (done) break
    const chunk = decoder.decode(value, { stream: true })
    for (const line of chunk.split('\n')) {
      if (!line.startsWith('data: ')) continue
      const data = line.slice(6)
      if (data === '[DONE]') return full
      try {
        const { text } = JSON.parse(data)
        full += text
        onChunk(full)
      } catch {}
    }
  }
  return full
}

export const api = {
  getUKAirports:   ()      => get('/uk-airports'),
  getConfig:       ()      => get('/config'),
  getDestAirports: (body)  => post('/dest-airports', body),
  inspire:         (body)  => post('/inspire', body),
  photo:           (query) => get(`/photo?query=${encodeURIComponent(query)}`),
  itinerary:       (body, onChunk) => stream('/itinerary', body, onChunk),
  carHire:         (body)  => post('/car-hire', body),
  accomTips:       (body)  => post('/accom-tips', body),
  hotelNote:       (body)  => post('/hotel-note', body),
  activities:      (body)  => post('/activities', body),
  tweak:           (body, onChunk) => stream('/tweak', body, onChunk),
  mapPins:         (body)  => post('/map-pins', body),
  chat:            (body)  => post('/chat', body),
  nearby:          (body)  => post('/nearby', body),
  history:         (body)  => post('/history', body),
}


===== C:\Users\james\travel-planner\frontend\src\utils\supabase.js =====
import { createClient } from '@supabase/supabase-js'

const SUPABASE_URL = 'https://csskviadplwocboidnmr.supabase.co'
const SUPABASE_ANON_KEY = 'sb_publishable_Ob9rIkJal8VkzIi3Uj6WmQ_iIwm4TgP'

export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// â”€â”€ Auth helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function signUp(email, password) {
  const { data, error } = await supabase.auth.signUp({ email, password })
  if (error) throw new Error(error.message)
  return data
}

export async function signIn(email, password) {
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) throw new Error(error.message)
  return data
}

export async function signOut() {
  const { error } = await supabase.auth.signOut()
  if (error) throw new Error(error.message)
}

export async function getUser() {
  const { data: { user } } = await supabase.auth.getUser()
  return user
}

// â”€â”€ Trip helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function saveTrip({ destination, country, emoji, itinerary, flightDetails, carHire, hotel, prefs }) {
  const user = await getUser()
  if (!user) throw new Error('Not logged in')

  const { data, error } = await supabase
    .from('trips')
    .insert({
      user_id:        user.id,
      destination,
      country,
      emoji,
      itinerary,
      flight_details: flightDetails,
      car_hire:       carHire,
      hotel,
      prefs,
    })
    .select()
    .single()

  if (error) throw new Error(error.message)
  return data
}

export async function updateTrip(id, updates) {
  const { data, error } = await supabase
    .from('trips')
    .update({ ...updates, updated_at: new Date().toISOString() })
    .eq('id', id)
    .select()
    .single()

  if (error) throw new Error(error.message)
  return data
}

export async function getTrips() {
  const { data, error } = await supabase
    .from('trips')
    .select('*')
    .order('updated_at', { ascending: false })

  if (error) throw new Error(error.message)
  return data || []
}

export async function deleteTrip(id) {
  const { error } = await supabase
    .from('trips')
    .delete()
    .eq('id', id)

  if (error) throw new Error(error.message)
}

// â”€â”€ Profile helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function getProfile(userId) {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', userId)
    .single()
  if (error) return null
  return data
}

export async function saveProfile(userId, profile) {
  const { data, error } = await supabase
    .from('profiles')
    .upsert({ id: userId, ...profile })
    .select()
    .single()
  if (error) throw new Error(error.message)
  return data
}


